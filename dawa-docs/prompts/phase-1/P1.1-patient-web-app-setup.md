# P1.1 — Patient Web App Setup

## Prompt ID: P1.1
## Phase: 1 - Patient Web App
## Estimated Time: 4-5 hours
## Prerequisites: Phase 0 complete

---

## CONTEXT

You are building the Patient Web Application for DAWA.ma — the primary interface where Moroccan patients order medications for home delivery. This is a **Next.js 14** web application with App Router.

**Design Philosophy** (from Product Excellence):
> "The product that markets itself, converts effortlessly, and delights completely."

Every screen must answer three questions:
1. Does this reduce friction or add it?
2. Does this build trust or erode it?
3. Does this guide toward value or distract from it?

**Visual Philosophy** (from Generative Artist):
> "You're not drawing shadows. You're drawing where light ISN'T."

UI elements should feel like surfaces in 3D space — buttons that lift, cards with depth, inputs that respond.

---

## APP STRUCTURE

```
apps/patient/
├── src/
│   ├── app/                    # Next.js App Router
│   │   ├── (auth)/             # Auth route group
│   │   │   ├── login/
│   │   │   ├── verify/
│   │   │   └── consent/
│   │   ├── (main)/             # Main app route group
│   │   │   ├── layout.tsx      # Main layout with nav
│   │   │   ├── page.tsx        # Home/Dashboard
│   │   │   ├── orders/
│   │   │   ├── pharmacies/
│   │   │   ├── prescriptions/
│   │   │   ├── profile/
│   │   │   └── chat/
│   │   ├── layout.tsx          # Root layout
│   │   └── not-found.tsx
│   ├── components/
│   ├── hooks/
│   ├── lib/
│   ├── stores/
│   └── styles/
├── public/
├── next.config.js
├── tailwind.config.ts
└── package.json
```

---

## IMPLEMENTATION STEPS

### Step 1: Package Configuration

Create `apps/patient/package.json`:

```json
{
  "name": "patient",
  "version": "1.0.0",
  "private": true,
  "scripts": {
    "dev": "next dev -p 3000",
    "build": "next build",
    "start": "next start",
    "lint": "eslint src --ext .ts,.tsx",
    "typecheck": "tsc --noEmit",
    "test": "vitest"
  },
  "dependencies": {
    "@dawa/types": "workspace:*",
    "@dawa/ui": "workspace:*",
    "@dawa/utils": "workspace:*",
    "@dawa/validation": "workspace:*",
    "@dawa/env": "workspace:*",
    "@supabase/supabase-js": "^2.39.0",
    "@supabase/ssr": "^0.1.0",
    "@tanstack/react-query": "^5.17.0",
    "@hookform/resolvers": "^3.3.0",
    "react-hook-form": "^7.49.0",
    "zustand": "^4.5.0",
    "framer-motion": "^10.18.0",
    "lucide-react": "^0.309.0",
    "date-fns": "^3.2.0",
    "next": "14.1.0",
    "react": "^18.2.0",
    "react-dom": "^18.2.0",
    "zod": "^3.22.0",
    "sonner": "^1.4.0"
  },
  "devDependencies": {
    "@dawa/eslint-config": "workspace:*",
    "@types/node": "^20.11.0",
    "@types/react": "^18.2.0",
    "@types/react-dom": "^18.2.0",
    "autoprefixer": "^10.4.17",
    "postcss": "^8.4.33",
    "tailwindcss": "^3.4.1",
    "typescript": "^5.3.0"
  }
}
```

### Step 2: Root Layout

Create `apps/patient/src/app/layout.tsx`:

```typescript
import type { Metadata, Viewport } from 'next';
import { Inter } from 'next/font/google';
import { Toaster } from 'sonner';
import { Providers } from '@/components/providers';
import '@/styles/globals.css';

const inter = Inter({ subsets: ['latin'], variable: '--font-inter' });

export const metadata: Metadata = {
  title: {
    default: 'DAWA.ma - Livraison de médicaments',
    template: '%s | DAWA.ma',
  },
  description: 'Commandez vos médicaments en ligne et recevez-les chez vous au Maroc.',
};

export const viewport: Viewport = {
  width: 'device-width',
  initialScale: 1,
  themeColor: '#14b8a6',
};

export default function RootLayout({ children }: { children: React.ReactNode }) {
  return (
    <html lang="fr" className={inter.variable}>
      <body className="min-h-screen bg-gray-50 font-sans antialiased">
        <Providers>
          {children}
          <Toaster position="top-center" />
        </Providers>
      </body>
    </html>
  );
}
```

### Step 3: Providers

Create `apps/patient/src/components/providers.tsx`:

```typescript
'use client';

import { useState } from 'react';
import { QueryClient, QueryClientProvider } from '@tanstack/react-query';
import { AuthProvider } from '@/hooks/useAuth';

export function Providers({ children }: { children: React.ReactNode }) {
  const [queryClient] = useState(() => new QueryClient({
    defaultOptions: {
      queries: {
        staleTime: 5 * 60 * 1000,
        gcTime: 30 * 60 * 1000,
        retry: 3,
      },
    },
  }));

  return (
    <QueryClientProvider client={queryClient}>
      <AuthProvider>{children}</AuthProvider>
    </QueryClientProvider>
  );
}
```

### Step 4: Auth Hook

Create `apps/patient/src/hooks/useAuth.tsx`:

```typescript
'use client';

import { createContext, useContext, useEffect, useState, useCallback, ReactNode } from 'react';
import { useRouter } from 'next/navigation';
import type { User, Session } from '@supabase/supabase-js';
import { getSupabaseClient } from '@/lib/supabase/client';
import type { Patient } from '@dawa/types';

interface AuthContextType {
  user: User | null;
  patient: Patient | null;
  session: Session | null;
  isLoading: boolean;
  isAuthenticated: boolean;
  signOut: () => Promise<void>;
}

const AuthContext = createContext<AuthContextType | undefined>(undefined);

export function AuthProvider({ children }: { children: ReactNode }) {
  const [user, setUser] = useState<User | null>(null);
  const [patient, setPatient] = useState<Patient | null>(null);
  const [session, setSession] = useState<Session | null>(null);
  const [isLoading, setIsLoading] = useState(true);
  const router = useRouter();
  const supabase = getSupabaseClient();

  const fetchPatient = useCallback(async (userId: string) => {
    const { data } = await supabase
      .from('patients')
      .select('*')
      .eq('user_id', userId)
      .single();
    if (data) setPatient(data as Patient);
  }, [supabase]);

  useEffect(() => {
    const init = async () => {
      const { data: { session: s } } = await supabase.auth.getSession();
      if (s?.user) {
        setSession(s);
        setUser(s.user);
        await fetchPatient(s.user.id);
      }
      setIsLoading(false);
    };
    init();

    const { data: { subscription } } = supabase.auth.onAuthStateChange(async (_, s) => {
      setSession(s);
      setUser(s?.user ?? null);
      if (s?.user) await fetchPatient(s.user.id);
      else setPatient(null);
    });

    return () => subscription.unsubscribe();
  }, [supabase, fetchPatient]);

  const signOut = useCallback(async () => {
    await supabase.auth.signOut();
    setUser(null);
    setPatient(null);
    router.push('/login');
  }, [supabase, router]);

  return (
    <AuthContext.Provider value={{ user, patient, session, isLoading, isAuthenticated: !!user, signOut }}>
      {children}
    </AuthContext.Provider>
  );
}

export const useAuth = () => {
  const ctx = useContext(AuthContext);
  if (!ctx) throw new Error('useAuth must be within AuthProvider');
  return ctx;
};
```

### Step 5: Supabase Clients

Create `apps/patient/src/lib/supabase/client.ts`:

```typescript
import { createBrowserClient } from '@supabase/ssr';
import type { Database } from '@dawa/types';

let client: ReturnType<typeof createBrowserClient<Database>> | null = null;

export function getSupabaseClient() {
  if (!client) {
    client = createBrowserClient<Database>(
      process.env.NEXT_PUBLIC_SUPABASE_URL!,
      process.env.NEXT_PUBLIC_SUPABASE_ANON_KEY!
    );
  }
  return client;
}
```

Create `apps/patient/src/lib/supabase/server.ts`:

```typescript
import { createServerClient } from '@supabase/ssr';
import { cookies } from 'next/headers';
import type { Database } from '@dawa/types';

export function createServerSupabaseClient() {
  const cookieStore = cookies();
  return createServerClient<Database>(
    process.env.NEXT_PUBLIC_SUPABASE_URL!,
    process.env.NEXT_PUBLIC_SUPABASE_ANON_KEY!,
    {
      cookies: {
        get: (name) => cookieStore.get(name)?.value,
        set: (name, value, options) => { try { cookieStore.set({ name, value, ...options }); } catch {} },
        remove: (name, options) => { try { cookieStore.set({ name, value: '', ...options }); } catch {} },
      },
    }
  );
}
```

### Step 6: Middleware

Create `apps/patient/src/middleware.ts`:

```typescript
import { createServerClient } from '@supabase/ssr';
import { NextResponse, type NextRequest } from 'next/server';

const PUBLIC_ROUTES = ['/login', '/verify', '/consent', '/api/auth'];

export async function middleware(request: NextRequest) {
  const response = NextResponse.next({ request: { headers: request.headers } });
  
  const supabase = createServerClient(
    process.env.NEXT_PUBLIC_SUPABASE_URL!,
    process.env.NEXT_PUBLIC_SUPABASE_ANON_KEY!,
    {
      cookies: {
        get: (name) => request.cookies.get(name)?.value,
        set: (name, value, options) => response.cookies.set({ name, value, ...options }),
        remove: (name, options) => response.cookies.set({ name, value: '', ...options }),
      },
    }
  );

  const { data: { session } } = await supabase.auth.getSession();
  const isPublic = PUBLIC_ROUTES.some(r => request.nextUrl.pathname.startsWith(r));

  if (session && isPublic) return NextResponse.redirect(new URL('/', request.url));
  if (!session && !isPublic && request.nextUrl.pathname !== '/') {
    return NextResponse.redirect(new URL('/login', request.url));
  }

  return response;
}

export const config = {
  matcher: ['/((?!_next/static|_next/image|favicon.ico|images|icons).*)'],
};
```

### Step 7: Global Styles

Create `apps/patient/src/styles/globals.css`:

```css
@tailwind base;
@tailwind components;
@tailwind utilities;

@layer base {
  html { scroll-behavior: smooth; }
  :focus-visible { @apply outline-none ring-2 ring-primary-500 ring-offset-2; }
  body { @apply text-gray-900; text-rendering: optimizeLegibility; }
}

@layer components {
  .page-container { @apply mx-auto max-w-7xl px-4 sm:px-6 lg:px-8; }
  .card-elevated { @apply rounded-2xl bg-white shadow-soft border border-gray-100 transition-all hover:shadow-soft-md hover:-translate-y-0.5; }
  .text-gradient { @apply bg-gradient-to-r from-primary-600 to-primary-400 bg-clip-text text-transparent; }
}
```

---

## SUCCESS CRITERIA

- [ ] Next.js app starts on port 3000
- [ ] Tailwind styles compile correctly
- [ ] Auth provider initializes
- [ ] Middleware redirects work
- [ ] Supabase clients created

---

## NEXT STEP

After validation passes, proceed to:
→ `dawa-docs/prompts/phase-1/P1.2-patient-web-auth-screens.md`

Reference documentation:
→ `dawa-docs/docs/DAWA_MASTER.md`
→ `dawa-docs/docs/phases/PHASE_1.md`
