# P1.10 — Profile Settings (V100)

## Prompt ID: P1.10
## Phase: 1 - Patient Web App
## Estimated Time: 6-8 hours
## Prerequisites: P1.9 complete

---

## STRATEGIC CONTEXT

### What Profile Settings Must Handle

```
┌─────────────────────────────────────────────────────────────────────────────┐
│                    PROFILE SETTINGS SCOPE                                    │
├─────────────────────────────────────────────────────────────────────────────┤
│                                                                              │
│  1. PERSONAL INFORMATION                                                    │
│     - Full name (displayed to pharmacies and couriers)                     │
│     - Phone number (primary contact, authenticated)                        │
│     - Email (optional, for receipts)                                       │
│     - Date of birth (for age verification on certain medications)          │
│     - Gender (optional, for medication appropriateness)                    │
│                                                                              │
│  2. DELIVERY ADDRESSES                                                      │
│     - Multiple addresses (home, work, family)                              │
│     - Pin-based location (Morocco address challenge)                       │
│     - Landmark descriptions                                                 │
│     - Entrance photos                                                       │
│     - Delivery instructions                                                 │
│     - Default address selection                                            │
│                                                                              │
│  3. PAYMENT METHODS                                                        │
│     - Cash on delivery (default, most common in Morocco)                   │
│     - Credit/debit cards (CMI, Visa, Mastercard)                          │
│     - Mobile money (future: Orange Money, Inwi Money)                     │
│     - Default payment selection                                            │
│                                                                              │
│  4. NOTIFICATION PREFERENCES                                               │
│     - Push notifications (order updates, promotions)                       │
│     - SMS notifications (critical updates, fallback)                       │
│     - Email notifications (receipts, account security)                    │
│     - Quiet hours                                                          │
│                                                                              │
│  5. SECURITY                                                               │
│     - Change phone number (re-authentication required)                    │
│     - Active sessions (view and terminate)                                 │
│     - Delete account                                                       │
│                                                                              │
│  6. PREFERENCES                                                            │
│     - Language (French, Arabic, English)                                   │
│     - Favorite pharmacies                                                  │
│     - Order history retention                                              │
│                                                                              │
└─────────────────────────────────────────────────────────────────────────────┘
```

### Morocco Address Challenge (Deep Dive)

```
┌─────────────────────────────────────────────────────────────────────────────┐
│                    THE MOROCCO ADDRESS PROBLEM                               │
├─────────────────────────────────────────────────────────────────────────────┤
│                                                                              │
│  REALITY CHECK:                                                             │
│  In Morocco, especially in medinas and informal settlements:                │
│  - Street names may not exist or be used                                   │
│  - House numbers are often absent or not sequential                        │
│  - Multiple addresses may share the same description                       │
│  - GPS coordinates have ±50m error in dense areas                          │
│  - Delivery relies on local knowledge and phone calls                      │
│                                                                              │
│  OUR SOLUTION: "SMART LOCATION CAPTURE"                                    │
│  ─────────────────────────────────────────────────────────────────────────   │
│                                                                              │
│  Step 1: MAP PIN                                                           │
│  - User drops pin on interactive map                                       │
│  - We store exact coordinates                                              │
│  - Show satellite view for accuracy                                        │
│                                                                              │
│  Step 2: LANDMARK DESCRIPTION                                              │
│  - Required free-text field                                                │
│  - Examples: "En face du café Atlas", "Porte bleue"                       │
│  - Max 200 characters                                                      │
│                                                                              │
│  Step 3: ENTRANCE PHOTO                                                    │
│  - Optional but encouraged (10% discount first time?)                     │
│  - Photo of building entrance or gate                                      │
│  - Helps courier identify exact location                                   │
│                                                                              │
│  Step 4: DELIVERY INSTRUCTIONS                                             │
│  - Optional notes                                                          │
│  - Examples: "Appeler 5 min avant", "Code porte: 1234"                   │
│                                                                              │
│  Step 5: TEXT ADDRESS                                                      │
│  - Optional traditional address                                            │
│  - For formal receipts and documentation                                   │
│                                                                              │
│  WHAT THE COURIER SEES:                                                    │
│  ┌─────────────────────────────────────────────────────────────────────┐   │
│  │ [MAP WITH PIN] [PHOTO]                                              │   │
│  │                                                                      │   │
│  │ Repère: "Porte bleue à côté du café Atlas"                         │   │
│  │ Notes: "Appeler en arrivant, 3ème étage"                           │   │
│  │                                                                      │   │
│  │ [APPELER] [NAVIGUER]                                                │   │
│  └─────────────────────────────────────────────────────────────────────┘   │
│                                                                              │
└─────────────────────────────────────────────────────────────────────────────┘
```

---

## DATA MODEL

```sql
-- ============================================================
-- PROFILE & ADDRESSES SCHEMA
-- ============================================================

-- Patient addresses
CREATE TABLE patient_addresses (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  patient_id UUID NOT NULL REFERENCES patients(id) ON DELETE CASCADE,
  
  -- Address type
  label TEXT NOT NULL, -- "Maison", "Travail", "Famille", custom
  
  -- Location (primary)
  latitude DECIMAL(10, 8) NOT NULL,
  longitude DECIMAL(11, 8) NOT NULL,
  location GEOGRAPHY(POINT, 4326) GENERATED ALWAYS AS (
    ST_SetSRID(ST_MakePoint(longitude, latitude), 4326)::geography
  ) STORED,
  
  -- Landmark (required for Morocco)
  landmark TEXT NOT NULL,
  entrance_photo_url TEXT,
  delivery_instructions TEXT,
  
  -- Traditional address (optional)
  address_line_1 TEXT,
  address_line_2 TEXT,
  city TEXT,
  postal_code TEXT,
  
  -- Metadata
  is_default BOOLEAN DEFAULT false,
  
  created_at TIMESTAMPTZ DEFAULT NOW(),
  updated_at TIMESTAMPTZ DEFAULT NOW()
);

CREATE INDEX idx_patient_addresses_patient ON patient_addresses(patient_id);

-- Ensure only one default address per patient
CREATE UNIQUE INDEX idx_patient_addresses_default 
  ON patient_addresses(patient_id) 
  WHERE is_default = true;

-- Patient payment methods
CREATE TABLE patient_payment_methods (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  patient_id UUID NOT NULL REFERENCES patients(id) ON DELETE CASCADE,
  
  -- Payment type
  type TEXT NOT NULL, -- 'CASH', 'CARD', 'MOBILE_MONEY'
  
  -- Card details (encrypted at rest by Supabase)
  card_last_four TEXT,
  card_brand TEXT, -- 'VISA', 'MASTERCARD', 'CMI'
  card_expiry_month INTEGER,
  card_expiry_year INTEGER,
  card_holder_name TEXT,
  
  -- Tokenized card (from payment gateway)
  payment_token TEXT, -- CMI token for recurring charges
  
  -- Mobile money
  mobile_money_provider TEXT,
  mobile_money_number TEXT,
  
  -- Metadata
  is_default BOOLEAN DEFAULT false,
  is_verified BOOLEAN DEFAULT false,
  
  created_at TIMESTAMPTZ DEFAULT NOW(),
  updated_at TIMESTAMPTZ DEFAULT NOW()
);

CREATE INDEX idx_patient_payment_methods_patient ON patient_payment_methods(patient_id);

-- Notification preferences
CREATE TABLE patient_notification_preferences (
  patient_id UUID PRIMARY KEY REFERENCES patients(id) ON DELETE CASCADE,
  
  -- Push notifications
  push_enabled BOOLEAN DEFAULT true,
  push_order_updates BOOLEAN DEFAULT true,
  push_promotions BOOLEAN DEFAULT false,
  push_reminders BOOLEAN DEFAULT true,
  
  -- SMS
  sms_enabled BOOLEAN DEFAULT true,
  sms_order_updates BOOLEAN DEFAULT true,
  sms_critical_only BOOLEAN DEFAULT false,
  
  -- Email
  email_enabled BOOLEAN DEFAULT true,
  email_receipts BOOLEAN DEFAULT true,
  email_marketing BOOLEAN DEFAULT false,
  
  -- Quiet hours (Morocco timezone)
  quiet_hours_enabled BOOLEAN DEFAULT false,
  quiet_hours_start TIME DEFAULT '22:00',
  quiet_hours_end TIME DEFAULT '08:00',
  
  updated_at TIMESTAMPTZ DEFAULT NOW()
);

-- User sessions for security
CREATE TABLE user_sessions (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  user_id UUID NOT NULL REFERENCES users(id) ON DELETE CASCADE,
  
  -- Session info
  device_name TEXT,
  device_type TEXT, -- 'mobile', 'desktop', 'tablet'
  browser TEXT,
  os TEXT,
  ip_address INET,
  
  -- Location (approximate)
  city TEXT,
  country TEXT,
  
  -- Status
  is_current BOOLEAN DEFAULT false,
  last_active_at TIMESTAMPTZ DEFAULT NOW(),
  
  created_at TIMESTAMPTZ DEFAULT NOW()
);

CREATE INDEX idx_user_sessions_user ON user_sessions(user_id, last_active_at DESC);
```

---

## IMPLEMENTATION

### Step 1: Profile Page Structure

Create `apps/patient/src/app/(main)/profile/page.tsx`:

```typescript
'use client';

// ============================================================
// Profile Settings Page
// 
// Organized into sections:
// - Personal Info
// - Addresses
// - Payment Methods
// - Notifications
// - Security
// ============================================================

import { useState } from 'react';
import { motion } from 'framer-motion';
import {
  User,
  MapPin,
  CreditCard,
  Bell,
  Shield,
  ChevronRight,
  LogOut,
} from 'lucide-react';

import { useAuth } from '@/hooks/useAuth';
import { PersonalInfoSection } from '@/components/features/profile/personal-info-section';
import { AddressesSection } from '@/components/features/profile/addresses-section';
import { PaymentMethodsSection } from '@/components/features/profile/payment-methods-section';
import { NotificationsSection } from '@/components/features/profile/notifications-section';
import { SecuritySection } from '@/components/features/profile/security-section';

type Section = 'personal' | 'addresses' | 'payment' | 'notifications' | 'security' | null;

const SECTIONS = [
  { id: 'personal', label: 'Informations personnelles', icon: User, description: 'Nom, téléphone, email' },
  { id: 'addresses', label: 'Adresses de livraison', icon: MapPin, description: 'Gérer vos adresses' },
  { id: 'payment', label: 'Moyens de paiement', icon: CreditCard, description: 'Cartes et paiement' },
  { id: 'notifications', label: 'Notifications', icon: Bell, description: 'Préférences d\'alertes' },
  { id: 'security', label: 'Sécurité', icon: Shield, description: 'Mot de passe et sessions' },
] as const;

export default function ProfilePage() {
  const { patient, signOut } = useAuth();
  const [activeSection, setActiveSection] = useState<Section>(null);

  if (!patient) {
    return null; // Will be handled by auth middleware
  }

  // Render active section
  const renderSection = () => {
    switch (activeSection) {
      case 'personal':
        return <PersonalInfoSection onBack={() => setActiveSection(null)} />;
      case 'addresses':
        return <AddressesSection onBack={() => setActiveSection(null)} />;
      case 'payment':
        return <PaymentMethodsSection onBack={() => setActiveSection(null)} />;
      case 'notifications':
        return <NotificationsSection onBack={() => setActiveSection(null)} />;
      case 'security':
        return <SecuritySection onBack={() => setActiveSection(null)} />;
      default:
        return null;
    }
  };

  // Main menu view
  if (activeSection) {
    return (
      <div className="page-container py-6">
        {renderSection()}
      </div>
    );
  }

  return (
    <div className="page-container py-6 space-y-6">
      {/* Profile header */}
      <div className="flex items-center gap-4">
        <div className="h-16 w-16 rounded-full bg-gradient-to-br from-primary-400 to-primary-600 flex items-center justify-center">
          <span className="text-2xl font-bold text-white">
            {patient.full_name?.[0]?.toUpperCase() || 'U'}
          </span>
        </div>
        <div>
          <h1 className="text-xl font-bold text-gray-900">{patient.full_name}</h1>
          <p className="text-gray-500">{patient.phone}</p>
        </div>
      </div>

      {/* Sections list */}
      <div className="space-y-2">
        {SECTIONS.map((section) => {
          const Icon = section.icon;
          return (
            <motion.button
              key={section.id}
              onClick={() => setActiveSection(section.id)}
              whileTap={{ scale: 0.98 }}
              className="w-full flex items-center gap-4 rounded-xl bg-white p-4 shadow-soft border border-gray-100 hover:bg-gray-50 transition-colors"
            >
              <div className="flex h-10 w-10 items-center justify-center rounded-full bg-gray-100">
                <Icon className="h-5 w-5 text-gray-600" />
              </div>
              <div className="flex-1 text-left">
                <p className="font-medium text-gray-900">{section.label}</p>
                <p className="text-sm text-gray-500">{section.description}</p>
              </div>
              <ChevronRight className="h-5 w-5 text-gray-400" />
            </motion.button>
          );
        })}
      </div>

      {/* Sign out button */}
      <button
        onClick={signOut}
        className="w-full flex items-center justify-center gap-2 rounded-xl border border-red-200 bg-red-50 p-4 text-red-600 font-medium hover:bg-red-100 transition-colors"
      >
        <LogOut className="h-5 w-5" />
        Se déconnecter
      </button>

      {/* App version */}
      <p className="text-center text-xs text-gray-400">
        DAWA v1.0.0 • © 2024
      </p>
    </div>
  );
}
```

### Step 2: Address Management

Create `apps/patient/src/components/features/profile/addresses-section.tsx`:

```typescript
'use client';

// ============================================================
// Addresses Section
// 
// Features:
// - List saved addresses
// - Add new address with map picker
// - Edit existing addresses
// - Set default address
// - Delete addresses
// ============================================================

import { useState, useCallback } from 'react';
import { motion, AnimatePresence } from 'framer-motion';
import {
  ArrowLeft,
  Plus,
  MapPin,
  Home,
  Briefcase,
  Users,
  Star,
  MoreVertical,
  Edit2,
  Trash2,
  Check,
} from 'lucide-react';
import { toast } from 'sonner';

import { usePatientAddresses } from '@/hooks/usePatientAddresses';
import { AddressForm } from './address-form';
import type { PatientAddress } from '@dawa/types';

interface AddressesSectionProps {
  onBack: () => void;
}

const LABEL_ICONS: Record<string, typeof Home> = {
  'Maison': Home,
  'Travail': Briefcase,
  'Famille': Users,
};

export function AddressesSection({ onBack }: AddressesSectionProps) {
  const { addresses, isLoading, setDefaultAddress, deleteAddress } = usePatientAddresses();
  const [editingAddress, setEditingAddress] = useState<PatientAddress | null>(null);
  const [isAddingNew, setIsAddingNew] = useState(false);
  const [menuOpenId, setMenuOpenId] = useState<string | null>(null);

  const handleSetDefault = async (addressId: string) => {
    try {
      await setDefaultAddress(addressId);
      toast.success('Adresse par défaut mise à jour');
    } catch (error) {
      toast.error('Erreur lors de la mise à jour');
    }
    setMenuOpenId(null);
  };

  const handleDelete = async (addressId: string) => {
    if (!confirm('Supprimer cette adresse ?')) return;
    
    try {
      await deleteAddress(addressId);
      toast.success('Adresse supprimée');
    } catch (error) {
      toast.error('Erreur lors de la suppression');
    }
    setMenuOpenId(null);
  };

  // Show form if adding or editing
  if (isAddingNew || editingAddress) {
    return (
      <AddressForm
        address={editingAddress}
        onSave={() => {
          setIsAddingNew(false);
          setEditingAddress(null);
        }}
        onCancel={() => {
          setIsAddingNew(false);
          setEditingAddress(null);
        }}
      />
    );
  }

  return (
    <div className="space-y-6">
      {/* Header */}
      <div className="flex items-center gap-4">
        <button
          onClick={onBack}
          className="p-2 -ml-2 rounded-lg hover:bg-gray-100"
        >
          <ArrowLeft className="h-5 w-5" />
        </button>
        <h1 className="text-xl font-bold text-gray-900">Adresses de livraison</h1>
      </div>

      {/* Address list */}
      {isLoading ? (
        <div className="space-y-3">
          {[...Array(2)].map((_, i) => (
            <div key={i} className="rounded-xl bg-gray-100 h-24 animate-pulse" />
          ))}
        </div>
      ) : addresses.length === 0 ? (
        <div className="rounded-xl border-2 border-dashed border-gray-200 p-8 text-center">
          <MapPin className="mx-auto h-10 w-10 text-gray-400 mb-3" />
          <p className="text-gray-600 font-medium mb-1">Aucune adresse enregistrée</p>
          <p className="text-sm text-gray-500 mb-4">
            Ajoutez une adresse pour commander plus rapidement
          </p>
          <button
            onClick={() => setIsAddingNew(true)}
            className="rounded-xl bg-primary-500 px-6 py-2.5 text-white font-medium hover:bg-primary-600"
          >
            Ajouter une adresse
          </button>
        </div>
      ) : (
        <div className="space-y-3">
          {addresses.map((address) => {
            const Icon = LABEL_ICONS[address.label] || MapPin;
            return (
              <motion.div
                key={address.id}
                layout
                className="relative rounded-xl bg-white border border-gray-100 shadow-soft p-4"
              >
                <div className="flex gap-4">
                  {/* Icon */}
                  <div className={`
                    flex h-10 w-10 shrink-0 items-center justify-center rounded-full
                    ${address.is_default ? 'bg-primary-100' : 'bg-gray-100'}
                  `}>
                    <Icon className={`h-5 w-5 ${address.is_default ? 'text-primary-600' : 'text-gray-600'}`} />
                  </div>

                  {/* Content */}
                  <div className="flex-1 min-w-0">
                    <div className="flex items-center gap-2">
                      <h3 className="font-medium text-gray-900">{address.label}</h3>
                      {address.is_default && (
                        <span className="flex items-center gap-1 rounded-full bg-primary-100 px-2 py-0.5 text-xs font-medium text-primary-700">
                          <Star className="h-3 w-3" />
                          Par défaut
                        </span>
                      )}
                    </div>
                    <p className="text-sm text-gray-600 mt-1 line-clamp-2">
                      {address.landmark}
                    </p>
                    {address.address_line_1 && (
                      <p className="text-xs text-gray-400 mt-1">
                        {address.address_line_1}, {address.city}
                      </p>
                    )}
                  </div>

                  {/* Actions menu */}
                  <div className="relative">
                    <button
                      onClick={() => setMenuOpenId(menuOpenId === address.id ? null : address.id)}
                      className="p-2 rounded-lg hover:bg-gray-100"
                    >
                      <MoreVertical className="h-5 w-5 text-gray-400" />
                    </button>

                    <AnimatePresence>
                      {menuOpenId === address.id && (
                        <motion.div
                          initial={{ opacity: 0, scale: 0.95 }}
                          animate={{ opacity: 1, scale: 1 }}
                          exit={{ opacity: 0, scale: 0.95 }}
                          className="absolute right-0 top-full mt-1 w-48 rounded-xl bg-white shadow-lg border border-gray-100 py-1 z-10"
                        >
                          {!address.is_default && (
                            <button
                              onClick={() => handleSetDefault(address.id)}
                              className="w-full flex items-center gap-2 px-4 py-2 text-sm text-gray-700 hover:bg-gray-50"
                            >
                              <Check className="h-4 w-4" />
                              Définir par défaut
                            </button>
                          )}
                          <button
                            onClick={() => {
                              setEditingAddress(address);
                              setMenuOpenId(null);
                            }}
                            className="w-full flex items-center gap-2 px-4 py-2 text-sm text-gray-700 hover:bg-gray-50"
                          >
                            <Edit2 className="h-4 w-4" />
                            Modifier
                          </button>
                          <button
                            onClick={() => handleDelete(address.id)}
                            className="w-full flex items-center gap-2 px-4 py-2 text-sm text-red-600 hover:bg-red-50"
                          >
                            <Trash2 className="h-4 w-4" />
                            Supprimer
                          </button>
                        </motion.div>
                      )}
                    </AnimatePresence>
                  </div>
                </div>

                {/* Entrance photo thumbnail */}
                {address.entrance_photo_url && (
                  <div className="mt-3 pt-3 border-t border-gray-100">
                    <div className="flex items-center gap-2">
                      <img
                        src={address.entrance_photo_url}
                        alt="Photo de l'entrée"
                        className="h-12 w-16 rounded-lg object-cover"
                      />
                      <span className="text-xs text-gray-500">Photo de l'entrée</span>
                    </div>
                  </div>
                )}
              </motion.div>
            );
          })}
        </div>
      )}

      {/* Add button (when addresses exist) */}
      {addresses.length > 0 && (
        <button
          onClick={() => setIsAddingNew(true)}
          className="w-full flex items-center justify-center gap-2 rounded-xl border-2 border-dashed border-gray-300 py-4 text-gray-600 font-medium hover:border-primary-500 hover:text-primary-600 transition-colors"
        >
          <Plus className="h-5 w-5" />
          Ajouter une adresse
        </button>
      )}
    </div>
  );
}
```

### Step 3: Address Form with Map Picker

Create `apps/patient/src/components/features/profile/address-form.tsx`:

```typescript
'use client';

// ============================================================
// Address Form
// 
// Smart location capture for Morocco:
// 1. Map pin (required)
// 2. Landmark description (required)
// 3. Entrance photo (optional)
// 4. Traditional address (optional)
// ============================================================

import { useState, useCallback, useRef } from 'react';
import { useForm } from 'react-hook-form';
import { motion } from 'framer-motion';
import {
  ArrowLeft,
  MapPin,
  Camera,
  X,
  Check,
  Loader2,
  Home,
  Briefcase,
  Users,
  Tag,
} from 'lucide-react';
import { toast } from 'sonner';

import { useGeolocation } from '@/hooks/useGeolocation';
import { usePatientAddresses } from '@/hooks/usePatientAddresses';
import { LocationPicker } from '@/components/ui/location-picker';
import type { PatientAddress } from '@dawa/types';

interface AddressFormProps {
  address?: PatientAddress | null;
  onSave: () => void;
  onCancel: () => void;
}

interface FormData {
  label: string;
  customLabel: string;
  latitude: number;
  longitude: number;
  landmark: string;
  deliveryInstructions: string;
  addressLine1: string;
  city: string;
}

const PRESET_LABELS = [
  { id: 'Maison', icon: Home, label: 'Maison' },
  { id: 'Travail', icon: Briefcase, label: 'Travail' },
  { id: 'Famille', icon: Users, label: 'Famille' },
  { id: 'custom', icon: Tag, label: 'Autre' },
];

export function AddressForm({ address, onSave, onCancel }: AddressFormProps) {
  const { location } = useGeolocation();
  const { createAddress, updateAddress } = usePatientAddresses();
  const photoInputRef = useRef<HTMLInputElement>(null);

  const [isSubmitting, setIsSubmitting] = useState(false);
  const [selectedLabel, setSelectedLabel] = useState(
    address?.label && PRESET_LABELS.some(p => p.id === address.label)
      ? address.label
      : address?.label ? 'custom' : 'Maison'
  );
  const [entrancePhoto, setEntrancePhoto] = useState<File | null>(null);
  const [entrancePhotoPreview, setEntrancePhotoPreview] = useState<string | null>(
    address?.entrance_photo_url || null
  );
  const [mapLocation, setMapLocation] = useState<{ lat: number; lng: number } | null>(
    address ? { lat: address.latitude, lng: address.longitude } : null
  );

  const {
    register,
    handleSubmit,
    watch,
    setValue,
    formState: { errors },
  } = useForm<FormData>({
    defaultValues: {
      label: selectedLabel === 'custom' ? 'custom' : selectedLabel,
      customLabel: selectedLabel === 'custom' ? address?.label || '' : '',
      latitude: address?.latitude || location?.lat || 0,
      longitude: address?.longitude || location?.lng || 0,
      landmark: address?.landmark || '',
      deliveryInstructions: address?.delivery_instructions || '',
      addressLine1: address?.address_line_1 || '',
      city: address?.city || '',
    },
  });

  // Handle photo selection
  const handlePhotoSelect = useCallback((e: React.ChangeEvent<HTMLInputElement>) => {
    const file = e.target.files?.[0];
    if (!file) return;

    if (file.size > 5 * 1024 * 1024) {
      toast.error('Photo trop volumineuse (max 5 Mo)');
      return;
    }

    setEntrancePhoto(file);
    setEntrancePhotoPreview(URL.createObjectURL(file));
  }, []);

  const removePhoto = useCallback(() => {
    setEntrancePhoto(null);
    if (entrancePhotoPreview && !address?.entrance_photo_url) {
      URL.revokeObjectURL(entrancePhotoPreview);
    }
    setEntrancePhotoPreview(null);
  }, [entrancePhotoPreview, address?.entrance_photo_url]);

  // Handle location select from map
  const handleLocationSelect = useCallback((lat: number, lng: number) => {
    setMapLocation({ lat, lng });
    setValue('latitude', lat);
    setValue('longitude', lng);
  }, [setValue]);

  // Submit form
  const onSubmit = async (data: FormData) => {
    if (!mapLocation) {
      toast.error('Veuillez sélectionner un emplacement sur la carte');
      return;
    }

    setIsSubmitting(true);

    try {
      const finalLabel = selectedLabel === 'custom' ? data.customLabel : selectedLabel;

      const addressData = {
        label: finalLabel,
        latitude: mapLocation.lat,
        longitude: mapLocation.lng,
        landmark: data.landmark,
        delivery_instructions: data.deliveryInstructions || null,
        address_line_1: data.addressLine1 || null,
        city: data.city || null,
      };

      if (address) {
        await updateAddress(address.id, addressData, entrancePhoto || undefined);
        toast.success('Adresse mise à jour');
      } else {
        await createAddress(addressData, entrancePhoto || undefined);
        toast.success('Adresse ajoutée');
      }

      onSave();
    } catch (error) {
      toast.error((error as Error).message);
    } finally {
      setIsSubmitting(false);
    }
  };

  return (
    <form onSubmit={handleSubmit(onSubmit)} className="space-y-6">
      {/* Header */}
      <div className="flex items-center gap-4">
        <button
          type="button"
          onClick={onCancel}
          className="p-2 -ml-2 rounded-lg hover:bg-gray-100"
        >
          <ArrowLeft className="h-5 w-5" />
        </button>
        <h1 className="text-xl font-bold text-gray-900">
          {address ? 'Modifier l\'adresse' : 'Nouvelle adresse'}
        </h1>
      </div>

      {/* Label selection */}
      <div className="space-y-3">
        <label className="text-sm font-medium text-gray-700">Type d'adresse</label>
        <div className="grid grid-cols-4 gap-2">
          {PRESET_LABELS.map((preset) => {
            const Icon = preset.icon;
            const isSelected = selectedLabel === preset.id;
            return (
              <button
                key={preset.id}
                type="button"
                onClick={() => setSelectedLabel(preset.id)}
                className={`
                  flex flex-col items-center gap-1.5 rounded-xl border-2 p-3 transition-colors
                  ${isSelected
                    ? 'border-primary-500 bg-primary-50'
                    : 'border-gray-200 hover:border-gray-300'
                  }
                `}
              >
                <Icon className={`h-5 w-5 ${isSelected ? 'text-primary-600' : 'text-gray-500'}`} />
                <span className={`text-xs font-medium ${isSelected ? 'text-primary-600' : 'text-gray-600'}`}>
                  {preset.label}
                </span>
              </button>
            );
          })}
        </div>

        {/* Custom label input */}
        {selectedLabel === 'custom' && (
          <input
            {...register('customLabel', { required: selectedLabel === 'custom' })}
            placeholder="Nom de l'adresse"
            className="w-full rounded-xl border border-gray-200 px-4 py-3 focus:border-primary-500 focus:outline-none focus:ring-2 focus:ring-primary-500/20"
          />
        )}
      </div>

      {/* Map picker */}
      <div className="space-y-3">
        <label className="text-sm font-medium text-gray-700">
          Emplacement <span className="text-red-500">*</span>
        </label>
        <LocationPicker
          initialLocation={mapLocation || (location ? { lat: location.lat, lng: location.lng } : undefined)}
          onLocationSelect={handleLocationSelect}
        />
        {!mapLocation && (
          <p className="text-sm text-red-500">Veuillez placer un repère sur la carte</p>
        )}
      </div>

      {/* Landmark (required) */}
      <div className="space-y-2">
        <label className="text-sm font-medium text-gray-700">
          Repère / Description <span className="text-red-500">*</span>
        </label>
        <textarea
          {...register('landmark', { 
            required: 'Ce champ est requis',
            maxLength: { value: 200, message: 'Maximum 200 caractères' },
          })}
          placeholder="Ex: Porte bleue à côté du café Atlas, 2ème étage"
          rows={3}
          className="w-full rounded-xl border border-gray-200 px-4 py-3 resize-none focus:border-primary-500 focus:outline-none focus:ring-2 focus:ring-primary-500/20"
        />
        {errors.landmark && (
          <p className="text-sm text-red-500">{errors.landmark.message}</p>
        )}
        <p className="text-xs text-gray-500">
          Ce texte aidera le livreur à trouver votre adresse
        </p>
      </div>

      {/* Entrance photo (optional) */}
      <div className="space-y-2">
        <label className="text-sm font-medium text-gray-700">
          Photo de l'entrée (optionnel)
        </label>
        
        <input
          ref={photoInputRef}
          type="file"
          accept="image/*"
          capture="environment"
          onChange={handlePhotoSelect}
          className="hidden"
        />

        {entrancePhotoPreview ? (
          <div className="relative">
            <img
              src={entrancePhotoPreview}
              alt="Photo de l'entrée"
              className="w-full h-40 rounded-xl object-cover"
            />
            <button
              type="button"
              onClick={removePhoto}
              className="absolute top-2 right-2 p-1.5 rounded-full bg-black/50 text-white hover:bg-black/70"
            >
              <X className="h-4 w-4" />
            </button>
          </div>
        ) : (
          <button
            type="button"
            onClick={() => photoInputRef.current?.click()}
            className="w-full flex items-center justify-center gap-2 rounded-xl border-2 border-dashed border-gray-300 py-8 text-gray-600 hover:border-primary-500 hover:text-primary-600 transition-colors"
          >
            <Camera className="h-5 w-5" />
            <span>Ajouter une photo</span>
          </button>
        )}
        <p className="text-xs text-gray-500">
          Une photo de l'entrée aide le livreur à identifier votre adresse
        </p>
      </div>

      {/* Delivery instructions (optional) */}
      <div className="space-y-2">
        <label className="text-sm font-medium text-gray-700">
          Instructions de livraison (optionnel)
        </label>
        <input
          {...register('deliveryInstructions')}
          placeholder="Ex: Appeler en arrivant, code porte: 1234"
          className="w-full rounded-xl border border-gray-200 px-4 py-3 focus:border-primary-500 focus:outline-none focus:ring-2 focus:ring-primary-500/20"
        />
      </div>

      {/* Traditional address (optional, collapsed) */}
      <details className="rounded-xl border border-gray-200 overflow-hidden">
        <summary className="px-4 py-3 cursor-pointer text-sm font-medium text-gray-700 hover:bg-gray-50">
          Adresse postale (optionnel)
        </summary>
        <div className="p-4 pt-0 space-y-3">
          <input
            {...register('addressLine1')}
            placeholder="Rue, numéro, quartier"
            className="w-full rounded-xl border border-gray-200 px-4 py-3 focus:border-primary-500 focus:outline-none focus:ring-2 focus:ring-primary-500/20"
          />
          <input
            {...register('city')}
            placeholder="Ville"
            className="w-full rounded-xl border border-gray-200 px-4 py-3 focus:border-primary-500 focus:outline-none focus:ring-2 focus:ring-primary-500/20"
          />
        </div>
      </details>

      {/* Submit buttons */}
      <div className="flex gap-3 pt-4">
        <button
          type="button"
          onClick={onCancel}
          disabled={isSubmitting}
          className="flex-1 rounded-xl border border-gray-200 py-3 font-medium text-gray-700 hover:bg-gray-50 disabled:opacity-50"
        >
          Annuler
        </button>
        <button
          type="submit"
          disabled={isSubmitting || !mapLocation}
          className="flex-1 flex items-center justify-center gap-2 rounded-xl bg-primary-500 py-3 font-medium text-white hover:bg-primary-600 disabled:opacity-50 disabled:cursor-not-allowed"
        >
          {isSubmitting ? (
            <>
              <Loader2 className="h-5 w-5 animate-spin" />
              Enregistrement...
            </>
          ) : (
            <>
              <Check className="h-5 w-5" />
              Enregistrer
            </>
          )}
        </button>
      </div>
    </form>
  );
}
```

---

## SUCCESS CRITERIA

- [ ] Personal information editing with phone change re-auth
- [ ] Multi-address management (add, edit, delete, set default)
- [ ] Map-based location picker with pin drop
- [ ] Landmark description capture (required)
- [ ] Entrance photo upload
- [ ] Payment methods (cash default, card tokenization)
- [ ] Notification preferences with quiet hours
- [ ] Active sessions view with termination
- [ ] Account deletion flow
- [ ] Language preference

---

## NEXT STEP

After validation passes, proceed to:
→ `dawa-docs/prompts/phase-1/P1.11-chat-system.md`

Reference documentation:
→ `dawa-docs/docs/DAWA_MASTER.md`
→ `dawa-docs/docs/phases/PHASE_1.md`
