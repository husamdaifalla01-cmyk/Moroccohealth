# P1.5 — Order Creation Flow

## Prompt ID: P1.5
## Phase: 1 - Patient Web App
## Estimated Time: 6-7 hours
## Prerequisites: P1.4 complete

---

## CONTEXT

The Order Creation Flow is the **money path** — the critical journey that converts browsers into buyers. Every friction point here costs revenue. Every trust signal accelerates conversion.

**Product Excellence Principles:**
- Linear progress: Clear steps with visual progress indicator
- Smart defaults: Pre-fill address, suggest previous medications
- Instant feedback: Real-time price updates, availability checks
- Trust at checkout: Show pharmacy info, delivery estimate, secure payment badges

**Generative Artist Principles:**
- Cart items that slide in/out smoothly
- Price changes that animate
- Progress bar with satisfying fill animation
- Checkout button with confident, solid feel

---

## ORDER FLOW ARCHITECTURE

```
┌─────────────────────────────────────────────────────────────────┐
│                    ORDER CREATION FLOW                          │
│                                                                 │
│  ┌──────────┐    ┌──────────┐    ┌──────────┐    ┌──────────┐  │
│  │    1     │ →  │    2     │ →  │    3     │ →  │    4     │  │
│  │ PHARMACY │    │ PRODUCTS │    │  CART    │    │ CHECKOUT │  │
│  └──────────┘    └──────────┘    └──────────┘    └──────────┘  │
│                                                                 │
│  Select or      Search &        Review &        Address,       │
│  auto-detect    add items       quantities      payment,       │
│  pharmacy                                       confirm        │
└─────────────────────────────────────────────────────────────────┘
```

---

## IMPLEMENTATION STEPS

### Step 1: Order Store (Zustand)

Create `apps/patient/src/stores/order-store.ts`:

```typescript
// ============================================================
// Order Store - Cart and Order State
// ============================================================

import { create } from 'zustand';
import { persist } from 'zustand/middleware';
import type { Pharmacy, Medication, Address } from '@dawa/types';

export interface CartItem {
  medication: Medication;
  quantity: number;
  prescription_required: boolean;
}

interface OrderState {
  // Selected pharmacy
  pharmacy: Pharmacy | null;
  
  // Cart items
  items: CartItem[];
  
  // Delivery info
  delivery_address: Address | null;
  delivery_instructions: string;
  
  // Prescription
  prescription_id: string | null;
  prescription_url: string | null;
  
  // Computed values
  subtotal: number;
  delivery_fee: number;
  service_fee: number;
  total: number;
  
  // Actions
  setPharmacy: (pharmacy: Pharmacy) => void;
  addItem: (medication: Medication, quantity?: number) => void;
  removeItem: (medicationId: string) => void;
  updateQuantity: (medicationId: string, quantity: number) => void;
  setDeliveryAddress: (address: Address) => void;
  setDeliveryInstructions: (instructions: string) => void;
  setPrescription: (id: string, url: string) => void;
  clearCart: () => void;
  clearOrder: () => void;
}

const DELIVERY_FEE = 15; // 15 DH
const SERVICE_FEE_PERCENT = 0.05; // 5%

export const useOrderStore = create<OrderState>()(
  persist(
    (set, get) => ({
      pharmacy: null,
      items: [],
      delivery_address: null,
      delivery_instructions: '',
      prescription_id: null,
      prescription_url: null,
      subtotal: 0,
      delivery_fee: DELIVERY_FEE,
      service_fee: 0,
      total: 0,

      setPharmacy: (pharmacy) => {
        // Clear cart if changing pharmacy
        const currentPharmacy = get().pharmacy;
        if (currentPharmacy && currentPharmacy.id !== pharmacy.id) {
          set({ items: [], subtotal: 0, service_fee: 0, total: DELIVERY_FEE });
        }
        set({ pharmacy });
      },

      addItem: (medication, quantity = 1) => {
        const items = get().items;
        const existingIndex = items.findIndex(
          (item) => item.medication.id === medication.id
        );

        let newItems: CartItem[];
        if (existingIndex >= 0) {
          // Update quantity
          newItems = items.map((item, index) =>
            index === existingIndex
              ? { ...item, quantity: item.quantity + quantity }
              : item
          );
        } else {
          // Add new item
          newItems = [
            ...items,
            {
              medication,
              quantity,
              prescription_required: medication.requires_prescription,
            },
          ];
        }

        const subtotal = calculateSubtotal(newItems);
        const service_fee = subtotal * SERVICE_FEE_PERCENT;
        const total = subtotal + DELIVERY_FEE + service_fee;

        set({ items: newItems, subtotal, service_fee, total });
      },

      removeItem: (medicationId) => {
        const items = get().items.filter(
          (item) => item.medication.id !== medicationId
        );
        
        const subtotal = calculateSubtotal(items);
        const service_fee = subtotal * SERVICE_FEE_PERCENT;
        const total = items.length > 0 ? subtotal + DELIVERY_FEE + service_fee : 0;

        set({ items, subtotal, service_fee, total });
      },

      updateQuantity: (medicationId, quantity) => {
        if (quantity < 1) {
          get().removeItem(medicationId);
          return;
        }

        const items = get().items.map((item) =>
          item.medication.id === medicationId
            ? { ...item, quantity }
            : item
        );

        const subtotal = calculateSubtotal(items);
        const service_fee = subtotal * SERVICE_FEE_PERCENT;
        const total = subtotal + DELIVERY_FEE + service_fee;

        set({ items, subtotal, service_fee, total });
      },

      setDeliveryAddress: (address) => {
        set({ delivery_address: address });
      },

      setDeliveryInstructions: (instructions) => {
        set({ delivery_instructions: instructions });
      },

      setPrescription: (id, url) => {
        set({ prescription_id: id, prescription_url: url });
      },

      clearCart: () => {
        set({
          items: [],
          subtotal: 0,
          service_fee: 0,
          total: 0,
        });
      },

      clearOrder: () => {
        set({
          pharmacy: null,
          items: [],
          delivery_address: null,
          delivery_instructions: '',
          prescription_id: null,
          prescription_url: null,
          subtotal: 0,
          delivery_fee: DELIVERY_FEE,
          service_fee: 0,
          total: 0,
        });
      },
    }),
    {
      name: 'dawa-order',
      partialize: (state) => ({
        pharmacy: state.pharmacy,
        items: state.items,
        delivery_address: state.delivery_address,
        prescription_id: state.prescription_id,
      }),
    }
  )
);

function calculateSubtotal(items: CartItem[]): number {
  return items.reduce(
    (sum, item) => sum + item.medication.price * item.quantity,
    0
  );
}
```

### Step 2: Order Creation Page Layout

Create `apps/patient/src/app/(main)/orders/new/page.tsx`:

```typescript
'use client';

// ============================================================
// New Order Page - Multi-step Flow
// ============================================================

import { useState, useEffect } from 'react';
import { useRouter } from 'next/navigation';
import { motion, AnimatePresence } from 'framer-motion';

import { useOrderStore } from '@/stores/order-store';
import { useAuth } from '@/hooks/useAuth';
import { OrderProgress } from '@/components/features/order/order-progress';
import { PharmacyStep } from '@/components/features/order/pharmacy-step';
import { ProductsStep } from '@/components/features/order/products-step';
import { CartStep } from '@/components/features/order/cart-step';
import { CheckoutStep } from '@/components/features/order/checkout-step';

type OrderStep = 'pharmacy' | 'products' | 'cart' | 'checkout';

const STEPS: OrderStep[] = ['pharmacy', 'products', 'cart', 'checkout'];

export default function NewOrderPage() {
  const router = useRouter();
  const { isAuthenticated, isLoading } = useAuth();
  const { pharmacy, items } = useOrderStore();
  const [currentStep, setCurrentStep] = useState<OrderStep>('pharmacy');

  // Redirect if not authenticated
  useEffect(() => {
    if (!isLoading && !isAuthenticated) {
      router.push('/login?redirect=/orders/new');
    }
  }, [isAuthenticated, isLoading, router]);

  // Determine step based on state
  useEffect(() => {
    if (!pharmacy) {
      setCurrentStep('pharmacy');
    } else if (items.length === 0) {
      setCurrentStep('products');
    }
  }, [pharmacy, items]);

  const currentStepIndex = STEPS.indexOf(currentStep);

  const goToStep = (step: OrderStep) => {
    const targetIndex = STEPS.indexOf(step);
    // Can only go back or to next step
    if (targetIndex <= currentStepIndex + 1) {
      setCurrentStep(step);
    }
  };

  const nextStep = () => {
    const nextIndex = currentStepIndex + 1;
    if (nextIndex < STEPS.length) {
      setCurrentStep(STEPS[nextIndex]);
    }
  };

  const prevStep = () => {
    const prevIndex = currentStepIndex - 1;
    if (prevIndex >= 0) {
      setCurrentStep(STEPS[prevIndex]);
    }
  };

  if (isLoading) {
    return <OrderSkeleton />;
  }

  return (
    <div className="min-h-screen bg-gray-50">
      {/* Progress bar */}
      <OrderProgress 
        steps={STEPS} 
        currentStep={currentStep} 
        onStepClick={goToStep}
      />

      {/* Step content */}
      <div className="page-container py-6">
        <AnimatePresence mode="wait">
          <motion.div
            key={currentStep}
            initial={{ opacity: 0, x: 20 }}
            animate={{ opacity: 1, x: 0 }}
            exit={{ opacity: 0, x: -20 }}
            transition={{ duration: 0.3 }}
          >
            {currentStep === 'pharmacy' && (
              <PharmacyStep onNext={nextStep} />
            )}
            {currentStep === 'products' && (
              <ProductsStep onNext={nextStep} onBack={prevStep} />
            )}
            {currentStep === 'cart' && (
              <CartStep onNext={nextStep} onBack={prevStep} />
            )}
            {currentStep === 'checkout' && (
              <CheckoutStep onBack={prevStep} />
            )}
          </motion.div>
        </AnimatePresence>
      </div>
    </div>
  );
}

function OrderSkeleton() {
  return (
    <div className="page-container py-6">
      <div className="animate-pulse space-y-6">
        <div className="h-2 bg-gray-200 rounded-full" />
        <div className="h-48 bg-gray-200 rounded-2xl" />
        <div className="h-32 bg-gray-200 rounded-2xl" />
      </div>
    </div>
  );
}
```

### Step 3: Progress Indicator

Create `apps/patient/src/components/features/order/order-progress.tsx`:

```typescript
'use client';

// ============================================================
// Order Progress Indicator
// ============================================================

import { motion } from 'framer-motion';
import { MapPin, Search, ShoppingCart, CreditCard, Check } from 'lucide-react';

const stepConfig = {
  pharmacy: { icon: MapPin, label: 'Pharmacie' },
  products: { icon: Search, label: 'Produits' },
  cart: { icon: ShoppingCart, label: 'Panier' },
  checkout: { icon: CreditCard, label: 'Paiement' },
};

interface OrderProgressProps {
  steps: string[];
  currentStep: string;
  onStepClick: (step: string) => void;
}

export function OrderProgress({ steps, currentStep, onStepClick }: OrderProgressProps) {
  const currentIndex = steps.indexOf(currentStep);

  return (
    <div className="sticky top-16 z-30 bg-white border-b border-gray-100">
      <div className="page-container">
        <div className="flex items-center justify-between py-4">
          {steps.map((step, index) => {
            const config = stepConfig[step as keyof typeof stepConfig];
            const Icon = config.icon;
            const isCompleted = index < currentIndex;
            const isCurrent = index === currentIndex;
            const isClickable = index <= currentIndex;

            return (
              <div key={step} className="flex items-center">
                {/* Step indicator */}
                <button
                  onClick={() => isClickable && onStepClick(step)}
                  disabled={!isClickable}
                  className={`
                    relative flex items-center gap-2 transition-all
                    ${isClickable ? 'cursor-pointer' : 'cursor-not-allowed'}
                  `}
                >
                  {/* Circle */}
                  <motion.div
                    className={`
                      relative flex h-10 w-10 items-center justify-center rounded-full
                      transition-all duration-300
                      ${isCompleted
                        ? 'bg-primary-500 text-white'
                        : isCurrent
                        ? 'bg-primary-100 text-primary-600 ring-4 ring-primary-500/20'
                        : 'bg-gray-100 text-gray-400'
                      }
                    `}
                    animate={{
                      scale: isCurrent ? 1.1 : 1,
                    }}
                  >
                    {isCompleted ? (
                      <Check className="h-5 w-5" />
                    ) : (
                      <Icon className="h-5 w-5" />
                    )}
                  </motion.div>

                  {/* Label (desktop) */}
                  <span
                    className={`
                      hidden sm:block text-sm font-medium
                      ${isCurrent ? 'text-primary-600' : 'text-gray-500'}
                    `}
                  >
                    {config.label}
                  </span>
                </button>

                {/* Connector line */}
                {index < steps.length - 1 && (
                  <div className="mx-2 sm:mx-4 h-0.5 w-8 sm:w-16 bg-gray-200 overflow-hidden">
                    <motion.div
                      className="h-full bg-primary-500"
                      initial={{ width: 0 }}
                      animate={{
                        width: isCompleted ? '100%' : '0%',
                      }}
                      transition={{ duration: 0.5 }}
                    />
                  </div>
                )}
              </div>
            );
          })}
        </div>
      </div>
    </div>
  );
}
```

### Step 4: Pharmacy Selection Step

Create `apps/patient/src/components/features/order/pharmacy-step.tsx`:

```typescript
'use client';

// ============================================================
// Pharmacy Selection Step
// ============================================================

import { useState, useEffect } from 'react';
import { useQuery } from '@tanstack/react-query';
import { motion } from 'framer-motion';
import { MapPin, Star, Clock, Navigation, Check, Loader2 } from 'lucide-react';

import { useOrderStore } from '@/stores/order-store';
import { useLocationStore } from '@/stores/location-store';
import { getSupabaseClient } from '@/lib/supabase/client';
import { formatDistance } from '@dawa/utils';
import { Button } from '@dawa/ui';
import type { Pharmacy } from '@dawa/types';

interface PharmacyStepProps {
  onNext: () => void;
}

export function PharmacyStep({ onNext }: PharmacyStepProps) {
  const { pharmacy: selectedPharmacy, setPharmacy } = useOrderStore();
  const { latitude, longitude, requestLocation, isLoading: locationLoading } = useLocationStore();
  const supabase = getSupabaseClient();

  // Fetch nearby pharmacies
  const { data: pharmacies, isLoading } = useQuery({
    queryKey: ['pharmacies', latitude, longitude],
    queryFn: async () => {
      const { data, error } = await supabase
        .from('pharmacies')
        .select('*')
        .eq('status', 'ACTIVE')
        .limit(10);
      
      if (error) throw error;
      return data as Pharmacy[];
    },
  });

  // Request location on mount
  useEffect(() => {
    if (!latitude || !longitude) {
      requestLocation();
    }
  }, []);

  const handleSelect = (pharmacy: Pharmacy) => {
    setPharmacy(pharmacy);
  };

  const handleContinue = () => {
    if (selectedPharmacy) {
      onNext();
    }
  };

  return (
    <div className="space-y-6">
      {/* Header */}
      <div>
        <h1 className="text-2xl font-bold text-gray-900">Choisir une pharmacie</h1>
        <p className="mt-1 text-gray-600">
          Sélectionnez la pharmacie pour votre commande
        </p>
      </div>

      {/* Location status */}
      {locationLoading && (
        <div className="flex items-center gap-2 rounded-lg bg-blue-50 px-4 py-3 text-sm text-blue-700">
          <Loader2 className="h-4 w-4 animate-spin" />
          Recherche de votre position...
        </div>
      )}

      {/* Pharmacies grid */}
      <div className="grid gap-4 sm:grid-cols-2">
        {isLoading ? (
          // Skeletons
          [...Array(4)].map((_, i) => (
            <div key={i} className="h-36 animate-pulse rounded-2xl bg-gray-100" />
          ))
        ) : (
          pharmacies?.map((pharmacy, index) => (
            <PharmacyCard
              key={pharmacy.id}
              pharmacy={pharmacy}
              distance={0.5 + index * 0.5}
              isSelected={selectedPharmacy?.id === pharmacy.id}
              onSelect={() => handleSelect(pharmacy)}
            />
          ))
        )}
      </div>

      {/* Continue button */}
      <div className="sticky bottom-20 lg:bottom-4 pt-4">
        <Button
          onClick={handleContinue}
          disabled={!selectedPharmacy}
          fullWidth
          size="lg"
        >
          Continuer avec {selectedPharmacy?.name || 'cette pharmacie'}
        </Button>
      </div>
    </div>
  );
}

interface PharmacyCardProps {
  pharmacy: Pharmacy;
  distance: number;
  isSelected: boolean;
  onSelect: () => void;
}

function PharmacyCard({ pharmacy, distance, isSelected, onSelect }: PharmacyCardProps) {
  const hour = new Date().getHours();
  const isOpen = hour >= 8 && hour < 22;

  return (
    <motion.button
      onClick={onSelect}
      className={`
        relative w-full rounded-2xl p-4 text-left transition-all
        ${isSelected
          ? 'bg-primary-50 ring-2 ring-primary-500 shadow-soft-md'
          : 'bg-white shadow-soft border border-gray-100 hover:shadow-soft-md hover:border-gray-200'
        }
      `}
      whileTap={{ scale: 0.98 }}
    >
      {/* Selected indicator */}
      {isSelected && (
        <motion.div
          initial={{ scale: 0 }}
          animate={{ scale: 1 }}
          className="absolute -right-2 -top-2 flex h-6 w-6 items-center justify-center rounded-full bg-primary-500 shadow-lg"
        >
          <Check className="h-4 w-4 text-white" />
        </motion.div>
      )}

      <div className="flex gap-4">
        {/* Logo */}
        <div className="relative h-16 w-16 shrink-0 overflow-hidden rounded-xl bg-gray-100">
          {pharmacy.logo_url ? (
            <img src={pharmacy.logo_url} alt="" className="h-full w-full object-cover" />
          ) : (
            <div className="flex h-full w-full items-center justify-center bg-gradient-to-br from-primary-100 to-primary-200">
              <MapPin className="h-7 w-7 text-primary-600" />
            </div>
          )}
        </div>

        {/* Info */}
        <div className="flex-1 min-w-0">
          <h3 className="font-semibold text-gray-900 truncate">{pharmacy.name}</h3>
          
          <div className="mt-1 flex flex-wrap items-center gap-x-3 gap-y-1 text-sm">
            <div className="flex items-center gap-1">
              <Star className="h-3.5 w-3.5 fill-yellow-400 text-yellow-400" />
              <span className="text-gray-700">{pharmacy.rating?.toFixed(1) || '4.5'}</span>
            </div>
            
            <div className="flex items-center gap-1 text-gray-500">
              <Navigation className="h-3.5 w-3.5" />
              <span>{formatDistance(distance)}</span>
            </div>
            
            <span className={`flex items-center gap-1 text-xs font-medium ${isOpen ? 'text-green-600' : 'text-red-500'}`}>
              <Clock className="h-3 w-3" />
              {isOpen ? 'Ouverte' : 'Fermée'}
            </span>
          </div>

          <p className="mt-2 text-xs text-gray-500 truncate">
            {pharmacy.address}
          </p>
        </div>
      </div>
    </motion.button>
  );
}
```

### Step 5: Products Search Step

Create `apps/patient/src/components/features/order/products-step.tsx`:

```typescript
'use client';

// ============================================================
// Products Search and Add Step
// ============================================================

import { useState, useMemo } from 'react';
import { useQuery } from '@tanstack/react-query';
import { motion, AnimatePresence } from 'framer-motion';
import { Search, Plus, Minus, ShoppingCart, ArrowLeft, Pill, FileText } from 'lucide-react';
import { useDebounce } from 'use-debounce';

import { useOrderStore } from '@/stores/order-store';
import { getSupabaseClient } from '@/lib/supabase/client';
import { formatCurrency } from '@dawa/utils';
import { Button, Input } from '@dawa/ui';
import type { Medication } from '@dawa/types';

interface ProductsStepProps {
  onNext: () => void;
  onBack: () => void;
}

export function ProductsStep({ onNext, onBack }: ProductsStepProps) {
  const { pharmacy, items, addItem, removeItem, updateQuantity, total } = useOrderStore();
  const [searchQuery, setSearchQuery] = useState('');
  const [debouncedQuery] = useDebounce(searchQuery, 300);
  const supabase = getSupabaseClient();

  // Search medications
  const { data: medications, isLoading } = useQuery({
    queryKey: ['medications', pharmacy?.id, debouncedQuery],
    queryFn: async () => {
      let query = supabase
        .from('medications')
        .select('*')
        .eq('is_available', true)
        .limit(20);

      if (debouncedQuery) {
        query = query.ilike('name', `%${debouncedQuery}%`);
      }

      const { data, error } = await query;
      if (error) throw error;
      return data as Medication[];
    },
    enabled: !!pharmacy,
  });

  // Get cart quantity for a medication
  const getCartQuantity = (medicationId: string) => {
    const item = items.find((i) => i.medication.id === medicationId);
    return item?.quantity || 0;
  };

  // Check if cart requires prescription
  const requiresPrescription = items.some((item) => item.prescription_required);

  return (
    <div className="space-y-6">
      {/* Header */}
      <div className="flex items-center gap-4">
        <button
          onClick={onBack}
          className="flex h-10 w-10 items-center justify-center rounded-full bg-gray-100 hover:bg-gray-200"
        >
          <ArrowLeft className="h-5 w-5" />
        </button>
        <div>
          <h1 className="text-2xl font-bold text-gray-900">Ajouter des produits</h1>
          <p className="text-gray-600">{pharmacy?.name}</p>
        </div>
      </div>

      {/* Search */}
      <div className="relative">
        <Search className="absolute left-4 top-1/2 -translate-y-1/2 h-5 w-5 text-gray-400" />
        <input
          type="text"
          value={searchQuery}
          onChange={(e) => setSearchQuery(e.target.value)}
          placeholder="Rechercher un médicament..."
          className="w-full rounded-xl border border-gray-200 bg-white py-3 pl-12 pr-4
                   focus:border-primary-500 focus:outline-none focus:ring-2 focus:ring-primary-500/20"
        />
      </div>

      {/* Products grid */}
      <div className="grid gap-4 sm:grid-cols-2 lg:grid-cols-3">
        {isLoading ? (
          [...Array(6)].map((_, i) => (
            <div key={i} className="h-48 animate-pulse rounded-2xl bg-gray-100" />
          ))
        ) : (
          medications?.map((medication) => (
            <ProductCard
              key={medication.id}
              medication={medication}
              quantity={getCartQuantity(medication.id)}
              onAdd={() => addItem(medication)}
              onRemove={() => removeItem(medication.id)}
              onUpdateQuantity={(qty) => updateQuantity(medication.id, qty)}
            />
          ))
        )}
      </div>

      {/* Prescription warning */}
      {requiresPrescription && (
        <div className="rounded-xl bg-amber-50 border border-amber-200 p-4">
          <div className="flex items-start gap-3">
            <FileText className="h-5 w-5 text-amber-600 shrink-0 mt-0.5" />
            <div>
              <p className="font-medium text-amber-800">Ordonnance requise</p>
              <p className="text-sm text-amber-700">
                Certains produits nécessitent une ordonnance. Vous pourrez la télécharger à l'étape suivante.
              </p>
            </div>
          </div>
        </div>
      )}

      {/* Cart summary (floating) */}
      <AnimatePresence>
        {items.length > 0 && (
          <motion.div
            initial={{ opacity: 0, y: 50 }}
            animate={{ opacity: 1, y: 0 }}
            exit={{ opacity: 0, y: 50 }}
            className="sticky bottom-20 lg:bottom-4"
          >
            <div className="rounded-2xl bg-gray-900 p-4 shadow-xl">
              <div className="flex items-center justify-between gap-4">
                <div className="flex items-center gap-3">
                  <div className="flex h-12 w-12 items-center justify-center rounded-full bg-primary-500">
                    <ShoppingCart className="h-6 w-6 text-white" />
                  </div>
                  <div>
                    <p className="text-sm text-gray-400">
                      {items.length} article{items.length > 1 ? 's' : ''}
                    </p>
                    <p className="text-lg font-bold text-white">
                      {formatCurrency(total)}
                    </p>
                  </div>
                </div>
                <Button onClick={onNext} size="lg">
                  Voir le panier
                </Button>
              </div>
            </div>
          </motion.div>
        )}
      </AnimatePresence>
    </div>
  );
}

interface ProductCardProps {
  medication: Medication;
  quantity: number;
  onAdd: () => void;
  onRemove: () => void;
  onUpdateQuantity: (qty: number) => void;
}

function ProductCard({
  medication,
  quantity,
  onAdd,
  onRemove,
  onUpdateQuantity,
}: ProductCardProps) {
  const isInCart = quantity > 0;

  return (
    <motion.div
      layout
      className={`
        rounded-2xl bg-white p-4 shadow-soft border transition-all
        ${isInCart ? 'border-primary-200 ring-1 ring-primary-500/20' : 'border-gray-100'}
      `}
    >
      {/* Image */}
      <div className="relative mb-3 aspect-square overflow-hidden rounded-xl bg-gray-100">
        {medication.image_url ? (
          <img
            src={medication.image_url}
            alt={medication.name}
            className="h-full w-full object-cover"
          />
        ) : (
          <div className="flex h-full w-full items-center justify-center">
            <Pill className="h-12 w-12 text-gray-300" />
          </div>
        )}
        
        {/* Prescription badge */}
        {medication.requires_prescription && (
          <div className="absolute left-2 top-2 rounded-full bg-amber-500 px-2 py-0.5 text-xs font-medium text-white">
            Ordonnance
          </div>
        )}
      </div>

      {/* Info */}
      <div className="mb-3">
        <h3 className="font-medium text-gray-900 line-clamp-2">{medication.name}</h3>
        <p className="text-sm text-gray-500">{medication.dosage}</p>
      </div>

      {/* Price and actions */}
      <div className="flex items-center justify-between">
        <p className="text-lg font-bold text-primary-600">
          {formatCurrency(medication.price)}
        </p>

        {isInCart ? (
          <div className="flex items-center gap-2">
            <button
              onClick={() => onUpdateQuantity(quantity - 1)}
              className="flex h-8 w-8 items-center justify-center rounded-full bg-gray-100 hover:bg-gray-200"
            >
              <Minus className="h-4 w-4" />
            </button>
            <span className="w-8 text-center font-medium">{quantity}</span>
            <button
              onClick={() => onUpdateQuantity(quantity + 1)}
              className="flex h-8 w-8 items-center justify-center rounded-full bg-primary-500 text-white hover:bg-primary-600"
            >
              <Plus className="h-4 w-4" />
            </button>
          </div>
        ) : (
          <button
            onClick={onAdd}
            className="flex h-10 w-10 items-center justify-center rounded-full bg-primary-500 text-white
                     shadow-lg shadow-primary-500/30 hover:bg-primary-600 transition-all hover:scale-105"
          >
            <Plus className="h-5 w-5" />
          </button>
        )}
      </div>
    </motion.div>
  );
}
```

### Step 6: Cart Review Step

Create `apps/patient/src/components/features/order/cart-step.tsx`:

```typescript
'use client';

// ============================================================
// Cart Review Step
// ============================================================

import { motion, AnimatePresence } from 'framer-motion';
import { ArrowLeft, Trash2, Plus, Minus, ShoppingBag, Upload, FileText } from 'lucide-react';

import { useOrderStore } from '@/stores/order-store';
import { formatCurrency } from '@dawa/utils';
import { Button } from '@dawa/ui';

interface CartStepProps {
  onNext: () => void;
  onBack: () => void;
}

export function CartStep({ onNext, onBack }: CartStepProps) {
  const {
    pharmacy,
    items,
    subtotal,
    delivery_fee,
    service_fee,
    total,
    updateQuantity,
    removeItem,
    prescription_url,
    setPrescription,
  } = useOrderStore();

  const requiresPrescription = items.some((item) => item.prescription_required);

  const handlePrescriptionUpload = async (e: React.ChangeEvent<HTMLInputElement>) => {
    const file = e.target.files?.[0];
    if (!file) return;

    // In production, upload to storage and get URL
    const mockUrl = URL.createObjectURL(file);
    setPrescription('mock-id', mockUrl);
  };

  const canContinue = !requiresPrescription || prescription_url;

  return (
    <div className="space-y-6">
      {/* Header */}
      <div className="flex items-center gap-4">
        <button
          onClick={onBack}
          className="flex h-10 w-10 items-center justify-center rounded-full bg-gray-100 hover:bg-gray-200"
        >
          <ArrowLeft className="h-5 w-5" />
        </button>
        <div>
          <h1 className="text-2xl font-bold text-gray-900">Votre panier</h1>
          <p className="text-gray-600">{items.length} article{items.length > 1 ? 's' : ''}</p>
        </div>
      </div>

      <div className="grid gap-6 lg:grid-cols-3">
        {/* Cart items */}
        <div className="lg:col-span-2 space-y-4">
          <AnimatePresence>
            {items.map((item) => (
              <motion.div
                key={item.medication.id}
                layout
                initial={{ opacity: 0, y: 20 }}
                animate={{ opacity: 1, y: 0 }}
                exit={{ opacity: 0, x: -100 }}
                className="flex gap-4 rounded-2xl bg-white p-4 shadow-soft border border-gray-100"
              >
                {/* Image */}
                <div className="h-20 w-20 shrink-0 overflow-hidden rounded-xl bg-gray-100">
                  {item.medication.image_url ? (
                    <img
                      src={item.medication.image_url}
                      alt=""
                      className="h-full w-full object-cover"
                    />
                  ) : (
                    <div className="flex h-full w-full items-center justify-center">
                      <ShoppingBag className="h-8 w-8 text-gray-300" />
                    </div>
                  )}
                </div>

                {/* Info */}
                <div className="flex-1 min-w-0">
                  <div className="flex items-start justify-between gap-2">
                    <div>
                      <h3 className="font-medium text-gray-900">{item.medication.name}</h3>
                      <p className="text-sm text-gray-500">{item.medication.dosage}</p>
                      {item.prescription_required && (
                        <span className="inline-block mt-1 rounded bg-amber-100 px-2 py-0.5 text-xs font-medium text-amber-700">
                          Ordonnance requise
                        </span>
                      )}
                    </div>
                    <button
                      onClick={() => removeItem(item.medication.id)}
                      className="p-2 text-gray-400 hover:text-red-500"
                    >
                      <Trash2 className="h-4 w-4" />
                    </button>
                  </div>

                  {/* Price and quantity */}
                  <div className="mt-3 flex items-center justify-between">
                    <p className="font-bold text-primary-600">
                      {formatCurrency(item.medication.price * item.quantity)}
                    </p>
                    <div className="flex items-center gap-2">
                      <button
                        onClick={() => updateQuantity(item.medication.id, item.quantity - 1)}
                        className="flex h-8 w-8 items-center justify-center rounded-full bg-gray-100 hover:bg-gray-200"
                      >
                        <Minus className="h-4 w-4" />
                      </button>
                      <span className="w-8 text-center font-medium">{item.quantity}</span>
                      <button
                        onClick={() => updateQuantity(item.medication.id, item.quantity + 1)}
                        className="flex h-8 w-8 items-center justify-center rounded-full bg-gray-100 hover:bg-gray-200"
                      >
                        <Plus className="h-4 w-4" />
                      </button>
                    </div>
                  </div>
                </div>
              </motion.div>
            ))}
          </AnimatePresence>

          {/* Prescription upload */}
          {requiresPrescription && (
            <div className="rounded-2xl bg-amber-50 border-2 border-dashed border-amber-300 p-6">
              <div className="text-center">
                <FileText className="mx-auto h-10 w-10 text-amber-500 mb-3" />
                <h3 className="font-medium text-amber-900 mb-1">Ordonnance requise</h3>
                <p className="text-sm text-amber-700 mb-4">
                  Téléchargez votre ordonnance pour continuer
                </p>

                {prescription_url ? (
                  <div className="flex items-center justify-center gap-2 text-green-600">
                    <FileText className="h-5 w-5" />
                    <span className="font-medium">Ordonnance ajoutée</span>
                  </div>
                ) : (
                  <label className="inline-flex cursor-pointer items-center gap-2 rounded-lg bg-amber-500 px-4 py-2 text-white hover:bg-amber-600">
                    <Upload className="h-4 w-4" />
                    Télécharger l'ordonnance
                    <input
                      type="file"
                      accept="image/*,.pdf"
                      onChange={handlePrescriptionUpload}
                      className="sr-only"
                    />
                  </label>
                )}
              </div>
            </div>
          )}
        </div>

        {/* Order summary */}
        <div className="lg:sticky lg:top-32 h-fit">
          <div className="rounded-2xl bg-white p-6 shadow-soft border border-gray-100">
            <h3 className="font-semibold text-gray-900 mb-4">Résumé</h3>

            <div className="space-y-3 text-sm">
              <div className="flex justify-between">
                <span className="text-gray-600">Sous-total</span>
                <span className="font-medium">{formatCurrency(subtotal)}</span>
              </div>
              <div className="flex justify-between">
                <span className="text-gray-600">Livraison</span>
                <span className="font-medium">{formatCurrency(delivery_fee)}</span>
              </div>
              <div className="flex justify-between">
                <span className="text-gray-600">Frais de service</span>
                <span className="font-medium">{formatCurrency(service_fee)}</span>
              </div>
              <div className="border-t border-gray-200 pt-3 flex justify-between">
                <span className="font-semibold text-gray-900">Total</span>
                <span className="font-bold text-xl text-primary-600">
                  {formatCurrency(total)}
                </span>
              </div>
            </div>

            <Button
              onClick={onNext}
              disabled={!canContinue}
              fullWidth
              size="lg"
              className="mt-6"
            >
              Passer au paiement
            </Button>

            {!canContinue && (
              <p className="mt-2 text-center text-xs text-amber-600">
                Veuillez ajouter votre ordonnance
              </p>
            )}
          </div>
        </div>
      </div>
    </div>
  );
}
```

### Step 7: Checkout Step (Summary - Full implementation would be longer)

Create `apps/patient/src/components/features/order/checkout-step.tsx`:

```typescript
'use client';

// ============================================================
// Checkout Step - Address & Payment
// ============================================================

import { useState } from 'react';
import { useRouter } from 'next/navigation';
import { motion } from 'framer-motion';
import { ArrowLeft, MapPin, CreditCard, Wallet, Truck, Shield, Loader2 } from 'lucide-react';
import { toast } from 'sonner';

import { useOrderStore } from '@/stores/order-store';
import { useAuth } from '@/hooks/useAuth';
import { getSupabaseClient } from '@/lib/supabase/client';
import { formatCurrency } from '@dawa/utils';
import { Button } from '@dawa/ui';
import type { PaymentMethod } from '@dawa/types';

const paymentMethods: { id: PaymentMethod; label: string; icon: typeof CreditCard; description: string }[] = [
  { id: 'CASH_ON_DELIVERY', label: 'Paiement à la livraison', icon: Wallet, description: 'Payez en espèces' },
  { id: 'CARD', label: 'Carte bancaire', icon: CreditCard, description: 'CMI sécurisé' },
];

interface CheckoutStepProps {
  onBack: () => void;
}

export function CheckoutStep({ onBack }: CheckoutStepProps) {
  const router = useRouter();
  const { patient } = useAuth();
  const supabase = getSupabaseClient();
  const {
    pharmacy,
    items,
    total,
    delivery_address,
    delivery_instructions,
    setDeliveryAddress,
    setDeliveryInstructions,
    prescription_id,
    clearOrder,
  } = useOrderStore();

  const [selectedPayment, setSelectedPayment] = useState<PaymentMethod>('CASH_ON_DELIVERY');
  const [isSubmitting, setIsSubmitting] = useState(false);

  const handleSubmit = async () => {
    if (!patient || !pharmacy || items.length === 0) return;

    setIsSubmitting(true);

    try {
      // Create order
      const { data: order, error } = await supabase
        .from('orders')
        .insert({
          patient_id: patient.id,
          pharmacy_id: pharmacy.id,
          status: 'PENDING_PHARMACY',
          payment_method: selectedPayment,
          payment_status: selectedPayment === 'CASH_ON_DELIVERY' ? 'PENDING' : 'PENDING',
          subtotal: items.reduce((sum, i) => sum + i.medication.price * i.quantity, 0),
          delivery_fee: 15,
          service_fee: total * 0.05,
          total_amount: total,
          delivery_address: delivery_address,
          delivery_instructions,
          prescription_id,
        })
        .select()
        .single();

      if (error) throw error;

      // Create order items
      const orderItems = items.map((item) => ({
        order_id: order.id,
        medication_id: item.medication.id,
        quantity: item.quantity,
        unit_price: item.medication.price,
        total_price: item.medication.price * item.quantity,
      }));

      await supabase.from('order_items').insert(orderItems);

      // Clear cart and redirect
      clearOrder();
      toast.success('Commande créée avec succès !');
      router.push(`/orders/${order.id}/confirmation`);
    } catch (error) {
      console.error('Order creation error:', error);
      toast.error('Erreur lors de la création de la commande');
    } finally {
      setIsSubmitting(false);
    }
  };

  return (
    <div className="space-y-6">
      {/* Header */}
      <div className="flex items-center gap-4">
        <button
          onClick={onBack}
          className="flex h-10 w-10 items-center justify-center rounded-full bg-gray-100 hover:bg-gray-200"
        >
          <ArrowLeft className="h-5 w-5" />
        </button>
        <div>
          <h1 className="text-2xl font-bold text-gray-900">Finaliser la commande</h1>
          <p className="text-gray-600">Vérifiez les détails et confirmez</p>
        </div>
      </div>

      <div className="grid gap-6 lg:grid-cols-3">
        <div className="lg:col-span-2 space-y-6">
          
          {/* Delivery address */}
          <section className="rounded-2xl bg-white p-6 shadow-soft border border-gray-100">
            <div className="flex items-center gap-2 mb-4">
              <MapPin className="h-5 w-5 text-primary-500" />
              <h2 className="font-semibold text-gray-900">Adresse de livraison</h2>
            </div>

            {/* Address selection would go here - simplified for now */}
            <div className="rounded-xl bg-gray-50 p-4 border border-gray-200">
              <p className="font-medium text-gray-900">Adresse par défaut</p>
              <p className="text-sm text-gray-600">123 Rue Hassan II, Casablanca</p>
            </div>

            <textarea
              value={delivery_instructions}
              onChange={(e) => setDeliveryInstructions(e.target.value)}
              placeholder="Instructions de livraison (optionnel)"
              className="mt-4 w-full rounded-xl border border-gray-200 p-3 text-sm
                       focus:border-primary-500 focus:outline-none focus:ring-2 focus:ring-primary-500/20"
              rows={2}
            />
          </section>

          {/* Payment method */}
          <section className="rounded-2xl bg-white p-6 shadow-soft border border-gray-100">
            <div className="flex items-center gap-2 mb-4">
              <CreditCard className="h-5 w-5 text-primary-500" />
              <h2 className="font-semibold text-gray-900">Mode de paiement</h2>
            </div>

            <div className="space-y-3">
              {paymentMethods.map((method) => (
                <button
                  key={method.id}
                  onClick={() => setSelectedPayment(method.id)}
                  className={`
                    w-full flex items-center gap-4 rounded-xl p-4 text-left transition-all
                    ${selectedPayment === method.id
                      ? 'bg-primary-50 border-2 border-primary-500'
                      : 'bg-gray-50 border-2 border-transparent hover:border-gray-200'
                    }
                  `}
                >
                  <method.icon className={`h-6 w-6 ${selectedPayment === method.id ? 'text-primary-600' : 'text-gray-400'}`} />
                  <div>
                    <p className="font-medium text-gray-900">{method.label}</p>
                    <p className="text-sm text-gray-500">{method.description}</p>
                  </div>
                </button>
              ))}
            </div>
          </section>

          {/* Trust badges */}
          <div className="flex items-center justify-center gap-6 py-4">
            <div className="flex items-center gap-2 text-sm text-gray-500">
              <Shield className="h-4 w-4 text-green-500" />
              Paiement sécurisé
            </div>
            <div className="flex items-center gap-2 text-sm text-gray-500">
              <Truck className="h-4 w-4 text-primary-500" />
              Livraison rapide
            </div>
          </div>
        </div>

        {/* Order summary */}
        <div className="lg:sticky lg:top-32 h-fit">
          <div className="rounded-2xl bg-white p-6 shadow-soft border border-gray-100">
            <h3 className="font-semibold text-gray-900 mb-4">Votre commande</h3>

            {/* Items summary */}
            <div className="space-y-2 mb-4 max-h-48 overflow-auto">
              {items.map((item) => (
                <div key={item.medication.id} className="flex justify-between text-sm">
                  <span className="text-gray-600">
                    {item.medication.name} x{item.quantity}
                  </span>
                  <span className="font-medium">
                    {formatCurrency(item.medication.price * item.quantity)}
                  </span>
                </div>
              ))}
            </div>

            <div className="border-t border-gray-200 pt-4 space-y-2 text-sm">
              <div className="flex justify-between">
                <span className="text-gray-600">Sous-total</span>
                <span>{formatCurrency(total - 15 - total * 0.05)}</span>
              </div>
              <div className="flex justify-between">
                <span className="text-gray-600">Livraison</span>
                <span>{formatCurrency(15)}</span>
              </div>
              <div className="flex justify-between font-semibold text-lg pt-2 border-t">
                <span>Total</span>
                <span className="text-primary-600">{formatCurrency(total)}</span>
              </div>
            </div>

            <Button
              onClick={handleSubmit}
              disabled={isSubmitting}
              loading={isSubmitting}
              fullWidth
              size="lg"
              className="mt-6"
            >
              {isSubmitting ? 'Création...' : `Confirmer • ${formatCurrency(total)}`}
            </Button>
          </div>
        </div>
      </div>
    </div>
  );
}
```

---

## VALIDATION CHECKPOINTS

### Checkpoint 1: Multi-step Navigation
```bash
# Progress bar shows current step
# Can go back but not skip ahead
# State persists between steps
```

### Checkpoint 2: Cart Functionality
```bash
# Add items updates cart
# Quantity changes reflect in total
# Remove items animates out
```

### Checkpoint 3: Prescription Handling
```bash
# Warning shows when prescription required
# Cannot proceed without uploading
# Upload shows success state
```

### Checkpoint 4: Order Submission
```bash
# Creates order in database
# Clears cart on success
# Redirects to confirmation
```

---

## SUCCESS CRITERIA

- [ ] Multi-step flow with progress indicator
- [ ] Pharmacy selection with search
- [ ] Product search and add to cart
- [ ] Cart with quantity management
- [ ] Prescription upload when required
- [ ] Address and payment selection
- [ ] Order creation and confirmation
- [ ] Animations throughout flow

---

## NEXT STEP

After validation passes, proceed to:
→ `dawa-docs/prompts/phase-1/P1.6-order-tracking.md`

Reference documentation:
→ `dawa-docs/docs/DAWA_MASTER.md`
→ `dawa-docs/docs/phases/PHASE_1.md`
