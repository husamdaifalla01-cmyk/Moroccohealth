# P1.3 — Rx Verification Flow (V100)

## Prompt ID: P1.3
## Phase: 1 - Patient Web App
## Estimated Time: 4-5 hours
## Prerequisites: P1.2 complete

---

## OVERVIEW

Build the prescription verification UI that appears when a patient uploads a prescription. This is a focused flow within the order creation process.

## WORKSPACE PATHS

> **NOTE**: Documentation lives in `dawa-docs/`, app code in `dawa-ma/`.

---

## VERIFICATION FLOW

```
┌─────────────────────────────────────────────────────────────────────────────┐
│                    PRESCRIPTION VERIFICATION STATES                          │
├─────────────────────────────────────────────────────────────────────────────┤
│                                                                              │
│  1. UPLOADING                                                               │
│     • Show progress bar                                                    │
│     • "Téléchargement en cours..."                                         │
│                                                                              │
│  2. PROCESSING                                                              │
│     • Show spinner with "Analyse en cours..."                              │
│     • Claude Vision extracting medications                                  │
│                                                                              │
│  3. REVIEW (if confidence < 70%)                                           │
│     • Show extracted medications                                            │
│     • Allow editing/correction                                              │
│     • Highlight low-confidence items                                       │
│                                                                              │
│  4. CONTROLLED_SUBSTANCE_BLOCKED                                            │
│     • Show warning if controlled substance detected                        │
│     • Explain delivery not allowed                                         │
│     • Suggest in-store pickup                                              │
│                                                                              │
│  5. COMPLETE                                                                │
│     • Show verified medications                                             │
│     • Ready to proceed with order                                          │
│                                                                              │
└─────────────────────────────────────────────────────────────────────────────┘
```

---

## IMPLEMENTATION

### Verification Component

```typescript
// dawa-ma/apps/patient/src/components/prescription/rx-verification.tsx

'use client';

import { useState } from 'react';
import { motion, AnimatePresence } from 'framer-motion';
import { 
  CheckCircle, AlertTriangle, Edit2, 
  Loader2, FileText, AlertCircle 
} from 'lucide-react';

import { ExtractedPrescription, PrescriptionItem } from '@/types';
import { cn } from '@/lib/utils';

interface RxVerificationProps {
  prescription: ExtractedPrescription;
  onConfirm: (items: PrescriptionItem[]) => void;
  onCancel: () => void;
}

export function RxVerification({ 
  prescription, 
  onConfirm, 
  onCancel 
}: RxVerificationProps) {
  const [items, setItems] = useState(prescription.items);
  const [editingId, setEditingId] = useState<string | null>(null);

  const hasControlledSubstance = items.some(i => i.isControlledSubstance);
  const needsReview = prescription.confidence < 0.7;

  if (hasControlledSubstance) {
    return (
      <div className="bg-red-50 border border-red-200 rounded-xl p-6 text-center">
        <AlertCircle className="h-12 w-12 text-red-500 mx-auto mb-4" />
        <h3 className="text-lg font-semibold text-red-800 mb-2">
          Substance réglementée détectée
        </h3>
        <p className="text-red-600 mb-4">
          Cette ordonnance contient des médicaments à prescription spéciale 
          qui ne peuvent pas être livrés. Veuillez vous rendre en pharmacie 
          avec l'original.
        </p>
        <div className="bg-white rounded-lg p-3 mb-4">
          {items.filter(i => i.isControlledSubstance).map(item => (
            <div key={item.id} className="text-red-700 font-medium">
              ⚠️ {item.medicationName}
            </div>
          ))}
        </div>
        <button 
          onClick={onCancel}
          className="px-6 py-2 bg-red-600 text-white rounded-lg"
        >
          Compris
        </button>
      </div>
    );
  }

  return (
    <div className="space-y-4">
      {/* Header */}
      <div className="flex items-center gap-3 mb-4">
        <div className={cn(
          'h-10 w-10 rounded-full flex items-center justify-center',
          needsReview ? 'bg-yellow-100' : 'bg-green-100'
        )}>
          {needsReview ? (
            <AlertTriangle className="h-5 w-5 text-yellow-600" />
          ) : (
            <CheckCircle className="h-5 w-5 text-green-600" />
          )}
        </div>
        <div>
          <h3 className="font-semibold text-gray-900">
            {needsReview ? 'Vérification requise' : 'Ordonnance analysée'}
          </h3>
          <p className="text-sm text-gray-500">
            {needsReview 
              ? 'Veuillez vérifier les informations extraites'
              : `${items.length} médicament(s) détecté(s)`
            }
          </p>
        </div>
      </div>

      {/* Doctor info */}
      {prescription.doctorName && (
        <div className="bg-gray-50 rounded-lg p-3 text-sm">
          <span className="text-gray-500">Prescrit par:</span>{' '}
          <span className="font-medium">{prescription.doctorName}</span>
        </div>
      )}

      {/* Medications list */}
      <div className="space-y-2">
        {items.map((item, index) => (
          <MedicationItemRow
            key={item.id || index}
            item={item}
            isEditing={editingId === item.id}
            onEdit={() => setEditingId(item.id)}
            onSave={(updated) => {
              setItems(items.map(i => i.id === item.id ? updated : i));
              setEditingId(null);
            }}
            onCancel={() => setEditingId(null)}
          />
        ))}
      </div>

      {/* Actions */}
      <div className="flex gap-3 pt-4">
        <button
          onClick={onCancel}
          className="flex-1 py-3 border border-gray-200 rounded-xl text-gray-600"
        >
          Annuler
        </button>
        <button
          onClick={() => onConfirm(items)}
          className="flex-1 py-3 bg-primary-600 text-white rounded-xl font-medium"
        >
          Confirmer
        </button>
      </div>
    </div>
  );
}

function MedicationItemRow({
  item,
  isEditing,
  onEdit,
  onSave,
  onCancel,
}: {
  item: PrescriptionItem;
  isEditing: boolean;
  onEdit: () => void;
  onSave: (item: PrescriptionItem) => void;
  onCancel: () => void;
}) {
  const [editedItem, setEditedItem] = useState(item);
  const isLowConfidence = (item.confidence || 1) < 0.7;

  if (isEditing) {
    return (
      <div className="border border-primary-200 rounded-lg p-3 bg-primary-50">
        <input
          value={editedItem.medicationName}
          onChange={(e) => setEditedItem({ ...editedItem, medicationName: e.target.value })}
          className="w-full px-3 py-2 border rounded-lg mb-2"
          placeholder="Nom du médicament"
        />
        <div className="flex gap-2">
          <input
            value={editedItem.dosage || ''}
            onChange={(e) => setEditedItem({ ...editedItem, dosage: e.target.value })}
            className="flex-1 px-3 py-2 border rounded-lg"
            placeholder="Dosage"
          />
          <input
            value={editedItem.quantity || ''}
            onChange={(e) => setEditedItem({ ...editedItem, quantity: parseInt(e.target.value) || undefined })}
            className="w-20 px-3 py-2 border rounded-lg"
            placeholder="Qté"
            type="number"
          />
        </div>
        <div className="flex gap-2 mt-2">
          <button onClick={onCancel} className="flex-1 py-2 border rounded-lg text-sm">
            Annuler
          </button>
          <button 
            onClick={() => onSave(editedItem)} 
            className="flex-1 py-2 bg-primary-600 text-white rounded-lg text-sm"
          >
            Sauvegarder
          </button>
        </div>
      </div>
    );
  }

  return (
    <div className={cn(
      'flex items-center gap-3 p-3 rounded-lg border',
      isLowConfidence ? 'border-yellow-300 bg-yellow-50' : 'border-gray-200 bg-white'
    )}>
      <FileText className="h-5 w-5 text-gray-400 shrink-0" />
      <div className="flex-1 min-w-0">
        <p className="font-medium text-gray-900 truncate">
          {item.medicationName}
        </p>
        <p className="text-sm text-gray-500">
          {[item.dosage, item.quantity && `× ${item.quantity}`].filter(Boolean).join(' ')}
        </p>
      </div>
      {isLowConfidence && (
        <span className="text-xs bg-yellow-200 text-yellow-800 px-2 py-0.5 rounded">
          À vérifier
        </span>
      )}
      <button onClick={onEdit} className="p-2 hover:bg-gray-100 rounded-lg">
        <Edit2 className="h-4 w-4 text-gray-400" />
      </button>
    </div>
  );
}
```

---

## SUCCESS CRITERIA

- [ ] Upload progress shown during image upload
- [ ] Processing state with spinner during OCR
- [ ] Review screen for low-confidence extractions
- [ ] Controlled substance blocking with clear message
- [ ] Editable medication rows
- [ ] Confirm/Cancel actions

---

## NEXT STEP

After validation passes, proceed to:
→ `dawa-docs/prompts/phase-1/P1.4-patient-home-dashboard.md`

Reference documentation:
→ `dawa-docs/docs/DAWA_MASTER.md`
→ `dawa-docs/docs/phases/PHASE_1.md`
