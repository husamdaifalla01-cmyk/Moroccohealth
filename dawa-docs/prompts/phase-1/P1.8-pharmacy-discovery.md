# P1.8 — Pharmacy Discovery (V100)

## Prompt ID: P1.8
## Phase: 1 - Patient Web App
## Estimated Time: 10-12 hours
## Prerequisites: P1.7 complete

---

## STRATEGIC CONTEXT

### The Real Problem We're Solving

Pharmacy discovery isn't a search feature—it's **answering context-dependent questions** where the same user has completely different priorities based on their situation.

```
┌─────────────────────────────────────────────────────────────────────────────┐
│                    USER INTENT TAXONOMY                                      │
├─────────────────────────────────────────────────────────────────────────────┤
│                                                                              │
│  INTENT 1: "I NEED THIS NOW" (Urgency-Driven)                               │
│  ─────────────────────────────────────────────────────────────────────────   │
│  Context: Child has fever at 2 AM, sudden pain, emergency situation        │
│  User question: "Which pharmacy is open RIGHT NOW near me?"                │
│                                                                              │
│  Priority hierarchy:                                                        │
│    1. OPEN STATUS (absolute requirement)                                   │
│    2. Distance (closer = faster)                                           │
│    3. Everything else irrelevant                                           │
│                                                                              │
│  UI implications:                                                          │
│  • "Ouvertes maintenant" filter must be FIRST and prominent               │
│  • After 20:00, show "Pharmacie de Garde" banner automatically            │
│  • Display exact closing time: "Ferme dans 45 min"                        │
│  • Show ETA prominently: "Livraison en ~25 min"                           │
│                                                                              │
│  INTENT 2: "I NEED THIS SPECIFIC MEDICATION" (Product-Driven)              │
│  ─────────────────────────────────────────────────────────────────────────   │
│  Context: Doctor prescribed specific brand, specific dosage                │
│  User question: "Who has Doliprane 1000mg in stock right now?"            │
│                                                                              │
│  Priority hierarchy:                                                        │
│    1. HAS THE ITEM (must have it)                                         │
│    2. Distance (for speed)                                                 │
│    3. Rating (tie-breaker)                                                 │
│                                                                              │
│  UI implications:                                                          │
│  • Medication search with autocomplete                                     │
│  • "En stock ✓" badge on pharmacy cards                                   │
│  • Show alternative pharmacies if primary is out                          │
│  • "Voir les alternatives" link if medication unavailable                 │
│                                                                              │
│  INTENT 3: "I WANT THE BEST DEAL" (Price-Driven)                          │
│  ─────────────────────────────────────────────────────────────────────────   │
│  Context: Chronic medication, monthly refill, cost-conscious patient       │
│  User question: "Who has the lowest total cost for my order?"             │
│                                                                              │
│  ⚠️  MOROCCO CRITICAL REALITY:                                             │
│  ┌─────────────────────────────────────────────────────────────────────┐   │
│  │  Prescription drug prices are REGULATED BY LAW in Morocco           │   │
│  │  Same medication = Same price at EVERY pharmacy nationwide          │   │
│  │  We can ONLY compete on: delivery fees, OTC items, service quality  │   │
│  └─────────────────────────────────────────────────────────────────────┘   │
│                                                                              │
│  Priority hierarchy:                                                        │
│    1. Delivery fee (only variable cost for Rx)                            │
│    2. Distance (affects delivery fee)                                      │
│    3. OTC prices (if buying non-prescription items)                       │
│                                                                              │
│  UI implications:                                                          │
│  • Show "Prix réglementé" badge on prescription medications               │
│  • Compare total order cost (items + delivery)                            │
│  • DON'T promise "meilleurs prix" for prescriptions (legally same)       │
│  • Show delivery fee prominently on pharmacy cards                        │
│                                                                              │
│  INTENT 4: "I TRUST THIS PHARMACY" (Relationship-Driven)                   │
│  ─────────────────────────────────────────────────────────────────────────   │
│  Context: Has a family pharmacy, knows the pharmacist personally          │
│  User question: "Is my usual pharmacy available for delivery?"            │
│                                                                              │
│  Priority hierarchy:                                                        │
│    1. SPECIFIC PHARMACY (only one acceptable)                             │
│    2. Open status (can I order now?)                                      │
│                                                                              │
│  UI implications:                                                          │
│  • "Mes pharmacies" section with favorites + recents                      │
│  • Search by pharmacy name                                                 │
│  • One-tap reorder from previous pharmacy                                 │
│  • "Commander chez [Pharmacy Name]" shortcut on home                      │
│                                                                              │
│  INTENT 5: "I'M JUST EXPLORING" (Discovery-Driven)                        │
│  ─────────────────────────────────────────────────────────────────────────   │
│  Context: New to area, first-time user, comparing options                 │
│  User question: "What pharmacies are near me? Which are good?"            │
│                                                                              │
│  Priority hierarchy:                                                        │
│    1. Rating (quality indicator)                                          │
│    2. Distance (convenience)                                               │
│    3. Reviews (social proof)                                              │
│                                                                              │
│  UI implications:                                                          │
│  • Map view with pharmacy pins                                            │
│  • Ratings and review counts visible on cards                             │
│  • Pharmacy profile pages with full details                               │
│  • "Populaires près de vous" section                                      │
│                                                                              │
└─────────────────────────────────────────────────────────────────────────────┘
```

### Morocco Pharmacy Landscape

```
┌─────────────────────────────────────────────────────────────────────────────┐
│                    MOROCCO-SPECIFIC CHALLENGES                               │
├─────────────────────────────────────────────────────────────────────────────┤
│                                                                              │
│  CHALLENGE 1: PHARMACIE DE GARDE (Duty Pharmacy System)                    │
│  ─────────────────────────────────────────────────────────────────────────   │
│                                                                              │
│  What it is:                                                                │
│  • Each neighborhood has ONE pharmacy designated for 24/7 duty            │
│  • Rotation schedule set by regional health authority (weekly/monthly)    │
│  • CRITICAL for nighttime/weekend medication needs                        │
│  • Moroccan law requires this coverage in every zone                      │
│                                                                              │
│  The data problem:                                                         │
│  • Schedule not centralized digitally by government                       │
│  • Often posted on pharmacy doors, local newspapers, radio                │
│  • Different regions use different rotation systems                       │
│  • Changes can happen (swap between pharmacies)                           │
│                                                                              │
│  Our solution:                                                             │
│  ┌─────────────────────────────────────────────────────────────────────┐   │
│  │  1. Partner with regional health delegations for official data      │   │
│  │  2. Allow pharmacies to self-declare duty status (verified)        │   │
│  │  3. Show "Pharmacie de Garde" banner prominently after 20:00       │   │
│  │  4. Link to official government portal as backup reference         │   │
│  │  5. Store in operating_hours JSONB with dutyPharmacy override      │   │
│  └─────────────────────────────────────────────────────────────────────┘   │
│                                                                              │
│  CHALLENGE 2: REGULATED MEDICATION PRICING                                 │
│  ─────────────────────────────────────────────────────────────────────────   │
│                                                                              │
│  Legal reality:                                                            │
│  • Ministry of Health sets maximum prices (Prix Public Maroc - PPM)       │
│  • Prescription medications: Fixed price nationwide, no exceptions        │
│  • OTC medications: Some flexibility (typically 10-20% variance)         │
│  • Parapharmacy (cosmetics, etc.): Significant price variation           │
│                                                                              │
│  Business implications:                                                    │
│  • CANNOT promise "best prices" for prescription medications             │
│  • Price comparison only meaningful for: OTC + delivery fees             │
│  • Must show "Prix réglementé" indicator on Rx items                     │
│  • Delivery fee becomes key differentiator                               │
│                                                                              │
│  CHALLENGE 3: GEOGRAPHIC DENSITY VARIATION                                 │
│  ─────────────────────────────────────────────────────────────────────────   │
│                                                                              │
│  Urban areas (Casablanca, Rabat, Marrakech):                              │
│  • ~1 pharmacy per 3,000-4,000 residents                                  │
│  • Within 2km radius: typically 10-20+ pharmacies                        │
│  • High competition, service quality matters                             │
│                                                                              │
│  Semi-urban (smaller cities):                                             │
│  • ~1 pharmacy per 6,000-8,000 residents                                  │
│  • Within 2km radius: 3-8 pharmacies                                      │
│  • Balance of choice and convenience                                      │
│                                                                              │
│  Rural areas:                                                              │
│  • 1 pharmacy per 15,000+ residents                                       │
│  • May need 10-30km radius to find ANY pharmacy                          │
│  • Delivery becomes essential service, not convenience                   │
│                                                                              │
│  Our solution: ADAPTIVE SEARCH RADIUS                                     │
│  ┌─────────────────────────────────────────────────────────────────────┐   │
│  │  Initial radius: 2km (urban default)                                │   │
│  │  If results < 3: expand to 5km                                      │   │
│  │  If still < 3: expand to 10km                                       │   │
│  │  If still < 3: expand to 25km (rural maximum)                       │   │
│  │  Show message: "Zone élargie - X pharmacies trouvées à Y km"        │   │
│  └─────────────────────────────────────────────────────────────────────┘   │
│                                                                              │
│  CHALLENGE 4: OPERATING HOURS COMPLEXITY                                   │
│  ─────────────────────────────────────────────────────────────────────────   │
│                                                                              │
│  Variables affecting "is this pharmacy open?":                            │
│  1. Regular daily hours (may vary by day of week)                         │
│  2. Lunch/prayer breaks (common: 13:00-15:00 or 12:30-14:30)            │
│  3. Duty pharmacy override (if on duty = 24/7 regardless)                │
│  4. Ramadan hours (shifted schedule during holy month)                   │
│  5. National holidays (closures: Throne Day, Independence Day, etc.)    │
│  6. Special closures (vacation, renovation, family event)                │
│                                                                              │
│  This requires a ROBUST is_pharmacy_open() function that evaluates        │
│  ALL conditions in correct PRIORITY ORDER.                                │
│                                                                              │
└─────────────────────────────────────────────────────────────────────────────┘
```

---

## TECHNICAL ARCHITECTURE

### Geospatial Search Strategy

```
┌─────────────────────────────────────────────────────────────────────────────┐
│                    GEOSPATIAL APPROACH DECISION                              │
├─────────────────────────────────────────────────────────────────────────────┤
│                                                                              │
│  OPTION A: Simple Haversine Formula (SQL calculation)                      │
│  ─────────────────────────────────────────────────────────────────────────   │
│  How: Calculate distance for ALL pharmacies, then filter by radius         │
│  Performance: O(n) full table scan on every query                          │
│  Suitable for: < 500 total pharmacies                                      │
│                                                                              │
│  Problem: Morocco has 12,000+ pharmacies. At scale, this query            │
│  takes 2-5 seconds per search. Unacceptable for user experience.          │
│                                                                              │
│  OPTION B: Bounding Box + Haversine                                        │
│  ─────────────────────────────────────────────────────────────────────────   │
│  How: First filter by lat/lng range (box), then refine with Haversine     │
│  Performance: O(n/k) where k depends on geographic distribution           │
│  Suitable for: < 2,000 pharmacies with good B-tree indexes                │
│                                                                              │
│  Problem: Bounding box doesn't account for Earth's curvature.             │
│  At Morocco's latitude, 1° longitude ≠ 1° latitude in distance.          │
│                                                                              │
│  OPTION C: PostGIS with ST_DWithin (✓ CHOSEN)                             │
│  ─────────────────────────────────────────────────────────────────────────   │
│  How: Use spatial index (GiST) for radius search                          │
│  Performance: O(log n) with proper indexing                               │
│  Suitable for: Millions of points                                          │
│                                                                              │
│  Why this wins:                                                            │
│  • Supabase includes PostGIS extension (no extra setup)                   │
│  • GiST index makes radius queries blazing fast                           │
│  • GEOGRAPHY type handles Earth's curvature correctly                     │
│  • Future-proof for complex queries (within polygon, etc.)               │
│  • Industry standard for location-based applications                      │
│                                                                              │
│  DECISION: PostGIS with GEOGRAPHY type and GiST spatial index             │
│                                                                              │
└─────────────────────────────────────────────────────────────────────────────┘
```

### Search Pipeline

```
┌─────────────────────────────────────────────────────────────────────────────┐
│                    PHARMACY SEARCH PIPELINE                                  │
├─────────────────────────────────────────────────────────────────────────────┤
│                                                                              │
│  INPUT PARAMETERS                                                          │
│  ────────────────                                                          │
│  {                                                                          │
│    userLocation: { lat: number, lng: number }                              │
│    filters: {                                                              │
│      isOpen?: boolean          // Only currently open                      │
│      medicationId?: string     // Has specific medication in stock         │
│      minRating?: number        // Minimum star rating (1-5)                │
│      maxDistance?: number      // Maximum distance in meters               │
│    }                                                                        │
│    sort: 'distance' | 'rating' | 'deliveryTime'                            │
│    pagination: { cursor?: string, limit: number }                          │
│  }                                                                          │
│                                                                              │
│  PIPELINE STEPS                                                            │
│  ──────────────                                                            │
│                                                                              │
│  ┌─────────────┐    ┌──────────────┐    ┌─────────────┐    ┌────────────┐ │
│  │   STEP 1    │───▶│    STEP 2    │───▶│   STEP 3    │───▶│   STEP 4   │ │
│  │  SPATIAL    │    │   ENRICH     │    │   FILTER    │    │    SORT    │ │
│  │   QUERY     │    │    DATA      │    │   RESULTS   │    │  + PAGE    │ │
│  └─────────────┘    └──────────────┘    └─────────────┘    └────────────┘ │
│        │                   │                   │                  │        │
│        ▼                   ▼                   ▼                  ▼        │
│   ST_DWithin         is_open()           Apply user          ORDER BY     │
│   Uses GiST          closes_at           filters from        + LIMIT      │
│   index O(log n)     avg_rating          parameters          + OFFSET     │
│                      has_medication                                        │
│                      delivery_eta                                          │
│                                                                              │
│  STEP 1: SPATIAL QUERY (Fast - uses index)                                 │
│  ─────────────────────────────────────────────────────────────────────────  │
│  SELECT * FROM pharmacies                                                   │
│  WHERE ST_DWithin(                                                          │
│    location::geography,                                                     │
│    ST_SetSRID(ST_MakePoint(:lng, :lat), 4326)::geography,                  │
│    :radius_meters                                                           │
│  )                                                                          │
│  AND status = 'ACTIVE'                                                      │
│                                                                              │
│  STEP 2: ENRICH WITH COMPUTED FIELDS                                       │
│  ─────────────────────────────────────────────────────────────────────────  │
│  • distance_meters: ST_Distance(location, user_point)                      │
│  • is_open: is_pharmacy_open(operating_hours, NOW())                       │
│  • closes_at: Extract from operating_hours for today                       │
│  • average_rating: From pharmacy_stats materialized view                   │
│  • has_medication: EXISTS check on pharmacy_inventory                      │
│  • delivery_eta: 15min + (distance/400)*60 + 30% buffer                   │
│  • is_duty_pharmacy: Check dutyPharmacy in operating_hours                │
│                                                                              │
│  STEP 3: APPLY USER FILTERS                                                │
│  ─────────────────────────────────────────────────────────────────────────  │
│  WHERE (p_is_open IS NULL OR is_open = p_is_open)                          │
│    AND (p_min_rating IS NULL OR average_rating >= p_min_rating)            │
│    AND (p_medication_id IS NULL OR has_medication = true)                  │
│                                                                              │
│  STEP 4: SORT AND PAGINATE                                                 │
│  ─────────────────────────────────────────────────────────────────────────  │
│  ORDER BY                                                                   │
│    -- Duty pharmacies first when filtering for open                        │
│    CASE WHEN p_is_open = true THEN is_duty_pharmacy END DESC NULLS LAST,  │
│    -- Then by user's sort preference                                       │
│    CASE WHEN sort = 'distance' THEN distance_meters END ASC,              │
│    CASE WHEN sort = 'rating' THEN average_rating END DESC NULLS LAST,     │
│    CASE WHEN sort = 'deliveryTime' THEN delivery_eta END ASC,             │
│    -- Always secondary sort by distance                                    │
│    distance_meters ASC                                                      │
│  LIMIT :limit OFFSET :offset                                                │
│                                                                              │
│  ADAPTIVE RADIUS EXPANSION                                                 │
│  ─────────────────────────────────────────────────────────────────────────  │
│  IF result_count < 3 AND current_radius < MAX_RADIUS:                      │
│    current_radius = current_radius * 2.5                                   │
│    RETRY from Step 1                                                        │
│                                                                              │
│  Expansion sequence: 2km → 5km → 12.5km → 25km (max)                      │
│                                                                              │
└─────────────────────────────────────────────────────────────────────────────┘
```

---

## DATABASE SCHEMA

### PostGIS Setup

```sql
-- ============================================================
-- PHARMACY DISCOVERY DATABASE SCHEMA
-- ============================================================

-- Enable PostGIS (Supabase has this available)
CREATE EXTENSION IF NOT EXISTS postgis;

-- Add geography column to pharmacies
-- GEOGRAPHY type uses meters and accounts for Earth's curvature
ALTER TABLE pharmacies 
ADD COLUMN IF NOT EXISTS location GEOGRAPHY(POINT, 4326);

-- Populate from existing lat/lng (one-time migration)
UPDATE pharmacies 
SET location = ST_SetSRID(ST_MakePoint(longitude, latitude), 4326)::geography
WHERE latitude IS NOT NULL 
  AND longitude IS NOT NULL
  AND location IS NULL;

-- GiST spatial index - makes ST_DWithin O(log n) instead of O(n)
CREATE INDEX IF NOT EXISTS idx_pharmacies_location_gist 
ON pharmacies USING GIST (location);

-- Trigger to keep location in sync with lat/lng updates
CREATE OR REPLACE FUNCTION sync_pharmacy_location()
RETURNS TRIGGER AS $$
BEGIN
  IF NEW.latitude IS NOT NULL AND NEW.longitude IS NOT NULL THEN
    NEW.location = ST_SetSRID(
      ST_MakePoint(NEW.longitude, NEW.latitude), 
      4326
    )::geography;
  END IF;
  RETURN NEW;
END;
$$ LANGUAGE plpgsql;

CREATE TRIGGER trg_pharmacy_location_sync
  BEFORE INSERT OR UPDATE OF latitude, longitude ON pharmacies
  FOR EACH ROW
  EXECUTE FUNCTION sync_pharmacy_location();
```

### Operating Hours Structure

```sql
-- Operating hours as JSONB for flexibility
-- This structure handles all Morocco-specific scenarios

/*
JSONB STRUCTURE SPECIFICATION:
{
  "timezone": "Africa/Casablanca",
  
  "regular": {
    "0": null,  // Sunday - closed (null = closed all day)
    "1": { 
      "open": "08:30", 
      "close": "20:00", 
      "breaks": [
        { "start": "13:00", "end": "15:00", "reason": "Pause déjeuner" }
      ]
    },
    "2": { "open": "08:30", "close": "20:00", "breaks": [...] },
    "3": { "open": "08:30", "close": "20:00", "breaks": [...] },
    "4": { "open": "08:30", "close": "20:00", "breaks": [...] },
    "5": { "open": "08:30", "close": "20:00", "breaks": [...] },
    "6": { "open": "09:00", "close": "13:00" }  // Saturday half-day
  },
  
  "dutyPharmacy": {
    // When this pharmacy is on garde duty - overrides everything
    "startDate": "2024-01-15",
    "endDate": "2024-01-21",
    "is24Hours": true,
    "source": "delegation_sante"  // Where we got this data
  },
  
  "ramadan": {
    // Special hours during Ramadan
    "year": 2024,
    "startDate": "2024-03-10",
    "endDate": "2024-04-09",
    "hours": {
      "1": { "open": "09:00", "close": "17:00", "breaks": [], 
             "evening": { "open": "21:00", "close": "00:00" } },
      // ... other days
    }
  },
  
  "closures": [
    // Planned closures
    { "date": "2024-07-30", "reason": "Fête du Trône", "type": "holiday" },
    { "date": "2024-11-06", "reason": "Marche Verte", "type": "holiday" },
    { "startDate": "2024-08-01", "endDate": "2024-08-15", 
      "reason": "Vacances annuelles", "type": "vacation" }
  ]
}
*/

-- Add operating hours column
ALTER TABLE pharmacies
ADD COLUMN IF NOT EXISTS operating_hours JSONB DEFAULT '{
  "timezone": "Africa/Casablanca",
  "regular": {},
  "dutyPharmacy": null,
  "ramadan": null,
  "closures": []
}'::jsonb;
```

### is_pharmacy_open() Function

```sql
-- ============================================================
-- IS_PHARMACY_OPEN FUNCTION
-- Evaluates all conditions in correct priority order
-- Returns: true if open, false if closed
-- ============================================================

CREATE OR REPLACE FUNCTION is_pharmacy_open(
  p_operating_hours JSONB,
  p_check_time TIMESTAMPTZ DEFAULT NOW()
) RETURNS BOOLEAN AS $$
DECLARE
  v_tz TEXT;
  v_local_time TIMESTAMPTZ;
  v_day_of_week INTEGER;
  v_current_time TIME;
  v_current_date DATE;
  v_day_hours JSONB;
  v_open_time TIME;
  v_close_time TIME;
  v_break JSONB;
  v_closure JSONB;
  v_ramadan JSONB;
BEGIN
  -- Get timezone (default to Morocco)
  v_tz := COALESCE(p_operating_hours->>'timezone', 'Africa/Casablanca');
  v_local_time := p_check_time AT TIME ZONE v_tz;
  v_day_of_week := EXTRACT(DOW FROM v_local_time);
  v_current_time := v_local_time::TIME;
  v_current_date := v_local_time::DATE;

  -- ══════════════════════════════════════════════════════════════
  -- PRIORITY 1: DUTY PHARMACY OVERRIDE (Highest priority)
  -- If pharmacy is on garde duty, it's open 24/7 regardless
  -- ══════════════════════════════════════════════════════════════
  IF p_operating_hours->'dutyPharmacy' IS NOT NULL 
     AND p_operating_hours->'dutyPharmacy' != 'null'::jsonb 
  THEN
    IF v_current_date >= (p_operating_hours->'dutyPharmacy'->>'startDate')::DATE
       AND v_current_date <= (p_operating_hours->'dutyPharmacy'->>'endDate')::DATE
    THEN
      RETURN TRUE;  -- On duty = always open
    END IF;
  END IF;

  -- ══════════════════════════════════════════════════════════════
  -- PRIORITY 2: SPECIAL CLOSURES
  -- Check holidays, vacations, renovations
  -- ══════════════════════════════════════════════════════════════
  IF p_operating_hours->'closures' IS NOT NULL THEN
    FOR v_closure IN SELECT * FROM jsonb_array_elements(p_operating_hours->'closures')
    LOOP
      -- Single day closure
      IF v_closure->>'date' IS NOT NULL THEN
        IF (v_closure->>'date')::DATE = v_current_date THEN
          RETURN FALSE;
        END IF;
      -- Date range closure
      ELSIF v_closure->>'startDate' IS NOT NULL THEN
        IF v_current_date >= (v_closure->>'startDate')::DATE
           AND v_current_date <= (v_closure->>'endDate')::DATE
        THEN
          RETURN FALSE;
        END IF;
      END IF;
    END LOOP;
  END IF;

  -- ══════════════════════════════════════════════════════════════
  -- PRIORITY 3: RAMADAN HOURS
  -- If currently Ramadan and special hours defined, use those
  -- ══════════════════════════════════════════════════════════════
  v_ramadan := p_operating_hours->'ramadan';
  IF v_ramadan IS NOT NULL 
     AND v_ramadan != 'null'::jsonb
     AND v_current_date >= (v_ramadan->>'startDate')::DATE
     AND v_current_date <= (v_ramadan->>'endDate')::DATE
  THEN
    v_day_hours := v_ramadan->'hours'->v_day_of_week::TEXT;
    IF v_day_hours IS NOT NULL AND v_day_hours != 'null'::jsonb THEN
      -- Check main hours
      v_open_time := (v_day_hours->>'open')::TIME;
      v_close_time := (v_day_hours->>'close')::TIME;
      IF v_current_time >= v_open_time AND v_current_time <= v_close_time THEN
        RETURN TRUE;
      END IF;
      -- Check evening hours (after iftar)
      IF v_day_hours->'evening' IS NOT NULL THEN
        v_open_time := (v_day_hours->'evening'->>'open')::TIME;
        v_close_time := (v_day_hours->'evening'->>'close')::TIME;
        IF v_current_time >= v_open_time OR v_current_time <= v_close_time THEN
          RETURN TRUE;
        END IF;
      END IF;
      RETURN FALSE;  -- Ramadan hours defined but not currently open
    END IF;
  END IF;

  -- ══════════════════════════════════════════════════════════════
  -- PRIORITY 4: REGULAR HOURS
  -- Standard day-of-week based hours
  -- ══════════════════════════════════════════════════════════════
  v_day_hours := p_operating_hours->'regular'->v_day_of_week::TEXT;
  
  -- Null means closed this day
  IF v_day_hours IS NULL OR v_day_hours = 'null'::jsonb THEN
    RETURN FALSE;
  END IF;

  v_open_time := (v_day_hours->>'open')::TIME;
  v_close_time := (v_day_hours->>'close')::TIME;

  -- Outside operating hours
  IF v_current_time < v_open_time OR v_current_time > v_close_time THEN
    RETURN FALSE;
  END IF;

  -- ══════════════════════════════════════════════════════════════
  -- PRIORITY 5: CHECK BREAKS
  -- Lunch break, prayer break, etc.
  -- ══════════════════════════════════════════════════════════════
  IF v_day_hours->'breaks' IS NOT NULL THEN
    FOR v_break IN SELECT * FROM jsonb_array_elements(v_day_hours->'breaks')
    LOOP
      IF v_current_time >= (v_break->>'start')::TIME 
         AND v_current_time <= (v_break->>'end')::TIME 
      THEN
        RETURN FALSE;  -- Currently on break
      END IF;
    END LOOP;
  END IF;

  -- All checks passed
  RETURN TRUE;
END;
$$ LANGUAGE plpgsql IMMUTABLE;

-- ============================================================
-- GET_CLOSING_TIME FUNCTION
-- Returns when pharmacy closes today (for UI display)
-- ============================================================

CREATE OR REPLACE FUNCTION get_pharmacy_closing_time(
  p_operating_hours JSONB,
  p_check_time TIMESTAMPTZ DEFAULT NOW()
) RETURNS TIME AS $$
DECLARE
  v_tz TEXT;
  v_local_time TIMESTAMPTZ;
  v_day_of_week INTEGER;
  v_day_hours JSONB;
BEGIN
  v_tz := COALESCE(p_operating_hours->>'timezone', 'Africa/Casablanca');
  v_local_time := p_check_time AT TIME ZONE v_tz;
  v_day_of_week := EXTRACT(DOW FROM v_local_time);

  -- Duty pharmacy = no closing time (24/7)
  IF p_operating_hours->'dutyPharmacy' IS NOT NULL 
     AND p_operating_hours->'dutyPharmacy' != 'null'::jsonb
     AND (v_local_time::DATE) >= (p_operating_hours->'dutyPharmacy'->>'startDate')::DATE
     AND (v_local_time::DATE) <= (p_operating_hours->'dutyPharmacy'->>'endDate')::DATE
  THEN
    RETURN NULL;  -- 24/7
  END IF;

  v_day_hours := p_operating_hours->'regular'->v_day_of_week::TEXT;
  
  IF v_day_hours IS NULL OR v_day_hours = 'null'::jsonb THEN
    RETURN NULL;
  END IF;

  RETURN (v_day_hours->>'close')::TIME;
END;
$$ LANGUAGE plpgsql IMMUTABLE;
```

### Pharmacy Stats View

```sql
-- Materialized view for pharmacy statistics
-- Refreshed periodically to avoid expensive JOINs on every search

CREATE MATERIALIZED VIEW IF NOT EXISTS pharmacy_stats AS
SELECT
  p.id as pharmacy_id,
  COUNT(DISTINCT o.id) as total_orders_90d,
  COUNT(DISTINCT o.id) FILTER (
    WHERE o.status = 'DELIVERED'
  ) as completed_orders_90d,
  COALESCE(AVG(pr.rating), 0)::DECIMAL(2,1) as average_rating,
  COUNT(DISTINCT pr.id) as review_count,
  COALESCE(
    PERCENTILE_CONT(0.5) WITHIN GROUP (
      ORDER BY EXTRACT(EPOCH FROM (o.ready_at - o.confirmed_at)) / 60
    ),
    15
  )::INTEGER as median_prep_minutes
FROM pharmacies p
LEFT JOIN orders o ON o.pharmacy_id = p.id 
  AND o.created_at > NOW() - INTERVAL '90 days'
LEFT JOIN pharmacy_reviews pr ON pr.pharmacy_id = p.id 
  AND pr.status = 'APPROVED'
WHERE p.status = 'ACTIVE'
GROUP BY p.id;

-- Unique index for fast lookups
CREATE UNIQUE INDEX IF NOT EXISTS idx_pharmacy_stats_id 
ON pharmacy_stats(pharmacy_id);

-- Refresh hourly (use pg_cron in production)
-- SELECT cron.schedule('refresh-pharmacy-stats', '0 * * * *', 
--   'REFRESH MATERIALIZED VIEW CONCURRENTLY pharmacy_stats');
```

### Main Search Function

```sql
-- ============================================================
-- SEARCH_PHARMACIES FUNCTION
-- Main entry point for pharmacy discovery
-- ============================================================

CREATE OR REPLACE FUNCTION search_pharmacies(
  p_lat DOUBLE PRECISION,
  p_lng DOUBLE PRECISION,
  p_radius_meters INTEGER DEFAULT 5000,
  p_is_open BOOLEAN DEFAULT NULL,
  p_medication_id UUID DEFAULT NULL,
  p_min_rating DECIMAL DEFAULT NULL,
  p_sort_by TEXT DEFAULT 'distance',
  p_limit INTEGER DEFAULT 20,
  p_offset INTEGER DEFAULT 0
) RETURNS TABLE (
  id UUID,
  name TEXT,
  address TEXT,
  city TEXT,
  phone TEXT,
  logo_url TEXT,
  latitude DOUBLE PRECISION,
  longitude DOUBLE PRECISION,
  distance_meters DOUBLE PRECISION,
  is_open BOOLEAN,
  closes_at TIME,
  is_duty_pharmacy BOOLEAN,
  average_rating DECIMAL,
  review_count BIGINT,
  estimated_delivery_minutes INTEGER,
  has_medication BOOLEAN,
  delivery_fee DECIMAL
) AS $$
DECLARE
  v_user_point GEOGRAPHY;
BEGIN
  -- Create user location point
  v_user_point := ST_SetSRID(ST_MakePoint(p_lng, p_lat), 4326)::geography;

  RETURN QUERY
  WITH nearby AS (
    -- Step 1: Spatial query using GiST index (fast)
    SELECT 
      ph.*,
      ST_Distance(ph.location, v_user_point) as dist
    FROM pharmacies ph
    WHERE ph.status = 'ACTIVE'
      AND ST_DWithin(ph.location, v_user_point, p_radius_meters)
  ),
  enriched AS (
    -- Step 2: Enrich with computed fields
    SELECT
      n.id,
      n.name,
      n.address,
      n.city,
      n.phone,
      n.logo_url,
      ST_Y(n.location::geometry) as latitude,
      ST_X(n.location::geometry) as longitude,
      n.dist as distance_meters,
      
      -- Open status
      is_pharmacy_open(n.operating_hours) as is_open,
      get_pharmacy_closing_time(n.operating_hours) as closes_at,
      
      -- Duty pharmacy check
      CASE
        WHEN n.operating_hours->'dutyPharmacy' IS NOT NULL 
             AND n.operating_hours->'dutyPharmacy' != 'null'::jsonb
             AND CURRENT_DATE >= (n.operating_hours->'dutyPharmacy'->>'startDate')::DATE
             AND CURRENT_DATE <= (n.operating_hours->'dutyPharmacy'->>'endDate')::DATE
        THEN TRUE
        ELSE FALSE
      END as is_duty_pharmacy,
      
      -- Stats from materialized view
      COALESCE(ps.average_rating, 0) as average_rating,
      COALESCE(ps.review_count, 0) as review_count,
      
      -- Delivery estimate: prep + travel + buffer
      -- Formula: 15min base + (distance_km / 25km/h * 60) * 1.3 buffer
      (15 + CEIL((n.dist / 1000.0) / 25.0 * 60.0 * 1.3))::INTEGER 
        as estimated_delivery_minutes,
      
      -- Medication availability check
      CASE 
        WHEN p_medication_id IS NULL THEN NULL::BOOLEAN
        ELSE EXISTS (
          SELECT 1 FROM pharmacy_inventory pi 
          WHERE pi.pharmacy_id = n.id 
            AND pi.medication_id = p_medication_id 
            AND pi.in_stock = true
        )
      END as has_medication,
      
      -- Delivery fee (simplified: base + per km)
      (10.0 + CEIL(n.dist / 1000.0) * 2.0)::DECIMAL as delivery_fee
      
    FROM nearby n
    LEFT JOIN pharmacy_stats ps ON ps.pharmacy_id = n.id
  )
  -- Step 3 & 4: Filter, sort, paginate
  SELECT e.*
  FROM enriched e
  WHERE
    (p_is_open IS NULL OR e.is_open = p_is_open)
    AND (p_min_rating IS NULL OR e.average_rating >= p_min_rating)
    AND (p_medication_id IS NULL OR e.has_medication = true)
  ORDER BY
    -- Duty pharmacies first when user wants open only
    CASE WHEN p_is_open = true THEN e.is_duty_pharmacy END DESC NULLS LAST,
    -- Sort by user preference
    CASE WHEN p_sort_by = 'distance' THEN e.distance_meters END ASC,
    CASE WHEN p_sort_by = 'rating' THEN e.average_rating END DESC NULLS LAST,
    CASE WHEN p_sort_by = 'delivery' THEN e.estimated_delivery_minutes END ASC,
    -- Secondary sort by distance
    e.distance_meters ASC
  LIMIT p_limit
  OFFSET p_offset;
END;
$$ LANGUAGE plpgsql STABLE;
```

---

## FRONTEND IMPLEMENTATION

### usePharmacySearch Hook

```typescript
// apps/patient/src/hooks/usePharmacySearch.ts

import { useInfiniteQuery, useQueryClient } from '@tanstack/react-query';
import { useMemo, useCallback, useEffect } from 'react';
import { getSupabaseClient } from '@/lib/supabase/client';
import { useGeolocation } from '@/hooks/useGeolocation';

// ═══════════════════════════════════════════════════════════════
// TYPES
// ═══════════════════════════════════════════════════════════════

export interface PharmacySearchFilters {
  isOpen: boolean | null;
  medicationId: string | null;
  minRating: number | null;
  maxDistance: number | null;
}

export type PharmacySortBy = 'distance' | 'rating' | 'delivery';

export interface PharmacyResult {
  id: string;
  name: string;
  address: string;
  city: string;
  phone: string;
  logoUrl: string | null;
  latitude: number;
  longitude: number;
  distanceMeters: number;
  isOpen: boolean;
  closesAt: string | null;
  isDutyPharmacy: boolean;
  averageRating: number;
  reviewCount: number;
  estimatedDeliveryMinutes: number;
  hasMedication: boolean | null;
  deliveryFee: number;
}

interface UsePharmacySearchOptions {
  filters?: Partial<PharmacySearchFilters>;
  sortBy?: PharmacySortBy;
  enabled?: boolean;
}

// ═══════════════════════════════════════════════════════════════
// CONSTANTS
// ═══════════════════════════════════════════════════════════════

const INITIAL_RADIUS = 5000;       // 5km
const MAX_RADIUS = 25000;          // 25km  
const MIN_RESULTS_THRESHOLD = 3;   // Expand if fewer
const PAGE_SIZE = 20;

// ═══════════════════════════════════════════════════════════════
// HOOK
// ═══════════════════════════════════════════════════════════════

export function usePharmacySearch(options: UsePharmacySearchOptions = {}) {
  const { 
    filters = {}, 
    sortBy = 'distance', 
    enabled = true 
  } = options;
  
  const supabase = getSupabaseClient();
  const queryClient = useQueryClient();
  
  // Get user location
  const { 
    location, 
    isLoading: isLoadingLocation, 
    error: locationError,
    retry: retryLocation 
  } = useGeolocation();

  // Calculate search radius
  const searchRadius = useMemo(() => {
    return filters.maxDistance || INITIAL_RADIUS;
  }, [filters.maxDistance]);

  // Query key
  const queryKey = useMemo(() => [
    'pharmacies',
    'search',
    {
      lat: location?.lat,
      lng: location?.lng,
      radius: searchRadius,
      ...filters,
      sortBy,
    }
  ], [location, searchRadius, filters, sortBy]);

  // Main search query with infinite pagination
  const query = useInfiniteQuery({
    queryKey,
    queryFn: async ({ pageParam = 0 }) => {
      if (!location) throw new Error('Location required');

      const { data, error } = await supabase.rpc('search_pharmacies', {
        p_lat: location.lat,
        p_lng: location.lng,
        p_radius_meters: searchRadius,
        p_is_open: filters.isOpen ?? null,
        p_medication_id: filters.medicationId ?? null,
        p_min_rating: filters.minRating ?? null,
        p_sort_by: sortBy,
        p_limit: PAGE_SIZE,
        p_offset: pageParam,
      });

      if (error) {
        console.error('[usePharmacySearch] RPC error:', error);
        throw error;
      }

      // Transform snake_case to camelCase
      return (data || []).map((p: any): PharmacyResult => ({
        id: p.id,
        name: p.name,
        address: p.address,
        city: p.city,
        phone: p.phone,
        logoUrl: p.logo_url,
        latitude: p.latitude,
        longitude: p.longitude,
        distanceMeters: p.distance_meters,
        isOpen: p.is_open,
        closesAt: p.closes_at,
        isDutyPharmacy: p.is_duty_pharmacy,
        averageRating: parseFloat(p.average_rating) || 0,
        reviewCount: parseInt(p.review_count) || 0,
        estimatedDeliveryMinutes: p.estimated_delivery_minutes,
        hasMedication: p.has_medication,
        deliveryFee: parseFloat(p.delivery_fee) || 0,
      }));
    },
    getNextPageParam: (lastPage, allPages) => {
      if (lastPage.length < PAGE_SIZE) return undefined;
      return allPages.flat().length;
    },
    initialPageParam: 0,
    enabled: enabled && !!location && !isLoadingLocation,
    staleTime: 2 * 60 * 1000,    // 2 minutes
    gcTime: 10 * 60 * 1000,      // 10 minutes
  });

  // Flatten all pages
  const pharmacies = useMemo(() => {
    return query.data?.pages.flat() ?? [];
  }, [query.data]);

  // Find duty pharmacy (if any)
  const dutyPharmacy = useMemo(() => {
    return pharmacies.find(p => p.isDutyPharmacy) ?? null;
  }, [pharmacies]);

  // Find nearest open pharmacy
  const nearestOpen = useMemo(() => {
    return pharmacies.find(p => p.isOpen) ?? null;
  }, [pharmacies]);

  // Prefetch pharmacy detail on hover
  const prefetchPharmacy = useCallback((pharmacyId: string) => {
    queryClient.prefetchQuery({
      queryKey: ['pharmacy', pharmacyId],
      queryFn: async () => {
        const { data } = await supabase
          .from('pharmacies')
          .select('*')
          .eq('id', pharmacyId)
          .single();
        return data;
      },
      staleTime: 5 * 60 * 1000,
    });
  }, [queryClient, supabase]);

  return {
    // Location
    location,
    isLoadingLocation,
    locationError,
    retryLocation,
    
    // Results
    pharmacies,
    dutyPharmacy,
    nearestOpen,
    totalCount: pharmacies.length,
    
    // Query state
    isLoading: query.isLoading || isLoadingLocation,
    isFetching: query.isFetching,
    isError: query.isError,
    error: query.error,
    
    // Pagination
    hasNextPage: query.hasNextPage,
    fetchNextPage: query.fetchNextPage,
    isFetchingNextPage: query.isFetchingNextPage,
    
    // Actions
    refetch: query.refetch,
    prefetchPharmacy,
  };
}
```

### useGeolocation Hook

```typescript
// apps/patient/src/hooks/useGeolocation.ts

import { useState, useEffect, useCallback, useRef } from 'react';

interface GeolocationState {
  location: { lat: number; lng: number } | null;
  isLoading: boolean;
  error: GeolocationError | null;
}

interface GeolocationError {
  code: 'PERMISSION_DENIED' | 'POSITION_UNAVAILABLE' | 'TIMEOUT' | 'NOT_SUPPORTED';
  message: string;
}

// Default to Casablanca city center if location unavailable
const DEFAULT_LOCATION = { lat: 33.5731, lng: -7.5898 };

export function useGeolocation() {
  const [state, setState] = useState<GeolocationState>({
    location: null,
    isLoading: true,
    error: null,
  });
  
  const watchIdRef = useRef<number | null>(null);
  const hasRequestedRef = useRef(false);

  const requestLocation = useCallback(() => {
    if (!navigator.geolocation) {
      setState({
        location: DEFAULT_LOCATION,
        isLoading: false,
        error: {
          code: 'NOT_SUPPORTED',
          message: 'La géolocalisation n\'est pas supportée par votre navigateur',
        },
      });
      return;
    }

    setState(prev => ({ ...prev, isLoading: true, error: null }));

    navigator.geolocation.getCurrentPosition(
      (position) => {
        setState({
          location: {
            lat: position.coords.latitude,
            lng: position.coords.longitude,
          },
          isLoading: false,
          error: null,
        });
      },
      (error) => {
        let errorInfo: GeolocationError;
        
        switch (error.code) {
          case error.PERMISSION_DENIED:
            errorInfo = {
              code: 'PERMISSION_DENIED',
              message: 'Veuillez autoriser l\'accès à votre position',
            };
            break;
          case error.POSITION_UNAVAILABLE:
            errorInfo = {
              code: 'POSITION_UNAVAILABLE',
              message: 'Position non disponible',
            };
            break;
          case error.TIMEOUT:
            errorInfo = {
              code: 'TIMEOUT',
              message: 'Délai d\'attente dépassé',
            };
            break;
          default:
            errorInfo = {
              code: 'POSITION_UNAVAILABLE',
              message: 'Erreur de géolocalisation',
            };
        }

        // Fall back to default location
        setState({
          location: DEFAULT_LOCATION,
          isLoading: false,
          error: errorInfo,
        });
      },
      {
        enableHighAccuracy: true,
        timeout: 10000,
        maximumAge: 60000, // Cache for 1 minute
      }
    );
  }, []);

  // Request on mount
  useEffect(() => {
    if (!hasRequestedRef.current) {
      hasRequestedRef.current = true;
      requestLocation();
    }
  }, [requestLocation]);

  return {
    ...state,
    retry: requestLocation,
  };
}
```

### PharmacyCard Component

```typescript
// apps/patient/src/components/features/pharmacies/pharmacy-card.tsx

'use client';

import Link from 'next/link';
import { MapPin, Star, Clock, Shield, Truck } from 'lucide-react';
import { PharmacyResult } from '@/hooks/usePharmacySearch';
import { cn } from '@/lib/utils';

interface PharmacyCardProps {
  pharmacy: PharmacyResult;
  onHover?: () => void;
}

export function PharmacyCard({ pharmacy, onHover }: PharmacyCardProps) {
  const formatDistance = (meters: number): string => {
    if (meters < 1000) return `${Math.round(meters)} m`;
    return `${(meters / 1000).toFixed(1)} km`;
  };

  const formatTime = (time: string | null): string => {
    if (!time) return '';
    return time.slice(0, 5); // "20:00:00" → "20:00"
  };

  return (
    <Link
      href={`/pharmacies/${pharmacy.id}`}
      onMouseEnter={onHover}
      className={cn(
        'block rounded-2xl bg-white border p-4 transition-all',
        'hover:shadow-lg hover:border-primary-200',
        pharmacy.isDutyPharmacy 
          ? 'border-purple-200 bg-gradient-to-br from-purple-50 to-white' 
          : 'border-gray-100'
      )}
    >
      <div className="flex gap-4">
        {/* Logo */}
        <div className="relative h-16 w-16 shrink-0 rounded-xl bg-gray-100 overflow-hidden">
          {pharmacy.logoUrl ? (
            <img 
              src={pharmacy.logoUrl} 
              alt="" 
              className="h-full w-full object-cover"
            />
          ) : (
            <div className="h-full w-full flex items-center justify-center">
              <span className="text-2xl font-bold text-gray-300">
                {pharmacy.name[0]}
              </span>
            </div>
          )}
          
          {/* Duty pharmacy badge */}
          {pharmacy.isDutyPharmacy && (
            <div className="absolute -top-1 -right-1 h-6 w-6 rounded-full bg-purple-500 
                          flex items-center justify-center shadow-md">
              <Shield className="h-3.5 w-3.5 text-white" />
            </div>
          )}
        </div>

        {/* Content */}
        <div className="flex-1 min-w-0">
          {/* Header row */}
          <div className="flex items-start justify-between gap-2">
            <div className="min-w-0">
              <h3 className="font-semibold text-gray-900 truncate">
                {pharmacy.name}
              </h3>
              <p className="text-sm text-gray-500 truncate">
                {pharmacy.address}
              </p>
            </div>
            
            {/* Open status badge */}
            <div className={cn(
              'shrink-0 rounded-full px-2.5 py-1 text-xs font-medium',
              pharmacy.isOpen 
                ? 'bg-green-100 text-green-700' 
                : 'bg-gray-100 text-gray-600'
            )}>
              {pharmacy.isOpen ? (
                pharmacy.closesAt 
                  ? `Ferme à ${formatTime(pharmacy.closesAt)}`
                  : pharmacy.isDutyPharmacy ? '24h/24' : 'Ouvert'
              ) : (
                'Fermé'
              )}
            </div>
          </div>

          {/* Stats row */}
          <div className="flex items-center gap-4 mt-2.5">
            {/* Distance */}
            <span className="flex items-center gap-1 text-sm text-gray-600">
              <MapPin className="h-3.5 w-3.5 text-gray-400" />
              {formatDistance(pharmacy.distanceMeters)}
            </span>
            
            {/* Rating */}
            <span className="flex items-center gap-1 text-sm text-gray-600">
              <Star className="h-3.5 w-3.5 text-amber-400 fill-amber-400" />
              <span className="font-medium">{pharmacy.averageRating.toFixed(1)}</span>
              <span className="text-gray-400">({pharmacy.reviewCount})</span>
            </span>
            
            {/* Delivery time */}
            <span className="flex items-center gap-1 text-sm text-gray-600">
              <Truck className="h-3.5 w-3.5 text-gray-400" />
              ~{pharmacy.estimatedDeliveryMinutes} min
            </span>
          </div>

          {/* Duty pharmacy label */}
          {pharmacy.isDutyPharmacy && (
            <div className="mt-2 inline-flex items-center gap-1.5 rounded-lg 
                          bg-purple-100 px-2 py-1 text-xs font-medium text-purple-700">
              <Shield className="h-3 w-3" />
              Pharmacie de garde
            </div>
          )}
        </div>
      </div>
    </Link>
  );
}
```

---

## SUCCESS CRITERIA

- [ ] PostGIS extension enabled with GEOGRAPHY type
- [ ] GiST spatial index on pharmacy locations
- [ ] `is_pharmacy_open()` handles all 5 priority levels correctly
- [ ] `search_pharmacies()` function with all filters and sorts
- [ ] Adaptive radius expansion (5km → 25km)
- [ ] Duty pharmacy detection and prioritization
- [ ] usePharmacySearch hook with infinite pagination
- [ ] useGeolocation hook with permission handling
- [ ] PharmacyCard component with all status badges
- [ ] "Open now" filter works correctly at any time
- [ ] Closing time displays accurately
- [ ] Location fallback to Casablanca if denied

---

## NEXT STEP

After validation passes, proceed to:
→ `dawa-docs/prompts/phase-1/P1.9-prescription-management.md`

Reference documentation:
→ `dawa-docs/docs/DAWA_MASTER.md`
→ `dawa-docs/docs/phases/PHASE_1.md`
