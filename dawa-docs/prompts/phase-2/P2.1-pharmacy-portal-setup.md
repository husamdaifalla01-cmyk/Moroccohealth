# P2.1 — Pharmacy Portal Setup (V100)

## Prompt ID: P2.1
## Phase: 2 - Pharmacy Portal
## Estimated Time: 6-8 hours
## Prerequisites: P1.12 complete, Phase 0 infrastructure

---

## STRATEGIC CONTEXT

### Why a Separate Portal?

```
┌─────────────────────────────────────────────────────────────────────────────┐
│                    PHARMACY PORTAL RATIONALE                                 │
├─────────────────────────────────────────────────────────────────────────────┤
│                                                                              │
│  WHY NOT JUST ADD PHARMACY FEATURES TO MAIN APP?                           │
│  ─────────────────────────────────────────────────────────────────────────   │
│                                                                              │
│  Different User Profiles:                                                   │
│  ┌─────────────────────────────────────────────────────────────────────┐   │
│  │  PATIENT                        │  PHARMACY STAFF                   │   │
│  │  • Mobile-first (70%+ mobile)   │  • Desktop-first (90%+ desktop)  │   │
│  │  • Occasional use (1-2x/month)  │  • All-day use (8+ hours)        │   │
│  │  • Simple flows (search→order)  │  • Complex workflows (queues)    │   │
│  │  • Consumer UX (simple, visual) │  • Professional UX (dense, fast) │   │
│  └─────────────────────────────────────────────────────────────────────┘   │
│                                                                              │
│  Different Technical Needs:                                                │
│  • Pharmacy needs real-time order queue (WebSocket-heavy)                 │
│  • Pharmacy needs bulk operations (batch inventory updates)               │
│  • Pharmacy needs printing (prescriptions, labels)                        │
│  • Pharmacy needs keyboard shortcuts (speed is critical)                  │
│                                                                              │
│  Security Separation:                                                      │
│  • Different RLS policies (pharmacy sees many patients' orders)          │
│  • Different authentication (email + possibly 2FA)                       │
│  • Audit logging for CNDP compliance                                     │
│                                                                              │
│  DECISION: Separate Next.js app at pharmacie.dawa.ma                      │
│                                                                              │
└─────────────────────────────────────────────────────────────────────────────┘
```

### Pharmacy User Personas

```
┌─────────────────────────────────────────────────────────────────────────────┐
│                    PHARMACY USER PERSONAS                                    │
├─────────────────────────────────────────────────────────────────────────────┤
│                                                                              │
│  PERSONA 1: PHARMACY OWNER (Pharmacien Titulaire)                          │
│  ─────────────────────────────────────────────────────────────────────────   │
│  Who: Licensed pharmacist who owns/manages the pharmacy                    │
│  Age: 35-55 typically                                                      │
│  Tech comfort: Medium (uses smartphone, basic computer)                    │
│                                                                              │
│  Primary concerns:                                                         │
│  • Business performance (revenue, order volume, ratings)                  │
│  • Legal compliance (prescription verification)                           │
│  • Staff management (who's doing what)                                    │
│  • Customer satisfaction (reviews, complaints)                            │
│                                                                              │
│  Portal usage:                                                             │
│  • Morning: Check overnight orders, review analytics                      │
│  • Throughout day: Spot-check important orders                           │
│  • Evening: Review day's performance, respond to reviews                 │
│                                                                              │
│  Role: OWNER (full access to everything)                                  │
│                                                                              │
│  PERSONA 2: PHARMACIST (Pharmacien Adjoint)                               │
│  ─────────────────────────────────────────────────────────────────────────   │
│  Who: Licensed pharmacist, employed by owner                              │
│  Age: 25-45 typically                                                      │
│  Tech comfort: Medium-High (digital native, uses apps)                    │
│                                                                              │
│  Primary concerns:                                                         │
│  • Prescription verification (legal responsibility)                       │
│  • Drug interactions (patient safety)                                     │
│  • Order accuracy (correct medications)                                   │
│  • Communication with patients (questions, clarifications)               │
│                                                                              │
│  Portal usage:                                                             │
│  • Constant: Reviewing prescriptions, approving orders                   │
│  • Frequent: Chatting with patients about medications                    │
│  • Occasional: Checking inventory for substitutions                      │
│                                                                              │
│  Role: PHARMACIST (orders, inventory, prescriptions, chat - no financials)│
│                                                                              │
│  PERSONA 3: PHARMACY TECHNICIAN (Préparateur)                             │
│  ─────────────────────────────────────────────────────────────────────────   │
│  Who: Non-licensed staff who prepares orders                              │
│  Age: 20-40 typically                                                      │
│  Tech comfort: High (younger, tech-savvy)                                 │
│                                                                              │
│  Primary concerns:                                                         │
│  • Order preparation speed (efficiency metrics)                           │
│  • Finding medications (inventory location)                               │
│  • Packaging correctly (labels, bags)                                     │
│  • Handoff to courier (verification)                                      │
│                                                                              │
│  Portal usage:                                                             │
│  • Constant: Processing order queue                                       │
│  • Frequent: Updating inventory (out of stock)                           │
│  • Occasional: Basic chat (order status questions)                       │
│                                                                              │
│  Role: TECHNICIAN (orders, inventory - no prescriptions, no financials)  │
│                                                                              │
└─────────────────────────────────────────────────────────────────────────────┘
```

### Permission Matrix

```
┌─────────────────────────────────────────────────────────────────────────────┐
│                    ROLE-BASED ACCESS CONTROL                                 │
├─────────────────────────────────────────────────────────────────────────────┤
│                                                                              │
│  Feature                      │ OWNER │ PHARMACIST │ TECHNICIAN             │
│  ────────────────────────────────────────────────────────────────────────   │
│  View order queue             │   ✓   │     ✓      │     ✓                  │
│  Accept/reject orders         │   ✓   │     ✓      │     ✓                  │
│  Update order status          │   ✓   │     ✓      │     ✓                  │
│  ────────────────────────────────────────────────────────────────────────   │
│  View prescriptions           │   ✓   │     ✓      │     ✗                  │
│  Verify prescriptions         │   ✓   │     ✓      │     ✗                  │
│  Flag prescription issues     │   ✓   │     ✓      │     ✗                  │
│  ────────────────────────────────────────────────────────────────────────   │
│  View inventory               │   ✓   │     ✓      │     ✓                  │
│  Update stock levels          │   ✓   │     ✓      │     ✓                  │
│  Bulk import inventory        │   ✓   │     ✗      │     ✗                  │
│  ────────────────────────────────────────────────────────────────────────   │
│  Chat with patients           │   ✓   │     ✓      │     ✓ (limited)       │
│  Chat with couriers           │   ✓   │     ✓      │     ✓                  │
│  ────────────────────────────────────────────────────────────────────────   │
│  View analytics/dashboard     │   ✓   │     ✓      │     ✗                  │
│  View financial reports       │   ✓   │     ✗      │     ✗                  │
│  Export reports               │   ✓   │     ✗      │     ✗                  │
│  ────────────────────────────────────────────────────────────────────────   │
│  Manage staff                 │   ✓   │     ✗      │     ✗                  │
│  Update pharmacy settings     │   ✓   │     ✗      │     ✗                  │
│  Update operating hours       │   ✓   │     ✗      │     ✗                  │
│  ────────────────────────────────────────────────────────────────────────   │
│                                                                              │
│  IMPLEMENTATION:                                                            │
│  • Store role in pharmacy_staff.role column                                │
│  • Check permissions on both frontend (UI) and backend (RLS)              │
│  • Create has_permission(pharmacy_id, user_id, permission) function       │
│                                                                              │
└─────────────────────────────────────────────────────────────────────────────┘
```

---

## PROJECT STRUCTURE

### Monorepo Addition

```
dawa/
├── apps/
│   ├── patient/          # Patient web app (existing)
│   ├── pharmacy/         # NEW: Pharmacy portal
│   │   ├── src/
│   │   │   ├── app/                 # Next.js App Router
│   │   │   │   ├── (auth)/          # Auth pages
│   │   │   │   │   ├── login/
│   │   │   │   │   └── layout.tsx
│   │   │   │   ├── (dashboard)/     # Main app
│   │   │   │   │   ├── orders/
│   │   │   │   │   ├── inventory/
│   │   │   │   │   ├── prescriptions/
│   │   │   │   │   ├── analytics/
│   │   │   │   │   ├── settings/
│   │   │   │   │   └── layout.tsx
│   │   │   │   ├── layout.tsx
│   │   │   │   └── page.tsx         # Redirect to /orders
│   │   │   ├── components/
│   │   │   │   ├── layout/          # Sidebar, Header, etc.
│   │   │   │   ├── orders/          # Order-specific components
│   │   │   │   ├── inventory/
│   │   │   │   └── ui/              # Shared UI (or from packages/ui)
│   │   │   ├── hooks/
│   │   │   ├── lib/
│   │   │   │   ├── auth/            # Pharmacy-specific auth
│   │   │   │   ├── permissions/     # RBAC helpers
│   │   │   │   └── supabase/
│   │   │   └── styles/
│   │   ├── public/
│   │   ├── next.config.js
│   │   ├── tailwind.config.js
│   │   ├── tsconfig.json
│   │   └── package.json
│   └── courier/          # Future: Courier app
├── packages/
│   ├── ui/               # Shared components
│   ├── services/         # Shared business logic
│   └── config/           # Shared configs
└── package.json
```

### Package Configuration

```json
// apps/pharmacy/package.json
{
  "name": "@dawa/pharmacy",
  "version": "0.1.0",
  "private": true,
  "scripts": {
    "dev": "next dev -p 3001",
    "build": "next build",
    "start": "next start -p 3001",
    "lint": "next lint",
    "typecheck": "tsc --noEmit"
  },
  "dependencies": {
    "@dawa/ui": "workspace:*",
    "@dawa/services": "workspace:*",
    "@supabase/supabase-js": "^2.39.0",
    "@supabase/ssr": "^0.1.0",
    "@tanstack/react-query": "^5.17.0",
    "@tanstack/react-table": "^8.11.0",
    "next": "14.0.4",
    "react": "^18.2.0",
    "react-dom": "^18.2.0",
    "framer-motion": "^10.18.0",
    "lucide-react": "^0.303.0",
    "date-fns": "^3.2.0",
    "zustand": "^4.4.0",
    "clsx": "^2.1.0",
    "tailwind-merge": "^2.2.0"
  },
  "devDependencies": {
    "@types/node": "^20.10.0",
    "@types/react": "^18.2.0",
    "@types/react-dom": "^18.2.0",
    "autoprefixer": "^10.4.16",
    "postcss": "^8.4.33",
    "tailwindcss": "^3.4.1",
    "typescript": "^5.3.0"
  }
}
```

### Next.js Configuration

```typescript
// apps/pharmacy/next.config.js

/** @type {import('next').NextConfig} */
const nextConfig = {
  reactStrictMode: true,
  transpilePackages: ['@dawa/ui', '@dawa/services'],
  
  // Enable standalone output for Docker deployment
  output: 'standalone',
  
  // Redirect root to orders (most common landing)
  async redirects() {
    return [
      {
        source: '/',
        destination: '/orders',
        permanent: false,
      },
    ];
  },
  
  // Headers for security
  async headers() {
    return [
      {
        source: '/:path*',
        headers: [
          {
            key: 'X-Frame-Options',
            value: 'DENY',
          },
          {
            key: 'X-Content-Type-Options',
            value: 'nosniff',
          },
          {
            key: 'Referrer-Policy',
            value: 'strict-origin-when-cross-origin',
          },
        ],
      },
    ];
  },

  // Environment variables
  env: {
    NEXT_PUBLIC_APP_NAME: 'DAWA Pharmacie',
    NEXT_PUBLIC_APP_URL: process.env.NEXT_PUBLIC_PHARMACY_URL || 'http://localhost:3001',
  },
};

module.exports = nextConfig;
```

### Tailwind Configuration

```typescript
// apps/pharmacy/tailwind.config.js

const sharedConfig = require('@dawa/config/tailwind.config');

/** @type {import('tailwindcss').Config} */
module.exports = {
  ...sharedConfig,
  content: [
    './src/**/*.{js,ts,jsx,tsx,mdx}',
    '../../packages/ui/src/**/*.{js,ts,jsx,tsx,mdx}',
  ],
  theme: {
    ...sharedConfig.theme,
    extend: {
      ...sharedConfig.theme?.extend,
      colors: {
        ...sharedConfig.theme?.extend?.colors,
        // Pharmacy-specific accent (professional blue)
        pharmacy: {
          50: '#eff6ff',
          100: '#dbeafe',
          200: '#bfdbfe',
          300: '#93c5fd',
          400: '#60a5fa',
          500: '#3b82f6',
          600: '#2563eb',
          700: '#1d4ed8',
          800: '#1e40af',
          900: '#1e3a8a',
        },
      },
    },
  },
};
```

---

## DATABASE SCHEMA

### Pharmacy Staff Management

```sql
-- ============================================================
-- PHARMACY STAFF & PERMISSIONS SCHEMA
-- ============================================================

-- Staff roles enum
CREATE TYPE pharmacy_staff_role AS ENUM ('OWNER', 'PHARMACIST', 'TECHNICIAN');

-- Pharmacy staff table
CREATE TABLE pharmacy_staff (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  
  -- Links
  pharmacy_id UUID NOT NULL REFERENCES pharmacies(id) ON DELETE CASCADE,
  user_id UUID NOT NULL REFERENCES users(id) ON DELETE CASCADE,
  
  -- Role & permissions
  role pharmacy_staff_role NOT NULL DEFAULT 'TECHNICIAN',
  custom_permissions JSONB DEFAULT '{}'::jsonb,
  
  -- Status
  status TEXT DEFAULT 'ACTIVE',  -- ACTIVE, INVITED, SUSPENDED
  invited_at TIMESTAMPTZ,
  invited_by UUID REFERENCES users(id),
  joined_at TIMESTAMPTZ,
  
  -- Metadata
  display_name TEXT,  -- Override user's name if needed
  
  created_at TIMESTAMPTZ DEFAULT NOW(),
  updated_at TIMESTAMPTZ DEFAULT NOW(),
  
  UNIQUE(pharmacy_id, user_id)
);

CREATE INDEX idx_pharmacy_staff_pharmacy ON pharmacy_staff(pharmacy_id, status);
CREATE INDEX idx_pharmacy_staff_user ON pharmacy_staff(user_id);

-- Permission definitions
CREATE TABLE permission_definitions (
  id TEXT PRIMARY KEY,
  name TEXT NOT NULL,
  description TEXT,
  category TEXT NOT NULL,  -- 'orders', 'inventory', 'prescriptions', 'analytics', 'settings'
  default_roles pharmacy_staff_role[] DEFAULT ARRAY['OWNER']::pharmacy_staff_role[]
);

-- Seed permissions
INSERT INTO permission_definitions (id, name, description, category, default_roles) VALUES
-- Orders
('orders.view', 'View Orders', 'View order queue and details', 'orders', 
 ARRAY['OWNER', 'PHARMACIST', 'TECHNICIAN']::pharmacy_staff_role[]),
('orders.manage', 'Manage Orders', 'Accept, reject, update status', 'orders', 
 ARRAY['OWNER', 'PHARMACIST', 'TECHNICIAN']::pharmacy_staff_role[]),
('orders.cancel', 'Cancel Orders', 'Cancel confirmed orders', 'orders', 
 ARRAY['OWNER', 'PHARMACIST']::pharmacy_staff_role[]),

-- Prescriptions
('prescriptions.view', 'View Prescriptions', 'View prescription images and data', 'prescriptions', 
 ARRAY['OWNER', 'PHARMACIST']::pharmacy_staff_role[]),
('prescriptions.verify', 'Verify Prescriptions', 'Approve or flag prescriptions', 'prescriptions', 
 ARRAY['OWNER', 'PHARMACIST']::pharmacy_staff_role[]),

-- Inventory
('inventory.view', 'View Inventory', 'View stock levels', 'inventory', 
 ARRAY['OWNER', 'PHARMACIST', 'TECHNICIAN']::pharmacy_staff_role[]),
('inventory.update', 'Update Inventory', 'Change stock levels and availability', 'inventory', 
 ARRAY['OWNER', 'PHARMACIST', 'TECHNICIAN']::pharmacy_staff_role[]),
('inventory.bulk', 'Bulk Import', 'Import inventory from CSV', 'inventory', 
 ARRAY['OWNER']::pharmacy_staff_role[]),

-- Analytics
('analytics.view', 'View Analytics', 'View dashboard and metrics', 'analytics', 
 ARRAY['OWNER', 'PHARMACIST']::pharmacy_staff_role[]),
('analytics.financials', 'View Financials', 'View revenue, payouts, fees', 'analytics', 
 ARRAY['OWNER']::pharmacy_staff_role[]),
('analytics.export', 'Export Reports', 'Download reports as CSV/PDF', 'analytics', 
 ARRAY['OWNER']::pharmacy_staff_role[]),

-- Settings
('settings.pharmacy', 'Pharmacy Settings', 'Update profile, hours, delivery zones', 'settings', 
 ARRAY['OWNER']::pharmacy_staff_role[]),
('settings.staff', 'Staff Management', 'Invite, manage, remove staff', 'settings', 
 ARRAY['OWNER']::pharmacy_staff_role[]),
('settings.integrations', 'Integrations', 'API keys, webhooks', 'settings', 
 ARRAY['OWNER']::pharmacy_staff_role[]);

-- Check permission function
CREATE OR REPLACE FUNCTION has_permission(
  p_pharmacy_id UUID,
  p_user_id UUID,
  p_permission_id TEXT
) RETURNS BOOLEAN AS $$
DECLARE
  v_staff pharmacy_staff%ROWTYPE;
  v_permission permission_definitions%ROWTYPE;
  v_has_custom BOOLEAN;
BEGIN
  -- Get staff record
  SELECT * INTO v_staff 
  FROM pharmacy_staff 
  WHERE pharmacy_id = p_pharmacy_id 
    AND user_id = p_user_id 
    AND status = 'ACTIVE';
  
  IF v_staff IS NULL THEN
    RETURN FALSE;
  END IF;
  
  -- Check custom permissions first (override)
  v_has_custom := v_staff.custom_permissions->p_permission_id;
  IF v_has_custom IS NOT NULL THEN
    RETURN v_has_custom;
  END IF;
  
  -- Check default role permissions
  SELECT * INTO v_permission 
  FROM permission_definitions 
  WHERE id = p_permission_id;
  
  IF v_permission IS NULL THEN
    RETURN FALSE;  -- Unknown permission
  END IF;
  
  RETURN v_staff.role = ANY(v_permission.default_roles);
END;
$$ LANGUAGE plpgsql SECURITY DEFINER;

-- Get user's pharmacy and role
CREATE OR REPLACE FUNCTION get_user_pharmacy_context(p_user_id UUID)
RETURNS TABLE (
  pharmacy_id UUID,
  pharmacy_name TEXT,
  role pharmacy_staff_role,
  permissions TEXT[]
) AS $$
BEGIN
  RETURN QUERY
  SELECT 
    ps.pharmacy_id,
    p.name as pharmacy_name,
    ps.role,
    ARRAY(
      SELECT pd.id 
      FROM permission_definitions pd 
      WHERE ps.role = ANY(pd.default_roles)
      UNION
      SELECT key 
      FROM jsonb_each(ps.custom_permissions) 
      WHERE value::boolean = true
    ) as permissions
  FROM pharmacy_staff ps
  JOIN pharmacies p ON p.id = ps.pharmacy_id
  WHERE ps.user_id = p_user_id
    AND ps.status = 'ACTIVE'
    AND p.status = 'ACTIVE';
END;
$$ LANGUAGE plpgsql SECURITY DEFINER;
```

### RLS Policies for Pharmacy Portal

```sql
-- ============================================================
-- ROW LEVEL SECURITY FOR PHARMACY PORTAL
-- ============================================================

-- Pharmacy staff can view their pharmacy's orders
CREATE POLICY pharmacy_view_orders ON orders
  FOR SELECT
  USING (
    pharmacy_id IN (
      SELECT pharmacy_id FROM pharmacy_staff 
      WHERE user_id = auth.uid() AND status = 'ACTIVE'
    )
  );

-- Pharmacy staff can update their pharmacy's orders
CREATE POLICY pharmacy_update_orders ON orders
  FOR UPDATE
  USING (
    pharmacy_id IN (
      SELECT pharmacy_id FROM pharmacy_staff 
      WHERE user_id = auth.uid() AND status = 'ACTIVE'
    )
    AND has_permission(pharmacy_id, auth.uid(), 'orders.manage')
  );

-- Only pharmacists can view prescriptions
CREATE POLICY pharmacy_view_prescriptions ON prescriptions
  FOR SELECT
  USING (
    id IN (
      SELECT oi.prescription_id 
      FROM order_items oi
      JOIN orders o ON o.id = oi.order_id
      WHERE o.pharmacy_id IN (
        SELECT pharmacy_id FROM pharmacy_staff 
        WHERE user_id = auth.uid() 
          AND status = 'ACTIVE'
          AND role IN ('OWNER', 'PHARMACIST')
      )
    )
  );

-- Inventory access
CREATE POLICY pharmacy_view_inventory ON pharmacy_inventory
  FOR SELECT
  USING (
    pharmacy_id IN (
      SELECT pharmacy_id FROM pharmacy_staff 
      WHERE user_id = auth.uid() AND status = 'ACTIVE'
    )
  );

CREATE POLICY pharmacy_update_inventory ON pharmacy_inventory
  FOR ALL
  USING (
    pharmacy_id IN (
      SELECT pharmacy_id FROM pharmacy_staff 
      WHERE user_id = auth.uid() AND status = 'ACTIVE'
    )
    AND has_permission(pharmacy_id, auth.uid(), 'inventory.update')
  );

-- Staff can view their pharmacy's other staff
CREATE POLICY pharmacy_view_staff ON pharmacy_staff
  FOR SELECT
  USING (
    pharmacy_id IN (
      SELECT pharmacy_id FROM pharmacy_staff 
      WHERE user_id = auth.uid() AND status = 'ACTIVE'
    )
  );

-- Only owners can manage staff
CREATE POLICY pharmacy_manage_staff ON pharmacy_staff
  FOR ALL
  USING (
    pharmacy_id IN (
      SELECT pharmacy_id FROM pharmacy_staff 
      WHERE user_id = auth.uid() 
        AND status = 'ACTIVE'
        AND role = 'OWNER'
    )
  );
```

---

## IMPLEMENTATION

### Auth Middleware

```typescript
// apps/pharmacy/src/middleware.ts

import { createServerClient, type CookieOptions } from '@supabase/ssr';
import { NextResponse, type NextRequest } from 'next/server';

export async function middleware(request: NextRequest) {
  let response = NextResponse.next({
    request: {
      headers: request.headers,
    },
  });

  const supabase = createServerClient(
    process.env.NEXT_PUBLIC_SUPABASE_URL!,
    process.env.NEXT_PUBLIC_SUPABASE_ANON_KEY!,
    {
      cookies: {
        get(name: string) {
          return request.cookies.get(name)?.value;
        },
        set(name: string, value: string, options: CookieOptions) {
          request.cookies.set({ name, value, ...options });
          response = NextResponse.next({
            request: { headers: request.headers },
          });
          response.cookies.set({ name, value, ...options });
        },
        remove(name: string, options: CookieOptions) {
          request.cookies.set({ name, value: '', ...options });
          response = NextResponse.next({
            request: { headers: request.headers },
          });
          response.cookies.set({ name, value: '', ...options });
        },
      },
    }
  );

  const { data: { session } } = await supabase.auth.getSession();

  // Public routes
  const publicRoutes = ['/login', '/forgot-password', '/reset-password'];
  const isPublicRoute = publicRoutes.some(route => 
    request.nextUrl.pathname.startsWith(route)
  );

  if (!session && !isPublicRoute) {
    const redirectUrl = new URL('/login', request.url);
    redirectUrl.searchParams.set('redirect', request.nextUrl.pathname);
    return NextResponse.redirect(redirectUrl);
  }

  if (session && isPublicRoute) {
    return NextResponse.redirect(new URL('/orders', request.url));
  }

  // If logged in, verify they have pharmacy access
  if (session && !isPublicRoute) {
    const { data: pharmacyContext } = await supabase
      .rpc('get_user_pharmacy_context', { p_user_id: session.user.id });

    if (!pharmacyContext || pharmacyContext.length === 0) {
      // User exists but not associated with any pharmacy
      return NextResponse.redirect(new URL('/login?error=no_pharmacy', request.url));
    }
  }

  return response;
}

export const config = {
  matcher: ['/((?!_next/static|_next/image|favicon.ico|.*\\..*).*)'],
};
```

### Pharmacy Context Provider

```typescript
// apps/pharmacy/src/lib/context/pharmacy-context.tsx

'use client';

import { createContext, useContext, useEffect, useState, ReactNode } from 'react';
import { getSupabaseClient } from '@/lib/supabase/client';

// ═══════════════════════════════════════════════════════════════
// TYPES
// ═══════════════════════════════════════════════════════════════

interface PharmacyContext {
  pharmacyId: string;
  pharmacyName: string;
  role: 'OWNER' | 'PHARMACIST' | 'TECHNICIAN';
  permissions: string[];
}

interface PharmacyContextValue {
  pharmacy: PharmacyContext | null;
  isLoading: boolean;
  hasPermission: (permission: string) => boolean;
  isOwner: boolean;
  isPharmacist: boolean;
  refresh: () => Promise<void>;
}

// ═══════════════════════════════════════════════════════════════
// CONTEXT
// ═══════════════════════════════════════════════════════════════

const PharmacyContext = createContext<PharmacyContextValue | null>(null);

export function PharmacyProvider({ children }: { children: ReactNode }) {
  const [pharmacy, setPharmacy] = useState<PharmacyContext | null>(null);
  const [isLoading, setIsLoading] = useState(true);
  const supabase = getSupabaseClient();

  const loadPharmacyContext = async () => {
    try {
      const { data: { user } } = await supabase.auth.getUser();
      if (!user) {
        setPharmacy(null);
        return;
      }

      const { data, error } = await supabase
        .rpc('get_user_pharmacy_context', { p_user_id: user.id });

      if (error) throw error;

      if (data && data.length > 0) {
        // For MVP, user belongs to one pharmacy
        const ctx = data[0];
        setPharmacy({
          pharmacyId: ctx.pharmacy_id,
          pharmacyName: ctx.pharmacy_name,
          role: ctx.role,
          permissions: ctx.permissions || [],
        });
      } else {
        setPharmacy(null);
      }
    } catch (error) {
      console.error('Failed to load pharmacy context:', error);
      setPharmacy(null);
    } finally {
      setIsLoading(false);
    }
  };

  useEffect(() => {
    loadPharmacyContext();

    const { data: { subscription } } = supabase.auth.onAuthStateChange(() => {
      loadPharmacyContext();
    });

    return () => subscription.unsubscribe();
  }, []);

  const hasPermission = (permission: string): boolean => {
    if (!pharmacy) return false;
    return pharmacy.permissions.includes(permission);
  };

  const value: PharmacyContextValue = {
    pharmacy,
    isLoading,
    hasPermission,
    isOwner: pharmacy?.role === 'OWNER',
    isPharmacist: pharmacy?.role === 'OWNER' || pharmacy?.role === 'PHARMACIST',
    refresh: loadPharmacyContext,
  };

  return (
    <PharmacyContext.Provider value={value}>
      {children}
    </PharmacyContext.Provider>
  );
}

export function usePharmacy() {
  const context = useContext(PharmacyContext);
  if (!context) {
    throw new Error('usePharmacy must be used within PharmacyProvider');
  }
  return context;
}
```

### Dashboard Layout

```typescript
// apps/pharmacy/src/app/(dashboard)/layout.tsx

import { PharmacyProvider } from '@/lib/context/pharmacy-context';
import { Sidebar } from '@/components/layout/sidebar';
import { Header } from '@/components/layout/header';

export default function DashboardLayout({
  children,
}: {
  children: React.ReactNode;
}) {
  return (
    <PharmacyProvider>
      <div className="flex h-screen bg-gray-50">
        <Sidebar />
        <div className="flex flex-1 flex-col overflow-hidden">
          <Header />
          <main className="flex-1 overflow-y-auto p-6">
            {children}
          </main>
        </div>
      </div>
    </PharmacyProvider>
  );
}
```

### Sidebar Component

```typescript
// apps/pharmacy/src/components/layout/sidebar.tsx

'use client';

import Link from 'next/link';
import { usePathname } from 'next/navigation';
import { 
  Package, BarChart3, ClipboardList, FileText, 
  Settings, Users, MessageSquare, LogOut, Pill
} from 'lucide-react';

import { usePharmacy } from '@/lib/context/pharmacy-context';
import { cn } from '@/lib/utils';

const navigation = [
  { 
    name: 'Commandes', 
    href: '/orders', 
    icon: Package,
    permission: 'orders.view',
  },
  { 
    name: 'Inventaire', 
    href: '/inventory', 
    icon: Pill,
    permission: 'inventory.view',
  },
  { 
    name: 'Ordonnances', 
    href: '/prescriptions', 
    icon: FileText,
    permission: 'prescriptions.view',
  },
  { 
    name: 'Messages', 
    href: '/messages', 
    icon: MessageSquare,
    permission: 'orders.view',  // Same as orders for now
  },
  { 
    name: 'Analytiques', 
    href: '/analytics', 
    icon: BarChart3,
    permission: 'analytics.view',
  },
  { 
    name: 'Équipe', 
    href: '/team', 
    icon: Users,
    permission: 'settings.staff',
  },
  { 
    name: 'Paramètres', 
    href: '/settings', 
    icon: Settings,
    permission: 'settings.pharmacy',
  },
];

export function Sidebar() {
  const pathname = usePathname();
  const { pharmacy, hasPermission, isLoading } = usePharmacy();

  if (isLoading) {
    return (
      <div className="flex h-full w-64 flex-col bg-white border-r border-gray-200">
        <div className="p-4">
          <div className="h-8 w-32 bg-gray-200 rounded animate-pulse" />
        </div>
      </div>
    );
  }

  const filteredNav = navigation.filter(item => hasPermission(item.permission));

  return (
    <div className="flex h-full w-64 flex-col bg-white border-r border-gray-200">
      {/* Logo */}
      <div className="flex h-16 items-center px-6 border-b border-gray-100">
        <Link href="/orders" className="flex items-center gap-2">
          <div className="h-8 w-8 rounded-lg bg-pharmacy-600 flex items-center justify-center">
            <Pill className="h-5 w-5 text-white" />
          </div>
          <span className="font-bold text-xl text-gray-900">DAWA</span>
          <span className="text-xs text-gray-400 font-medium">PRO</span>
        </Link>
      </div>

      {/* Pharmacy name */}
      <div className="px-4 py-3 border-b border-gray-100">
        <p className="text-sm font-medium text-gray-900 truncate">
          {pharmacy?.pharmacyName}
        </p>
        <p className="text-xs text-gray-500 capitalize">
          {pharmacy?.role.toLowerCase()}
        </p>
      </div>

      {/* Navigation */}
      <nav className="flex-1 overflow-y-auto p-4 space-y-1">
        {filteredNav.map((item) => {
          const isActive = pathname.startsWith(item.href);
          return (
            <Link
              key={item.name}
              href={item.href}
              className={cn(
                'flex items-center gap-3 rounded-lg px-3 py-2.5 text-sm font-medium transition-colors',
                isActive
                  ? 'bg-pharmacy-50 text-pharmacy-700'
                  : 'text-gray-600 hover:bg-gray-50 hover:text-gray-900'
              )}
            >
              <item.icon className={cn(
                'h-5 w-5',
                isActive ? 'text-pharmacy-600' : 'text-gray-400'
              )} />
              {item.name}
            </Link>
          );
        })}
      </nav>

      {/* Footer */}
      <div className="p-4 border-t border-gray-100">
        <button
          onClick={() => {/* Sign out logic */}}
          className="flex w-full items-center gap-3 rounded-lg px-3 py-2.5 text-sm font-medium text-gray-600 hover:bg-gray-50 hover:text-gray-900"
        >
          <LogOut className="h-5 w-5 text-gray-400" />
          Déconnexion
        </button>
      </div>
    </div>
  );
}
```

### Permission Guard Component

```typescript
// apps/pharmacy/src/components/guards/permission-guard.tsx

'use client';

import { ReactNode } from 'react';
import { ShieldX } from 'lucide-react';
import { usePharmacy } from '@/lib/context/pharmacy-context';

interface PermissionGuardProps {
  permission: string;
  children: ReactNode;
  fallback?: ReactNode;
}

export function PermissionGuard({ 
  permission, 
  children, 
  fallback 
}: PermissionGuardProps) {
  const { hasPermission, isLoading } = usePharmacy();

  if (isLoading) {
    return (
      <div className="flex items-center justify-center p-8">
        <div className="h-8 w-8 rounded-full border-2 border-pharmacy-600 border-t-transparent animate-spin" />
      </div>
    );
  }

  if (!hasPermission(permission)) {
    if (fallback) return <>{fallback}</>;
    
    return (
      <div className="flex flex-col items-center justify-center p-12 text-center">
        <div className="h-16 w-16 rounded-full bg-red-100 flex items-center justify-center mb-4">
          <ShieldX className="h-8 w-8 text-red-600" />
        </div>
        <h3 className="text-lg font-semibold text-gray-900 mb-2">
          Accès non autorisé
        </h3>
        <p className="text-gray-500 max-w-sm">
          Vous n'avez pas la permission d'accéder à cette fonctionnalité. 
          Contactez le propriétaire de la pharmacie pour modifier vos droits.
        </p>
      </div>
    );
  }

  return <>{children}</>;
}

// Usage example:
// <PermissionGuard permission="analytics.financials">
//   <FinancialReport />
// </PermissionGuard>
```

---

## SUCCESS CRITERIA

- [ ] Separate Next.js app at `apps/pharmacy` in monorepo
- [ ] Desktop-first responsive design
- [ ] Authentication with email/password
- [ ] PharmacyProvider with role and permissions context
- [ ] RBAC with OWNER, PHARMACIST, TECHNICIAN roles
- [ ] has_permission() database function
- [ ] RLS policies for pharmacy-specific data access
- [ ] Sidebar navigation filtered by permissions
- [ ] PermissionGuard component for UI protection
- [ ] Redirect non-pharmacy users appropriately
- [ ] Shared packages integration (@dawa/ui, @dawa/services)

---

## NEXT PROMPT

Proceed to **P2.2 - Order Queue Management** for real-time order handling.
