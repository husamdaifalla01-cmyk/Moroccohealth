# P0.7 — Environment Configuration

## Prompt ID: P0.7
## Phase: 0 - Foundation
## Estimated Time: 2-3 hours
## Prerequisites: P0.1-P0.6 complete

---

## CONTEXT

You are setting up environment configuration for the DAWA.ma monorepo. With multiple apps sharing services (Supabase, SMS providers, payment gateways), environment management must be:

1. **Secure** — No secrets in code or version control
2. **Validated** — Apps fail fast if required vars missing
3. **Typed** — TypeScript knows about env vars
4. **Hierarchical** — Shared vars + app-specific overrides

---

## ENVIRONMENT STRUCTURE

```
dawa/
├── .env.example              # Template for all vars (committed)
├── .env                      # Local overrides (gitignored)
├── packages/
│   └── env/                  # @dawa/env - Validation package
├── apps/
│   ├── patient/
│   │   ├── .env.local        # App-specific (gitignored)
│   │   └── env.ts            # Type-safe access
│   ├── pharmacy/
│   │   ├── .env.local
│   │   └── env.ts
│   └── courier/
│       ├── .env.local
│       └── env.ts
```

---

## IMPLEMENTATION STEPS

### Step 1: Root Environment Template

Create `.env.example` at project root:

```bash
# ============================================================
# DAWA.ma Environment Configuration Template
# Copy to .env and fill in values
# ============================================================

# ===================
# SUPABASE
# ===================
NEXT_PUBLIC_SUPABASE_URL=https://your-project.supabase.co
NEXT_PUBLIC_SUPABASE_ANON_KEY=your-anon-key
SUPABASE_SERVICE_ROLE_KEY=your-service-role-key
SUPABASE_JWT_SECRET=your-jwt-secret

# ===================
# SMS PROVIDERS
# ===================
# Choose one: twilio | infobip
SMS_PROVIDER=twilio

# Twilio (if SMS_PROVIDER=twilio)
TWILIO_ACCOUNT_SID=
TWILIO_AUTH_TOKEN=
TWILIO_PHONE_NUMBER=+1234567890

# Infobip (if SMS_PROVIDER=infobip)
INFOBIP_API_KEY=
INFOBIP_SENDER_ID=DAWA

# ===================
# PAYMENT (CMI Morocco)
# ===================
CMI_MERCHANT_ID=
CMI_STORE_KEY=
CMI_API_URL=https://testpayment.cmi.co.ma
CMI_CALLBACK_URL=https://api.dawa.ma/webhooks/cmi

# ===================
# MAPS
# ===================
NEXT_PUBLIC_GOOGLE_MAPS_KEY=
NEXT_PUBLIC_MAPBOX_TOKEN=

# ===================
# STORAGE
# ===================
# Supabase Storage is used by default
# R2 for production (optional)
R2_ACCOUNT_ID=
R2_ACCESS_KEY_ID=
R2_SECRET_ACCESS_KEY=
R2_BUCKET_NAME=dawa-uploads

# ===================
# MONITORING
# ===================
SENTRY_DSN=
SENTRY_AUTH_TOKEN=

# ===================
# FEATURE FLAGS
# ===================
NEXT_PUBLIC_ENABLE_INSURANCE=false
NEXT_PUBLIC_ENABLE_WALLET=false
NEXT_PUBLIC_ENABLE_CHAT=true
NEXT_PUBLIC_MAINTENANCE_MODE=false

# ===================
# APP URLS
# ===================
NEXT_PUBLIC_PATIENT_URL=http://localhost:3000
NEXT_PUBLIC_PHARMACY_URL=http://localhost:3001
NEXT_PUBLIC_COURIER_URL=http://localhost:3002
NEXT_PUBLIC_ADMIN_URL=http://localhost:3003

# ===================
# API
# ===================
API_SECRET_KEY=generate-a-secure-random-string
ENCRYPTION_KEY=32-char-encryption-key-here!!!!

# ===================
# DEVELOPMENT
# ===================
NODE_ENV=development
DEBUG=false
```

### Step 2: Environment Validation Package

Create `packages/env/src/index.ts`:

```typescript
// ============================================================
// @dawa/env - Environment Variable Validation
// ============================================================

import { z } from 'zod';

/**
 * Shared environment variables (used by all apps)
 */
const sharedEnvSchema = z.object({
  // Supabase
  NEXT_PUBLIC_SUPABASE_URL: z.string().url(),
  NEXT_PUBLIC_SUPABASE_ANON_KEY: z.string().min(1),
  
  // Feature flags
  NEXT_PUBLIC_ENABLE_INSURANCE: z.coerce.boolean().default(false),
  NEXT_PUBLIC_ENABLE_WALLET: z.coerce.boolean().default(false),
  NEXT_PUBLIC_ENABLE_CHAT: z.coerce.boolean().default(true),
  NEXT_PUBLIC_MAINTENANCE_MODE: z.coerce.boolean().default(false),
  
  // App URLs
  NEXT_PUBLIC_PATIENT_URL: z.string().url().optional(),
  NEXT_PUBLIC_PHARMACY_URL: z.string().url().optional(),
  NEXT_PUBLIC_COURIER_URL: z.string().url().optional(),
  
  // Maps
  NEXT_PUBLIC_GOOGLE_MAPS_KEY: z.string().optional(),
  NEXT_PUBLIC_MAPBOX_TOKEN: z.string().optional(),
  
  // Runtime
  NODE_ENV: z.enum(['development', 'test', 'production']).default('development'),
});

/**
 * Server-only environment variables
 */
const serverEnvSchema = z.object({
  // Supabase admin
  SUPABASE_SERVICE_ROLE_KEY: z.string().min(1),
  SUPABASE_JWT_SECRET: z.string().min(1).optional(),
  
  // SMS
  SMS_PROVIDER: z.enum(['twilio', 'infobip']).default('twilio'),
  TWILIO_ACCOUNT_SID: z.string().optional(),
  TWILIO_AUTH_TOKEN: z.string().optional(),
  TWILIO_PHONE_NUMBER: z.string().optional(),
  INFOBIP_API_KEY: z.string().optional(),
  INFOBIP_SENDER_ID: z.string().optional(),
  
  // Payment
  CMI_MERCHANT_ID: z.string().optional(),
  CMI_STORE_KEY: z.string().optional(),
  CMI_API_URL: z.string().url().optional(),
  CMI_CALLBACK_URL: z.string().url().optional(),
  
  // Storage
  R2_ACCOUNT_ID: z.string().optional(),
  R2_ACCESS_KEY_ID: z.string().optional(),
  R2_SECRET_ACCESS_KEY: z.string().optional(),
  R2_BUCKET_NAME: z.string().optional(),
  
  // Monitoring
  SENTRY_DSN: z.string().optional(),
  SENTRY_AUTH_TOKEN: z.string().optional(),
  
  // Security
  API_SECRET_KEY: z.string().min(32),
  ENCRYPTION_KEY: z.string().length(32),
});

/**
 * Validate and export shared (client-safe) environment
 */
export function validateSharedEnv() {
  const parsed = sharedEnvSchema.safeParse({
    NEXT_PUBLIC_SUPABASE_URL: process.env.NEXT_PUBLIC_SUPABASE_URL,
    NEXT_PUBLIC_SUPABASE_ANON_KEY: process.env.NEXT_PUBLIC_SUPABASE_ANON_KEY,
    NEXT_PUBLIC_ENABLE_INSURANCE: process.env.NEXT_PUBLIC_ENABLE_INSURANCE,
    NEXT_PUBLIC_ENABLE_WALLET: process.env.NEXT_PUBLIC_ENABLE_WALLET,
    NEXT_PUBLIC_ENABLE_CHAT: process.env.NEXT_PUBLIC_ENABLE_CHAT,
    NEXT_PUBLIC_MAINTENANCE_MODE: process.env.NEXT_PUBLIC_MAINTENANCE_MODE,
    NEXT_PUBLIC_PATIENT_URL: process.env.NEXT_PUBLIC_PATIENT_URL,
    NEXT_PUBLIC_PHARMACY_URL: process.env.NEXT_PUBLIC_PHARMACY_URL,
    NEXT_PUBLIC_COURIER_URL: process.env.NEXT_PUBLIC_COURIER_URL,
    NEXT_PUBLIC_GOOGLE_MAPS_KEY: process.env.NEXT_PUBLIC_GOOGLE_MAPS_KEY,
    NEXT_PUBLIC_MAPBOX_TOKEN: process.env.NEXT_PUBLIC_MAPBOX_TOKEN,
    NODE_ENV: process.env.NODE_ENV,
  });

  if (!parsed.success) {
    console.error('❌ Invalid environment variables:');
    console.error(parsed.error.flatten().fieldErrors);
    throw new Error('Invalid environment configuration');
  }

  return parsed.data;
}

/**
 * Validate and export server environment (never expose to client)
 */
export function validateServerEnv() {
  // Server-side only check
  if (typeof window !== 'undefined') {
    throw new Error('Server env cannot be accessed on client');
  }

  const parsed = serverEnvSchema.safeParse({
    SUPABASE_SERVICE_ROLE_KEY: process.env.SUPABASE_SERVICE_ROLE_KEY,
    SUPABASE_JWT_SECRET: process.env.SUPABASE_JWT_SECRET,
    SMS_PROVIDER: process.env.SMS_PROVIDER,
    TWILIO_ACCOUNT_SID: process.env.TWILIO_ACCOUNT_SID,
    TWILIO_AUTH_TOKEN: process.env.TWILIO_AUTH_TOKEN,
    TWILIO_PHONE_NUMBER: process.env.TWILIO_PHONE_NUMBER,
    INFOBIP_API_KEY: process.env.INFOBIP_API_KEY,
    INFOBIP_SENDER_ID: process.env.INFOBIP_SENDER_ID,
    CMI_MERCHANT_ID: process.env.CMI_MERCHANT_ID,
    CMI_STORE_KEY: process.env.CMI_STORE_KEY,
    CMI_API_URL: process.env.CMI_API_URL,
    CMI_CALLBACK_URL: process.env.CMI_CALLBACK_URL,
    R2_ACCOUNT_ID: process.env.R2_ACCOUNT_ID,
    R2_ACCESS_KEY_ID: process.env.R2_ACCESS_KEY_ID,
    R2_SECRET_ACCESS_KEY: process.env.R2_SECRET_ACCESS_KEY,
    R2_BUCKET_NAME: process.env.R2_BUCKET_NAME,
    SENTRY_DSN: process.env.SENTRY_DSN,
    SENTRY_AUTH_TOKEN: process.env.SENTRY_AUTH_TOKEN,
    API_SECRET_KEY: process.env.API_SECRET_KEY,
    ENCRYPTION_KEY: process.env.ENCRYPTION_KEY,
  });

  if (!parsed.success) {
    console.error('❌ Invalid server environment variables:');
    console.error(parsed.error.flatten().fieldErrors);
    throw new Error('Invalid server environment configuration');
  }

  // Validate SMS provider config
  const data = parsed.data;
  if (data.SMS_PROVIDER === 'twilio') {
    if (!data.TWILIO_ACCOUNT_SID || !data.TWILIO_AUTH_TOKEN) {
      throw new Error('Twilio credentials required when SMS_PROVIDER=twilio');
    }
  } else if (data.SMS_PROVIDER === 'infobip') {
    if (!data.INFOBIP_API_KEY) {
      throw new Error('Infobip API key required when SMS_PROVIDER=infobip');
    }
  }

  return data;
}

// Type exports for TypeScript
export type SharedEnv = ReturnType<typeof validateSharedEnv>;
export type ServerEnv = ReturnType<typeof validateServerEnv>;
```

### Step 3: App-Specific Environment Files

Create `apps/patient/src/env.ts`:

```typescript
// ============================================================
// Patient App Environment Configuration
// ============================================================

import { validateSharedEnv, validateServerEnv } from '@dawa/env';

// Validate on import (fails fast)
export const sharedEnv = validateSharedEnv();

// Server env only available in server components/routes
export const getServerEnv = () => {
  if (typeof window !== 'undefined') {
    throw new Error('Server env accessed on client');
  }
  return validateServerEnv();
};

// Type-safe env access
export const env = {
  // Supabase
  supabase: {
    url: sharedEnv.NEXT_PUBLIC_SUPABASE_URL,
    anonKey: sharedEnv.NEXT_PUBLIC_SUPABASE_ANON_KEY,
  },
  
  // Feature flags
  features: {
    insurance: sharedEnv.NEXT_PUBLIC_ENABLE_INSURANCE,
    wallet: sharedEnv.NEXT_PUBLIC_ENABLE_WALLET,
    chat: sharedEnv.NEXT_PUBLIC_ENABLE_CHAT,
    maintenance: sharedEnv.NEXT_PUBLIC_MAINTENANCE_MODE,
  },
  
  // Maps
  maps: {
    googleKey: sharedEnv.NEXT_PUBLIC_GOOGLE_MAPS_KEY,
    mapboxToken: sharedEnv.NEXT_PUBLIC_MAPBOX_TOKEN,
  },
  
  // Runtime
  isDev: sharedEnv.NODE_ENV === 'development',
  isProd: sharedEnv.NODE_ENV === 'production',
  isTest: sharedEnv.NODE_ENV === 'test',
};
```

Create `apps/pharmacy/src/env.ts`:

```typescript
// ============================================================
// Pharmacy Portal Environment Configuration
// ============================================================

import { validateSharedEnv, validateServerEnv } from '@dawa/env';
import { z } from 'zod';

// Pharmacy-specific env vars
const pharmacyEnvSchema = z.object({
  // Analytics
  NEXT_PUBLIC_ANALYTICS_ID: z.string().optional(),
  
  // Default pharmacy settings
  DEFAULT_COMMISSION_RATE: z.coerce.number().default(10),
  DEFAULT_DELIVERY_RADIUS_KM: z.coerce.number().default(5),
});

// Validate shared + pharmacy-specific
export const sharedEnv = validateSharedEnv();

const pharmacyParsed = pharmacyEnvSchema.safeParse({
  NEXT_PUBLIC_ANALYTICS_ID: process.env.NEXT_PUBLIC_ANALYTICS_ID,
  DEFAULT_COMMISSION_RATE: process.env.DEFAULT_COMMISSION_RATE,
  DEFAULT_DELIVERY_RADIUS_KM: process.env.DEFAULT_DELIVERY_RADIUS_KM,
});

if (!pharmacyParsed.success) {
  console.error('Invalid pharmacy env:', pharmacyParsed.error.flatten());
  throw new Error('Invalid pharmacy environment');
}

export const pharmacyEnv = pharmacyParsed.data;

// Server env getter
export const getServerEnv = () => {
  if (typeof window !== 'undefined') {
    throw new Error('Server env accessed on client');
  }
  return validateServerEnv();
};

// Combined typed env
export const env = {
  supabase: {
    url: sharedEnv.NEXT_PUBLIC_SUPABASE_URL,
    anonKey: sharedEnv.NEXT_PUBLIC_SUPABASE_ANON_KEY,
  },
  features: {
    insurance: sharedEnv.NEXT_PUBLIC_ENABLE_INSURANCE,
    chat: sharedEnv.NEXT_PUBLIC_ENABLE_CHAT,
  },
  pharmacy: {
    analyticsId: pharmacyEnv.NEXT_PUBLIC_ANALYTICS_ID,
    defaultCommission: pharmacyEnv.DEFAULT_COMMISSION_RATE,
    defaultRadius: pharmacyEnv.DEFAULT_DELIVERY_RADIUS_KM,
  },
  isDev: sharedEnv.NODE_ENV === 'development',
  isProd: sharedEnv.NODE_ENV === 'production',
};
```

### Step 4: Next.js Configuration

Update `apps/patient/next.config.js`:

```javascript
/** @type {import('next').NextConfig} */
const nextConfig = {
  // Transpile shared packages
  transpilePackages: [
    '@dawa/ui',
    '@dawa/types',
    '@dawa/utils',
    '@dawa/validation',
    '@dawa/env',
  ],
  
  // Environment validation at build time
  env: {
    // These are validated by @dawa/env
  },
  
  // Strict mode
  reactStrictMode: true,
  
  // Image optimization
  images: {
    remotePatterns: [
      {
        protocol: 'https',
        hostname: '*.supabase.co',
      },
      {
        protocol: 'https',
        hostname: 'r2.dawa.ma',
      },
    ],
  },
  
  // Headers for security
  async headers() {
    return [
      {
        source: '/:path*',
        headers: [
          {
            key: 'X-Frame-Options',
            value: 'DENY',
          },
          {
            key: 'X-Content-Type-Options',
            value: 'nosniff',
          },
          {
            key: 'Referrer-Policy',
            value: 'strict-origin-when-cross-origin',
          },
        ],
      },
    ];
  },
};

module.exports = nextConfig;
```

### Step 5: Turborepo Environment Handling

Update `turbo.json`:

```json
{
  "$schema": "https://turbo.build/schema.json",
  "globalDependencies": [".env"],
  "globalEnv": [
    "NODE_ENV",
    "NEXT_PUBLIC_SUPABASE_URL",
    "NEXT_PUBLIC_SUPABASE_ANON_KEY",
    "NEXT_PUBLIC_ENABLE_*",
    "NEXT_PUBLIC_GOOGLE_MAPS_KEY",
    "NEXT_PUBLIC_MAPBOX_TOKEN"
  ],
  "pipeline": {
    "build": {
      "dependsOn": ["^build"],
      "env": [
        "SUPABASE_SERVICE_ROLE_KEY",
        "API_SECRET_KEY",
        "SENTRY_DSN"
      ],
      "outputs": [".next/**", "!.next/cache/**", "dist/**"]
    },
    "dev": {
      "cache": false,
      "persistent": true
    },
    "lint": {},
    "typecheck": {}
  }
}
```

### Step 6: Git Ignore Pattern

Ensure `.gitignore` includes:

```gitignore
# Environment files
.env
.env.local
.env.*.local
*.env

# Keep example
!.env.example

# Secrets
secrets/
*.pem
*.key
```

---

## ENVIRONMENT LOADING ORDER

Next.js loads environment files in this order (later overrides earlier):

1. `.env` (root)
2. `.env.local` (root, gitignored)
3. `.env.development` / `.env.production` (per NODE_ENV)
4. `apps/*/env.local` (per-app overrides)

---

## VALIDATION FLOW

```
App Start
    │
    ▼
validateSharedEnv()
    │
    ├── Success → Continue
    │
    └── Fail → Throw Error (lists missing vars)
    
Server Route
    │
    ▼
getServerEnv()
    │
    ├── Success → Return typed env
    │
    └── Fail → 500 Error
```

---

## SUCCESS CRITERIA

- [ ] All apps validate env on startup
- [ ] Missing vars cause immediate, descriptive errors
- [ ] Server vars never leak to client
- [ ] TypeScript knows all env var types
- [ ] `.env.example` documents all vars
- [ ] Turborepo passes required vars to tasks

---

## NEXT STEP

After validation passes, proceed to:
→ `dawa-docs/prompts/phase-0/P0.8-development-workflow-setup.md`

Reference documentation:
→ `dawa-docs/docs/DAWA_MASTER.md`
