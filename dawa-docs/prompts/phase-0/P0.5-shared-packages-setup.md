# P0.5 — Shared Packages Setup

## Prompt ID: P0.5
## Phase: 0 - Foundation
## Estimated Time: 5-6 hours
## Prerequisites: P0.1-P0.4 complete

---

## CONTEXT

You are creating the shared packages that power all DAWA.ma applications. These packages embody the **Product Excellence** principles and **Generative Artist** aesthetics that differentiate DAWA from generic solutions.

Each package serves a specific purpose:
- `@dawa/ui` — Premium UI components with depth and lighting
- `@dawa/utils` — Formatting, dates, and helper functions
- `@dawa/shared` — Business logic (pricing, validation rules)
- `@dawa/supabase` — Database client configuration
- `@dawa/validation` — Zod schemas for forms

---

## PACKAGE: @dawa/ui

### Design Philosophy

From **Generative Artist** skill:
> "You're not drawing shadows. You're drawing where light ISN'T."

Every component should feel **touchable** — not flat rectangles with effects, but surfaces in 3D space responding to light.

### Color System

Create `packages/ui/src/tokens/colors.ts`:

```typescript
// ============================================================
// DAWA Color System
// Inspired by Moroccan aesthetics + medical trust
// ============================================================

export const colors = {
  // Primary - Teal (medical trust + Moroccan tiles)
  primary: {
    50: '#f0fdfa',
    100: '#ccfbf1',
    200: '#99f6e4',
    300: '#5eead4',
    400: '#2dd4bf',
    500: '#14b8a6',   // Main
    600: '#0d9488',
    700: '#0f766e',
    800: '#115e59',
    900: '#134e4a',
    950: '#042f2e',
  },
  
  // Secondary - Warm Sand (Moroccan desert)
  secondary: {
    50: '#fefce8',
    100: '#fef9c3',
    200: '#fef08a',
    300: '#fde047',
    400: '#facc15',
    500: '#eab308',
    600: '#ca8a04',
    700: '#a16207',
    800: '#854d0e',
    900: '#713f12',
    950: '#422006',
  },
  
  // Accent - Royal Blue (Moroccan craftsmanship)
  accent: {
    50: '#eff6ff',
    100: '#dbeafe',
    200: '#bfdbfe',
    300: '#93c5fd',
    400: '#60a5fa',
    500: '#3b82f6',
    600: '#2563eb',
    700: '#1d4ed8',
    800: '#1e40af',
    900: '#1e3a8a',
    950: '#172554',
  },
  
  // Semantic colors
  success: {
    light: '#dcfce7',
    main: '#22c55e',
    dark: '#15803d',
  },
  warning: {
    light: '#fef3c7',
    main: '#f59e0b',
    dark: '#b45309',
  },
  error: {
    light: '#fee2e2',
    main: '#ef4444',
    dark: '#b91c1c',
  },
  info: {
    light: '#dbeafe',
    main: '#3b82f6',
    dark: '#1d4ed8',
  },
  
  // Neutrals
  gray: {
    50: '#f9fafb',
    100: '#f3f4f6',
    200: '#e5e7eb',
    300: '#d1d5db',
    400: '#9ca3af',
    500: '#6b7280',
    600: '#4b5563',
    700: '#374151',
    800: '#1f2937',
    900: '#111827',
    950: '#030712',
  },
} as const;

export type ColorScale = typeof colors.primary;
export type SemanticColor = typeof colors.success;
```

### Tailwind Configuration

Create `packages/ui/tailwind.config.ts`:

```typescript
import type { Config } from 'tailwindcss';
import { colors } from './src/tokens/colors';

const config: Config = {
  content: [
    './src/**/*.{js,ts,jsx,tsx}',
    '../../apps/*/src/**/*.{js,ts,jsx,tsx}',
  ],
  theme: {
    extend: {
      colors: {
        primary: colors.primary,
        secondary: colors.secondary,
        accent: colors.accent,
        success: colors.success,
        warning: colors.warning,
        error: colors.error,
        info: colors.info,
      },
      fontFamily: {
        sans: ['Inter', 'system-ui', 'sans-serif'],
        arabic: ['Noto Sans Arabic', 'sans-serif'],
      },
      fontSize: {
        '2xs': ['0.625rem', { lineHeight: '0.875rem' }],
      },
      spacing: {
        '4.5': '1.125rem',
        '18': '4.5rem',
      },
      borderRadius: {
        '4xl': '2rem',
      },
      boxShadow: {
        // Premium depth shadows
        'soft-sm': '0 2px 8px -2px rgba(0, 0, 0, 0.08)',
        'soft': '0 4px 16px -4px rgba(0, 0, 0, 0.1)',
        'soft-md': '0 8px 24px -8px rgba(0, 0, 0, 0.12)',
        'soft-lg': '0 16px 48px -12px rgba(0, 0, 0, 0.15)',
        // Colored shadows for depth
        'primary': '0 4px 14px -3px rgba(20, 184, 166, 0.4)',
        'error': '0 4px 14px -3px rgba(239, 68, 68, 0.4)',
        // Inner shadows for pressed states
        'inner-sm': 'inset 0 1px 2px rgba(0, 0, 0, 0.06)',
        'inner': 'inset 0 2px 4px rgba(0, 0, 0, 0.08)',
      },
      backgroundImage: {
        // Subtle gradients for surfaces
        'surface-gradient': 'linear-gradient(180deg, rgba(255,255,255,0.8) 0%, rgba(249,250,251,0.8) 100%)',
        'glass': 'linear-gradient(135deg, rgba(255,255,255,0.4) 0%, rgba(255,255,255,0.1) 100%)',
        // Moroccan-inspired pattern
        'moroccan-pattern': `url("data:image/svg+xml,%3Csvg width='60' height='60' viewBox='0 0 60 60' xmlns='http://www.w3.org/2000/svg'%3E%3Cpath d='M30 0L60 30L30 60L0 30z' fill='%2314b8a6' fill-opacity='0.03'/%3E%3C/svg%3E")`,
      },
      animation: {
        'fade-in': 'fadeIn 0.3s ease-out',
        'slide-up': 'slideUp 0.4s ease-out',
        'slide-down': 'slideDown 0.4s ease-out',
        'scale-in': 'scaleIn 0.2s ease-out',
        'pulse-soft': 'pulseSoft 2s infinite',
        'shimmer': 'shimmer 2s infinite',
      },
      keyframes: {
        fadeIn: {
          '0%': { opacity: '0' },
          '100%': { opacity: '1' },
        },
        slideUp: {
          '0%': { opacity: '0', transform: 'translateY(10px)' },
          '100%': { opacity: '1', transform: 'translateY(0)' },
        },
        slideDown: {
          '0%': { opacity: '0', transform: 'translateY(-10px)' },
          '100%': { opacity: '1', transform: 'translateY(0)' },
        },
        scaleIn: {
          '0%': { opacity: '0', transform: 'scale(0.95)' },
          '100%': { opacity: '1', transform: 'scale(1)' },
        },
        pulseSoft: {
          '0%, 100%': { opacity: '1' },
          '50%': { opacity: '0.7' },
        },
        shimmer: {
          '0%': { backgroundPosition: '-200% 0' },
          '100%': { backgroundPosition: '200% 0' },
        },
      },
    },
  },
  plugins: [
    require('tailwindcss-animate'),
    require('@tailwindcss/forms'),
  ],
};

export default config;
```

### Premium Button Component

Create `packages/ui/src/components/Button.tsx`:

```typescript
'use client';

// ============================================================
// Premium Button - Surfaces in 3D space responding to light
// ============================================================

import * as React from 'react';
import { Slot } from '@radix-ui/react-slot';
import { cva, type VariantProps } from 'class-variance-authority';
import { Loader2 } from 'lucide-react';
import { cn } from '../utils/cn';

/**
 * Button variants with premium depth and lighting
 * 
 * Design notes:
 * - Gradient backgrounds create subtle 3D curvature
 * - Shadow changes on hover simulate light source movement
 * - Active state uses inner shadow for "pressed" feel
 * - Ring on focus for accessibility without breaking design
 */
const buttonVariants = cva(
  // Base styles - all buttons share these
  [
    'inline-flex items-center justify-center gap-2',
    'font-medium whitespace-nowrap',
    'rounded-xl',
    'transition-all duration-200 ease-out',
    'focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-offset-2',
    'disabled:pointer-events-none disabled:opacity-50',
    // Prevent text selection on rapid clicks
    'select-none',
  ],
  {
    variants: {
      variant: {
        // Primary - Main CTA, most visual weight
        primary: [
          'bg-gradient-to-b from-primary-500 to-primary-600',
          'text-white',
          'shadow-lg shadow-primary-500/25',
          'hover:from-primary-400 hover:to-primary-500',
          'hover:shadow-xl hover:shadow-primary-500/30',
          'hover:-translate-y-0.5',
          'active:translate-y-0 active:shadow-md',
          'active:from-primary-600 active:to-primary-700',
          'focus-visible:ring-primary-500',
        ],
        
        // Secondary - Supporting actions
        secondary: [
          'bg-gradient-to-b from-white to-gray-50',
          'text-gray-700',
          'border border-gray-200',
          'shadow-sm',
          'hover:from-gray-50 hover:to-gray-100',
          'hover:border-gray-300',
          'hover:shadow-md',
          'active:shadow-inner',
          'focus-visible:ring-gray-400',
        ],
        
        // Destructive - Dangerous actions
        destructive: [
          'bg-gradient-to-b from-error-main to-red-600',
          'text-white',
          'shadow-lg shadow-red-500/25',
          'hover:from-red-500 hover:to-red-600',
          'hover:shadow-xl hover:shadow-red-500/30',
          'active:from-red-700 active:to-red-800',
          'focus-visible:ring-red-500',
        ],
        
        // Ghost - Minimal visual weight
        ghost: [
          'bg-transparent',
          'text-gray-700',
          'hover:bg-gray-100',
          'active:bg-gray-200',
          'focus-visible:ring-gray-400',
        ],
        
        // Outline - Secondary with border emphasis
        outline: [
          'bg-transparent',
          'text-primary-600',
          'border-2 border-primary-500',
          'hover:bg-primary-50',
          'active:bg-primary-100',
          'focus-visible:ring-primary-500',
        ],
        
        // Link - Text-only appearance
        link: [
          'bg-transparent',
          'text-primary-600',
          'underline-offset-4',
          'hover:underline',
          'focus-visible:ring-primary-500',
        ],
      },
      
      size: {
        sm: 'h-9 px-3 text-sm',
        md: 'h-11 px-5 text-sm',
        lg: 'h-12 px-6 text-base',
        xl: 'h-14 px-8 text-lg',
        icon: 'h-10 w-10',
        'icon-sm': 'h-8 w-8',
        'icon-lg': 'h-12 w-12',
      },
      
      fullWidth: {
        true: 'w-full',
      },
    },
    defaultVariants: {
      variant: 'primary',
      size: 'md',
    },
  }
);

export interface ButtonProps
  extends React.ButtonHTMLAttributes<HTMLButtonElement>,
    VariantProps<typeof buttonVariants> {
  asChild?: boolean;
  loading?: boolean;
  leftIcon?: React.ReactNode;
  rightIcon?: React.ReactNode;
}

const Button = React.forwardRef<HTMLButtonElement, ButtonProps>(
  (
    {
      className,
      variant,
      size,
      fullWidth,
      asChild = false,
      loading = false,
      leftIcon,
      rightIcon,
      children,
      disabled,
      ...props
    },
    ref
  ) => {
    const Comp = asChild ? Slot : 'button';
    
    const isDisabled = disabled || loading;
    
    return (
      <Comp
        className={cn(buttonVariants({ variant, size, fullWidth, className }))}
        ref={ref}
        disabled={isDisabled}
        {...props}
      >
        {loading ? (
          <>
            <Loader2 className="h-4 w-4 animate-spin" />
            <span>{children}</span>
          </>
        ) : (
          <>
            {leftIcon && <span className="shrink-0">{leftIcon}</span>}
            {children}
            {rightIcon && <span className="shrink-0">{rightIcon}</span>}
          </>
        )}
      </Comp>
    );
  }
);

Button.displayName = 'Button';

export { Button, buttonVariants };
```

### Premium Card Component

Create `packages/ui/src/components/Card.tsx`:

```typescript
'use client';

// ============================================================
// Premium Card - Surface with subtle depth
// ============================================================

import * as React from 'react';
import { cva, type VariantProps } from 'class-variance-authority';
import { cn } from '../utils/cn';

/**
 * Card with physically-based lighting
 * 
 * Design notes from Generative Artist:
 * - Top border highlight simulates light from above
 * - Gradient background creates subtle curvature
 * - Shadow adds depth without feeling heavy
 * - Hover state lifts card "off" the surface
 */
const cardVariants = cva(
  [
    'rounded-2xl',
    'bg-white',
    'transition-all duration-200',
    // Subtle top highlight (light from above)
    'before:absolute before:inset-x-0 before:top-0 before:h-px',
    'before:bg-gradient-to-r before:from-transparent before:via-white/80 before:to-transparent',
    'relative overflow-hidden',
  ],
  {
    variants: {
      variant: {
        elevated: [
          'shadow-soft',
          'border border-gray-100',
          'hover:shadow-soft-md hover:-translate-y-0.5',
        ],
        outlined: [
          'border border-gray-200',
          'shadow-none',
          'hover:border-gray-300',
        ],
        filled: [
          'bg-gray-50',
          'border-none',
          'shadow-none',
        ],
        glass: [
          'bg-white/70 backdrop-blur-xl',
          'border border-white/20',
          'shadow-soft',
        ],
      },
      padding: {
        none: 'p-0',
        sm: 'p-4',
        md: 'p-6',
        lg: 'p-8',
      },
      interactive: {
        true: 'cursor-pointer',
        false: '',
      },
    },
    defaultVariants: {
      variant: 'elevated',
      padding: 'md',
      interactive: false,
    },
  }
);

export interface CardProps
  extends React.HTMLAttributes<HTMLDivElement>,
    VariantProps<typeof cardVariants> {}

const Card = React.forwardRef<HTMLDivElement, CardProps>(
  ({ className, variant, padding, interactive, ...props }, ref) => (
    <div
      ref={ref}
      className={cn(cardVariants({ variant, padding, interactive, className }))}
      {...props}
    />
  )
);
Card.displayName = 'Card';

const CardHeader = React.forwardRef<
  HTMLDivElement,
  React.HTMLAttributes<HTMLDivElement>
>(({ className, ...props }, ref) => (
  <div
    ref={ref}
    className={cn('flex flex-col space-y-1.5', className)}
    {...props}
  />
));
CardHeader.displayName = 'CardHeader';

const CardTitle = React.forwardRef<
  HTMLParagraphElement,
  React.HTMLAttributes<HTMLHeadingElement>
>(({ className, ...props }, ref) => (
  <h3
    ref={ref}
    className={cn('text-lg font-semibold leading-none tracking-tight text-gray-900', className)}
    {...props}
  />
));
CardTitle.displayName = 'CardTitle';

const CardDescription = React.forwardRef<
  HTMLParagraphElement,
  React.HTMLAttributes<HTMLParagraphElement>
>(({ className, ...props }, ref) => (
  <p
    ref={ref}
    className={cn('text-sm text-gray-500', className)}
    {...props}
  />
));
CardDescription.displayName = 'CardDescription';

const CardContent = React.forwardRef<
  HTMLDivElement,
  React.HTMLAttributes<HTMLDivElement>
>(({ className, ...props }, ref) => (
  <div ref={ref} className={cn('', className)} {...props} />
));
CardContent.displayName = 'CardContent';

const CardFooter = React.forwardRef<
  HTMLDivElement,
  React.HTMLAttributes<HTMLDivElement>
>(({ className, ...props }, ref) => (
  <div
    ref={ref}
    className={cn('flex items-center pt-4', className)}
    {...props}
  />
));
CardFooter.displayName = 'CardFooter';

export { Card, CardHeader, CardFooter, CardTitle, CardDescription, CardContent, cardVariants };
```

### Input Component with Validation States

Create `packages/ui/src/components/Input.tsx`:

```typescript
'use client';

// ============================================================
// Input - Form input with validation states
// ============================================================

import * as React from 'react';
import { cva, type VariantProps } from 'class-variance-authority';
import { AlertCircle, CheckCircle, Eye, EyeOff } from 'lucide-react';
import { cn } from '../utils/cn';

const inputVariants = cva(
  [
    'flex w-full',
    'rounded-xl border bg-white px-4 py-3',
    'text-sm text-gray-900 placeholder:text-gray-400',
    'transition-all duration-200',
    'focus:outline-none focus:ring-2 focus:ring-offset-0',
    'disabled:cursor-not-allowed disabled:opacity-50 disabled:bg-gray-50',
    // Inner shadow for depth
    'shadow-inner-sm',
  ],
  {
    variants: {
      state: {
        default: [
          'border-gray-200',
          'hover:border-gray-300',
          'focus:border-primary-500 focus:ring-primary-500/20',
        ],
        error: [
          'border-error-main',
          'focus:border-error-main focus:ring-error-main/20',
          'pr-10', // Space for error icon
        ],
        success: [
          'border-success-main',
          'focus:border-success-main focus:ring-success-main/20',
          'pr-10', // Space for success icon
        ],
      },
      inputSize: {
        sm: 'h-9 text-sm',
        md: 'h-11',
        lg: 'h-12 text-base',
      },
    },
    defaultVariants: {
      state: 'default',
      inputSize: 'md',
    },
  }
);

export interface InputProps
  extends Omit<React.InputHTMLAttributes<HTMLInputElement>, 'size'>,
    VariantProps<typeof inputVariants> {
  label?: string;
  helperText?: string;
  errorMessage?: string;
  leftIcon?: React.ReactNode;
  rightIcon?: React.ReactNode;
  showPasswordToggle?: boolean;
}

const Input = React.forwardRef<HTMLInputElement, InputProps>(
  (
    {
      className,
      type = 'text',
      state,
      inputSize,
      label,
      helperText,
      errorMessage,
      leftIcon,
      rightIcon,
      showPasswordToggle,
      disabled,
      ...props
    },
    ref
  ) => {
    const [showPassword, setShowPassword] = React.useState(false);
    
    // Determine actual state based on errorMessage
    const actualState = errorMessage ? 'error' : state;
    
    // Handle password visibility toggle
    const inputType = type === 'password' && showPassword ? 'text' : type;
    
    return (
      <div className="w-full">
        {/* Label */}
        {label && (
          <label className="mb-2 block text-sm font-medium text-gray-700">
            {label}
          </label>
        )}
        
        {/* Input wrapper */}
        <div className="relative">
          {/* Left icon */}
          {leftIcon && (
            <span className="absolute left-3 top-1/2 -translate-y-1/2 text-gray-400">
              {leftIcon}
            </span>
          )}
          
          {/* Input */}
          <input
            type={inputType}
            className={cn(
              inputVariants({ state: actualState, inputSize, className }),
              leftIcon && 'pl-10',
              (rightIcon || showPasswordToggle || actualState !== 'default') && 'pr-10'
            )}
            ref={ref}
            disabled={disabled}
            {...props}
          />
          
          {/* Right side icons */}
          <div className="absolute right-3 top-1/2 -translate-y-1/2 flex items-center gap-2">
            {/* State icons */}
            {actualState === 'error' && (
              <AlertCircle className="h-4 w-4 text-error-main" />
            )}
            {actualState === 'success' && (
              <CheckCircle className="h-4 w-4 text-success-main" />
            )}
            
            {/* Password toggle */}
            {type === 'password' && showPasswordToggle && (
              <button
                type="button"
                onClick={() => setShowPassword(!showPassword)}
                className="text-gray-400 hover:text-gray-600 focus:outline-none"
                tabIndex={-1}
              >
                {showPassword ? (
                  <EyeOff className="h-4 w-4" />
                ) : (
                  <Eye className="h-4 w-4" />
                )}
              </button>
            )}
            
            {/* Custom right icon */}
            {rightIcon && !showPasswordToggle && actualState === 'default' && (
              <span className="text-gray-400">{rightIcon}</span>
            )}
          </div>
        </div>
        
        {/* Helper text or error message */}
        {(errorMessage || helperText) && (
          <p
            className={cn(
              'mt-1.5 text-sm',
              errorMessage ? 'text-error-main' : 'text-gray-500'
            )}
          >
            {errorMessage || helperText}
          </p>
        )}
      </div>
    );
  }
);

Input.displayName = 'Input';

export { Input, inputVariants };
```

---

## PACKAGE: @dawa/utils

### Formatting Utilities

Create `packages/utils/src/format.ts`:

```typescript
// ============================================================
// Formatting Utilities
// ============================================================

/**
 * Format currency in Moroccan Dirhams
 */
export function formatCurrency(
  amount: number,
  options?: { showDecimals?: boolean; compact?: boolean }
): string {
  const { showDecimals = true, compact = false } = options || {};
  
  if (compact && amount >= 1000) {
    const k = amount / 1000;
    return `${k.toFixed(k % 1 === 0 ? 0 : 1)}k DH`;
  }
  
  return new Intl.NumberFormat('fr-MA', {
    style: 'decimal',
    minimumFractionDigits: showDecimals ? 2 : 0,
    maximumFractionDigits: showDecimals ? 2 : 0,
  }).format(amount) + ' DH';
}

/**
 * Format phone number for display
 * Input: +212612345678
 * Output: +212 6 12 34 56 78
 */
export function formatPhone(phone: string): string {
  if (!phone) return '';
  
  // Remove all non-digits except leading +
  const cleaned = phone.replace(/[^\d+]/g, '');
  
  if (cleaned.startsWith('+212')) {
    const rest = cleaned.slice(4);
    return `+212 ${rest[0]} ${rest.slice(1, 3)} ${rest.slice(3, 5)} ${rest.slice(5, 7)} ${rest.slice(7)}`;
  }
  
  return phone;
}

/**
 * Format distance in kilometers
 */
export function formatDistance(km: number): string {
  if (km < 1) {
    return `${Math.round(km * 1000)} m`;
  }
  return `${km.toFixed(1)} km`;
}

/**
 * Format duration in minutes
 */
export function formatDuration(minutes: number): string {
  if (minutes < 60) {
    return `${Math.round(minutes)} min`;
  }
  const hours = Math.floor(minutes / 60);
  const mins = Math.round(minutes % 60);
  return mins > 0 ? `${hours}h ${mins}min` : `${hours}h`;
}

/**
 * Format order number for display
 * Adds spacing: DWA-20240115-A1B2 → DWA 2024 0115 A1B2
 */
export function formatOrderNumber(orderNumber: string): string {
  return orderNumber.replace(/-/g, ' ');
}

/**
 * Truncate text with ellipsis
 */
export function truncate(text: string, length: number): string {
  if (text.length <= length) return text;
  return text.slice(0, length).trim() + '…';
}

/**
 * Generate initials from name
 */
export function getInitials(name: string, maxLength = 2): string {
  return name
    .split(' ')
    .map(word => word[0])
    .filter(Boolean)
    .slice(0, maxLength)
    .join('')
    .toUpperCase();
}

/**
 * Format file size
 */
export function formatFileSize(bytes: number): string {
  if (bytes === 0) return '0 B';
  const k = 1024;
  const sizes = ['B', 'KB', 'MB', 'GB'];
  const i = Math.floor(Math.log(bytes) / Math.log(k));
  return `${parseFloat((bytes / Math.pow(k, i)).toFixed(1))} ${sizes[i]}`;
}
```

### Date Utilities

Create `packages/utils/src/date.ts`:

```typescript
// ============================================================
// Date Utilities - Morocco timezone aware
// ============================================================

import {
  format,
  formatDistanceToNow,
  formatRelative,
  isToday,
  isYesterday,
  isTomorrow,
  parseISO,
  differenceInMinutes,
  differenceInHours,
  differenceInDays,
  addMinutes,
} from 'date-fns';
import { fr } from 'date-fns/locale';

const MOROCCO_TIMEZONE = 'Africa/Casablanca';

/**
 * Parse ISO string to Date
 */
export function parseDate(dateString: string): Date {
  return parseISO(dateString);
}

/**
 * Format date for display (French locale)
 */
export function formatDate(
  date: string | Date,
  formatStr: string = 'dd MMM yyyy'
): string {
  const d = typeof date === 'string' ? parseISO(date) : date;
  return format(d, formatStr, { locale: fr });
}

/**
 * Format time (24h format for Morocco)
 */
export function formatTime(date: string | Date): string {
  const d = typeof date === 'string' ? parseISO(date) : date;
  return format(d, 'HH:mm', { locale: fr });
}

/**
 * Format date and time together
 */
export function formatDateTime(date: string | Date): string {
  const d = typeof date === 'string' ? parseISO(date) : date;
  return format(d, 'dd MMM yyyy à HH:mm', { locale: fr });
}

/**
 * Smart relative time formatting
 * - Just now
 * - 5 min ago
 * - 2h ago
 * - Yesterday at 14:30
 * - Monday at 14:30
 * - 15 Jan at 14:30
 */
export function formatRelativeTime(date: string | Date): string {
  const d = typeof date === 'string' ? parseISO(date) : date;
  const now = new Date();
  
  const minutesDiff = differenceInMinutes(now, d);
  const hoursDiff = differenceInHours(now, d);
  const daysDiff = differenceInDays(now, d);
  
  // Less than 1 minute
  if (minutesDiff < 1) {
    return 'À l\'instant';
  }
  
  // Less than 1 hour
  if (minutesDiff < 60) {
    return `Il y a ${minutesDiff} min`;
  }
  
  // Less than 24 hours
  if (hoursDiff < 24) {
    return `Il y a ${hoursDiff}h`;
  }
  
  // Yesterday
  if (isYesterday(d)) {
    return `Hier à ${format(d, 'HH:mm')}`;
  }
  
  // Within the week
  if (daysDiff < 7) {
    return format(d, 'EEEE à HH:mm', { locale: fr });
  }
  
  // Older
  return format(d, 'dd MMM à HH:mm', { locale: fr });
}

/**
 * Format smart date for lists
 * - Today → "Aujourd'hui"
 * - Yesterday → "Hier"
 * - Tomorrow → "Demain"
 * - Within week → "Lundi"
 * - Otherwise → "15 janvier"
 */
export function formatSmartDate(date: string | Date): string {
  const d = typeof date === 'string' ? parseISO(date) : date;
  
  if (isToday(d)) return 'Aujourd\'hui';
  if (isYesterday(d)) return 'Hier';
  if (isTomorrow(d)) return 'Demain';
  
  const daysDiff = differenceInDays(new Date(), d);
  if (Math.abs(daysDiff) < 7) {
    return format(d, 'EEEE', { locale: fr });
  }
  
  return format(d, 'dd MMMM', { locale: fr });
}

/**
 * Calculate estimated arrival time
 */
export function getEstimatedArrival(
  preparationMinutes: number,
  deliveryMinutes: number
): Date {
  return addMinutes(new Date(), preparationMinutes + deliveryMinutes);
}

/**
 * Format estimated delivery window
 * Returns: "14:30 - 15:00"
 */
export function formatDeliveryWindow(
  estimatedTime: Date,
  windowMinutes: number = 15
): string {
  const start = format(estimatedTime, 'HH:mm');
  const end = format(addMinutes(estimatedTime, windowMinutes), 'HH:mm');
  return `${start} - ${end}`;
}
```

---

## PACKAGE: @dawa/validation

### Zod Schemas

Create `packages/validation/src/schemas/auth.ts`:

```typescript
// ============================================================
// Authentication Validation Schemas
// ============================================================

import { z } from 'zod';

/**
 * Moroccan phone number validation
 * Format: +212 followed by 6 or 7, then 8 digits
 */
export const moroccanPhoneSchema = z
  .string()
  .regex(
    /^\+212[67]\d{8}$/,
    'Numéro de téléphone invalide. Format: +212 6XX XXX XXX'
  );

/**
 * OTP code validation (6 digits)
 */
export const otpCodeSchema = z
  .string()
  .length(6, 'Le code doit contenir 6 chiffres')
  .regex(/^\d+$/, 'Le code ne doit contenir que des chiffres');

/**
 * Phone authentication - request OTP
 */
export const requestOtpSchema = z.object({
  phone: moroccanPhoneSchema,
});

/**
 * Phone authentication - verify OTP
 */
export const verifyOtpSchema = z.object({
  phone: moroccanPhoneSchema,
  code: otpCodeSchema,
});

/**
 * CNDP Consent (Morocco data protection)
 */
export const consentSchema = z.object({
  data_processing: z.literal(true, {
    errorMap: () => ({ message: 'Vous devez accepter le traitement des données' }),
  }),
  marketing: z.boolean().optional(),
  location: z.boolean().optional(),
  medical_data: z.boolean().optional(),
});

export type RequestOtpInput = z.infer<typeof requestOtpSchema>;
export type VerifyOtpInput = z.infer<typeof verifyOtpSchema>;
export type ConsentInput = z.infer<typeof consentSchema>;
```

Create `packages/validation/src/schemas/order.ts`:

```typescript
// ============================================================
// Order Validation Schemas
// ============================================================

import { z } from 'zod';
import { DeliveryTimePreference, PaymentMethod } from '@dawa/types';

/**
 * Order item validation
 */
export const orderItemSchema = z.object({
  medication_id: z.string().uuid('ID médicament invalide'),
  quantity: z
    .number()
    .int('La quantité doit être un nombre entier')
    .min(1, 'Quantité minimum: 1')
    .max(99, 'Quantité maximum: 99'),
});

/**
 * Create order validation
 */
export const createOrderSchema = z.object({
  pharmacy_id: z.string().uuid('Pharmacie invalide'),
  delivery_address_id: z.string().uuid('Adresse invalide'),
  
  delivery_time_preference: z.nativeEnum(DeliveryTimePreference, {
    errorMap: () => ({ message: 'Préférence de livraison invalide' }),
  }),
  
  scheduled_delivery_at: z
    .string()
    .datetime()
    .optional()
    .refine(
      (val) => !val || new Date(val) > new Date(),
      'La date de livraison doit être dans le futur'
    ),
  
  payment_method: z.nativeEnum(PaymentMethod, {
    errorMap: () => ({ message: 'Mode de paiement invalide' }),
  }),
  
  items: z
    .array(orderItemSchema)
    .min(1, 'Le panier ne peut pas être vide')
    .max(50, 'Maximum 50 articles par commande'),
  
  prescription_id: z.string().uuid().optional(),
  
  patient_notes: z
    .string()
    .max(500, 'Maximum 500 caractères')
    .optional(),
  
  promo_code: z
    .string()
    .max(20)
    .optional(),
});

/**
 * Cancel order validation
 */
export const cancelOrderSchema = z.object({
  reason: z
    .string()
    .min(10, 'Minimum 10 caractères')
    .max(500, 'Maximum 500 caractères'),
});

export type OrderItemInput = z.infer<typeof orderItemSchema>;
export type CreateOrderInput = z.infer<typeof createOrderSchema>;
export type CancelOrderInput = z.infer<typeof cancelOrderSchema>;
```

---

## PACKAGE EXPORTS

### packages/ui/src/index.ts

```typescript
// Components
export * from './components/Button';
export * from './components/Card';
export * from './components/Input';
// ... more components

// Tokens
export * from './tokens/colors';

// Utils
export { cn } from './utils/cn';

// Tailwind config
export { default as tailwindConfig } from '../tailwind.config';
```

### packages/utils/src/index.ts

```typescript
export * from './format';
export * from './date';
export * from './helpers';
```

### packages/validation/src/index.ts

```typescript
export * from './schemas/auth';
export * from './schemas/order';
export * from './schemas/patient';
export * from './schemas/pharmacy';
export * from './schemas/address';
```

---

## SUCCESS CRITERIA

- [ ] @dawa/ui exports premium components with consistent styling
- [ ] @dawa/utils provides all formatting functions
- [ ] @dawa/validation covers all form schemas with French messages
- [ ] All packages compile without TypeScript errors
- [ ] Tailwind config extends consistently across apps
- [ ] Color system reflects Moroccan aesthetics

---

## NEXT STEP

After validation passes, proceed to:
→ `dawa-docs/prompts/phase-0/P0.6-phone-otp-authentication.md`

Reference documentation:
→ `dawa-docs/docs/DAWA_MASTER.md`
