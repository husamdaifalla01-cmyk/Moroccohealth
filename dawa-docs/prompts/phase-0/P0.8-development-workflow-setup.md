# P0.8 — Development Workflow Setup

## Prompt ID: P0.8
## Phase: 0 - Foundation
## Estimated Time: 3-4 hours
## Prerequisites: P0.1-P0.7 complete

---

## CONTEXT

You are establishing the development workflow for the DAWA.ma monorepo. A consistent, automated workflow ensures code quality across all packages and apps.

**Goals**:
1. Catch errors before they reach production
2. Enforce consistent code style
3. Automate testing and deployment
4. Make onboarding new developers easy

---

## WORKFLOW COMPONENTS

```
┌─────────────────────────────────────────────────────────────────┐
│                    LOCAL DEVELOPMENT                             │
├─────────────────────────────────────────────────────────────────┤
│  Code Change → Pre-commit Hook → Lint + Format → Commit         │
└─────────────────────────────────────────────────────────────────┘
                              │
                              ▼
┌─────────────────────────────────────────────────────────────────┐
│                    CONTINUOUS INTEGRATION                        │
├─────────────────────────────────────────────────────────────────┤
│  Push/PR → GitHub Actions → Lint → Type Check → Test → Build   │
└─────────────────────────────────────────────────────────────────┘
                              │
                              ▼
┌─────────────────────────────────────────────────────────────────┐
│                    CONTINUOUS DEPLOYMENT                         │
├─────────────────────────────────────────────────────────────────┤
│  Main Branch → Vercel Deploy → Staging → Manual Promote → Prod  │
└─────────────────────────────────────────────────────────────────┘
```

---

## IMPLEMENTATION STEPS

### Step 1: ESLint Configuration

Create `packages/eslint-config/base.js`:

```javascript
// ============================================================
// @dawa/eslint-config - Base ESLint Configuration
// ============================================================

/** @type {import('eslint').Linter.Config} */
module.exports = {
  root: true,
  parser: '@typescript-eslint/parser',
  parserOptions: {
    ecmaVersion: 'latest',
    sourceType: 'module',
  },
  plugins: [
    '@typescript-eslint',
    'import',
    'unused-imports',
  ],
  extends: [
    'eslint:recommended',
    'plugin:@typescript-eslint/recommended',
    'plugin:import/typescript',
    'prettier', // Must be last
  ],
  rules: {
    // TypeScript
    '@typescript-eslint/no-unused-vars': 'off', // Handled by unused-imports
    '@typescript-eslint/explicit-function-return-type': 'off',
    '@typescript-eslint/explicit-module-boundary-types': 'off',
    '@typescript-eslint/no-explicit-any': 'warn',
    '@typescript-eslint/no-non-null-assertion': 'warn',
    
    // Unused imports (auto-fixable)
    'unused-imports/no-unused-imports': 'error',
    'unused-imports/no-unused-vars': [
      'warn',
      {
        vars: 'all',
        varsIgnorePattern: '^_',
        args: 'after-used',
        argsIgnorePattern: '^_',
      },
    ],
    
    // Import ordering
    'import/order': [
      'error',
      {
        groups: [
          'builtin',
          'external',
          'internal',
          ['parent', 'sibling'],
          'index',
          'type',
        ],
        'newlines-between': 'always',
        alphabetize: {
          order: 'asc',
          caseInsensitive: true,
        },
        pathGroups: [
          {
            pattern: '@dawa/**',
            group: 'internal',
            position: 'before',
          },
          {
            pattern: '@/**',
            group: 'internal',
            position: 'after',
          },
        ],
        pathGroupsExcludedImportTypes: ['builtin'],
      },
    ],
    
    // General
    'no-console': ['warn', { allow: ['warn', 'error'] }],
    'prefer-const': 'error',
    'no-var': 'error',
  },
  ignorePatterns: [
    'node_modules',
    'dist',
    '.next',
    'coverage',
    '*.config.js',
    '*.config.ts',
  ],
};
```

Create `packages/eslint-config/react.js`:

```javascript
// ============================================================
// @dawa/eslint-config - React Configuration
// ============================================================

/** @type {import('eslint').Linter.Config} */
module.exports = {
  extends: [
    './base.js',
    'plugin:react/recommended',
    'plugin:react-hooks/recommended',
    'plugin:jsx-a11y/recommended',
  ],
  plugins: ['react', 'react-hooks', 'jsx-a11y'],
  parserOptions: {
    ecmaFeatures: {
      jsx: true,
    },
  },
  settings: {
    react: {
      version: 'detect',
    },
  },
  rules: {
    // React
    'react/react-in-jsx-scope': 'off', // Not needed with Next.js
    'react/prop-types': 'off', // Using TypeScript
    'react/display-name': 'off',
    'react/no-unescaped-entities': 'warn',
    
    // React Hooks
    'react-hooks/rules-of-hooks': 'error',
    'react-hooks/exhaustive-deps': 'warn',
    
    // Accessibility
    'jsx-a11y/anchor-is-valid': [
      'error',
      {
        components: ['Link'],
        specialLink: ['hrefLeft', 'hrefRight'],
        aspects: ['invalidHref', 'preferButton'],
      },
    ],
    'jsx-a11y/click-events-have-key-events': 'warn',
    'jsx-a11y/no-static-element-interactions': 'warn',
  },
};
```

Create `packages/eslint-config/next.js`:

```javascript
// ============================================================
// @dawa/eslint-config - Next.js Configuration
// ============================================================

/** @type {import('eslint').Linter.Config} */
module.exports = {
  extends: [
    './react.js',
    'plugin:@next/next/recommended',
  ],
  rules: {
    // Next.js specific
    '@next/next/no-html-link-for-pages': 'error',
    '@next/next/no-img-element': 'warn',
  },
};
```

### Step 2: Prettier Configuration

Create `.prettierrc` at project root:

```json
{
  "semi": true,
  "singleQuote": true,
  "tabWidth": 2,
  "trailingComma": "es5",
  "printWidth": 100,
  "useTabs": false,
  "bracketSpacing": true,
  "bracketSameLine": false,
  "arrowParens": "always",
  "endOfLine": "lf",
  "plugins": ["prettier-plugin-tailwindcss"],
  "tailwindConfig": "./packages/ui/tailwind.config.ts",
  "tailwindFunctions": ["cn", "cva"]
}
```

Create `.prettierignore`:

```
# Dependencies
node_modules
pnpm-lock.yaml

# Build outputs
dist
.next
out
build

# Generated
*.generated.*
database.types.ts

# Other
coverage
.turbo
```

### Step 3: Husky & lint-staged

Initialize Husky:

```bash
pnpm add -D husky lint-staged -w
pnpm exec husky init
```

Create `.husky/pre-commit`:

```bash
#!/usr/bin/env sh
. "$(dirname -- "$0")/_/husky.sh"

pnpm lint-staged
```

Create `.husky/commit-msg`:

```bash
#!/usr/bin/env sh
. "$(dirname -- "$0")/_/husky.sh"

# Validate commit message format
commit_msg=$(cat "$1")
pattern="^(feat|fix|docs|style|refactor|perf|test|chore|ci|build)(\(.+\))?: .{1,72}$"

if ! echo "$commit_msg" | grep -qE "$pattern"; then
  echo "❌ Invalid commit message format!"
  echo ""
  echo "Expected format: type(scope): description"
  echo ""
  echo "Types: feat, fix, docs, style, refactor, perf, test, chore, ci, build"
  echo "Example: feat(auth): add OTP verification"
  echo ""
  exit 1
fi
```

Create `.lintstagedrc.js`:

```javascript
module.exports = {
  // TypeScript/JavaScript
  '*.{ts,tsx,js,jsx}': [
    'eslint --fix',
    'prettier --write',
  ],
  
  // JSON/YAML/Markdown
  '*.{json,yml,yaml,md}': [
    'prettier --write',
  ],
  
  // CSS
  '*.css': [
    'prettier --write',
  ],
};
```

### Step 4: Vitest Configuration

Create `packages/testing/vitest.config.ts`:

```typescript
// ============================================================
// Shared Vitest Configuration
// ============================================================

import { defineConfig } from 'vitest/config';
import react from '@vitejs/plugin-react';
import tsconfigPaths from 'vite-tsconfig-paths';

export default defineConfig({
  plugins: [react(), tsconfigPaths()],
  test: {
    globals: true,
    environment: 'jsdom',
    setupFiles: ['./src/setup.ts'],
    include: ['**/*.{test,spec}.{ts,tsx}'],
    exclude: ['**/node_modules/**', '**/dist/**', '**/.next/**'],
    coverage: {
      provider: 'v8',
      reporter: ['text', 'json', 'html'],
      exclude: [
        'node_modules/',
        'dist/',
        '**/*.d.ts',
        '**/*.config.*',
        '**/setup.ts',
      ],
    },
    testTimeout: 10000,
  },
});
```

Create `packages/testing/src/setup.ts`:

```typescript
// ============================================================
// Test Setup - Mocks and Global Configuration
// ============================================================

import '@testing-library/jest-dom';
import { vi } from 'vitest';

// Mock window.matchMedia
Object.defineProperty(window, 'matchMedia', {
  writable: true,
  value: vi.fn().mockImplementation((query) => ({
    matches: false,
    media: query,
    onchange: null,
    addListener: vi.fn(),
    removeListener: vi.fn(),
    addEventListener: vi.fn(),
    removeEventListener: vi.fn(),
    dispatchEvent: vi.fn(),
  })),
});

// Mock ResizeObserver
global.ResizeObserver = vi.fn().mockImplementation(() => ({
  observe: vi.fn(),
  unobserve: vi.fn(),
  disconnect: vi.fn(),
}));

// Mock IntersectionObserver
global.IntersectionObserver = vi.fn().mockImplementation(() => ({
  observe: vi.fn(),
  unobserve: vi.fn(),
  disconnect: vi.fn(),
}));

// Mock scrollTo
window.scrollTo = vi.fn();

// Suppress console errors during tests (optional)
// vi.spyOn(console, 'error').mockImplementation(() => {});
```

Create `packages/testing/src/mocks/supabase.ts`:

```typescript
// ============================================================
// Supabase Mock for Testing
// ============================================================

import { vi } from 'vitest';

export const mockSupabaseClient = {
  auth: {
    getUser: vi.fn().mockResolvedValue({ data: { user: null }, error: null }),
    getSession: vi.fn().mockResolvedValue({ data: { session: null }, error: null }),
    signOut: vi.fn().mockResolvedValue({ error: null }),
    onAuthStateChange: vi.fn().mockReturnValue({
      data: { subscription: { unsubscribe: vi.fn() } },
    }),
  },
  from: vi.fn().mockReturnValue({
    select: vi.fn().mockReturnThis(),
    insert: vi.fn().mockReturnThis(),
    update: vi.fn().mockReturnThis(),
    delete: vi.fn().mockReturnThis(),
    eq: vi.fn().mockReturnThis(),
    single: vi.fn().mockResolvedValue({ data: null, error: null }),
    order: vi.fn().mockReturnThis(),
    limit: vi.fn().mockReturnThis(),
  }),
  channel: vi.fn().mockReturnValue({
    on: vi.fn().mockReturnThis(),
    subscribe: vi.fn().mockReturnValue({ unsubscribe: vi.fn() }),
  }),
  removeChannel: vi.fn(),
};

export const createMockSupabase = () => mockSupabaseClient;

// Reset all mocks between tests
export const resetSupabaseMocks = () => {
  vi.clearAllMocks();
};
```

Create `packages/testing/src/fixtures/index.ts`:

```typescript
// ============================================================
// Test Fixtures
// ============================================================

import { OrderStatus, PaymentMethod, PaymentStatus } from '@dawa/types';

export const fixtures = {
  patient: {
    id: 'patient-123',
    phone: '+212612345678',
    first_name: 'Mohammed',
    last_name: 'Test',
    status: 'active',
    created_at: '2024-01-01T00:00:00Z',
    updated_at: '2024-01-01T00:00:00Z',
  },
  
  pharmacy: {
    id: 'pharmacy-123',
    name: 'Pharmacie du Centre',
    phone_primary: '+212522123456',
    email: 'contact@pharmacie-centre.ma',
    city: 'Casablanca',
    region: 'Casablanca-Settat',
    latitude: 33.5731,
    longitude: -7.5898,
    status: 'verified',
    is_open: true,
    is_accepting_orders: true,
    rating: 4.5,
    review_count: 128,
  },
  
  order: {
    id: 'order-123',
    order_number: 'DWA-20240115-A1B2',
    patient_id: 'patient-123',
    pharmacy_id: 'pharmacy-123',
    status: OrderStatus.PENDING_PHARMACY,
    payment_method: PaymentMethod.CASH_ON_DELIVERY,
    payment_status: PaymentStatus.PENDING,
    subtotal: 150.00,
    delivery_fee: 20.00,
    service_fee: 5.00,
    discount_amount: 0,
    total: 175.00,
    created_at: '2024-01-15T10:00:00Z',
  },
  
  medication: {
    id: 'med-123',
    name: 'Doliprane 1000mg',
    generic_name: 'Paracétamol',
    category: 'otc',
    price: 25.50,
    requires_prescription: false,
    in_stock: true,
  },
  
  address: {
    id: 'addr-123',
    patient_id: 'patient-123',
    label: 'Domicile',
    address_line_1: '123 Rue Mohammed V',
    city: 'Casablanca',
    region: 'Casablanca-Settat',
    latitude: 33.5890,
    longitude: -7.6032,
    is_default: true,
  },
};

// Factory function for creating variations
export function createFixture<T extends keyof typeof fixtures>(
  type: T,
  overrides?: Partial<typeof fixtures[T]>
): typeof fixtures[T] {
  return {
    ...fixtures[type],
    ...overrides,
  };
}
```

### Step 5: GitHub Actions CI

Create `.github/workflows/ci.yml`:

```yaml
name: CI

on:
  push:
    branches: [main, develop]
  pull_request:
    branches: [main, develop]

concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

env:
  TURBO_TOKEN: ${{ secrets.TURBO_TOKEN }}
  TURBO_TEAM: ${{ vars.TURBO_TEAM }}

jobs:
  lint:
    name: Lint
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      
      - name: Setup pnpm
        uses: pnpm/action-setup@v2
        with:
          version: 8
          
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'pnpm'
          
      - name: Install dependencies
        run: pnpm install --frozen-lockfile
        
      - name: Run lint
        run: pnpm lint

  typecheck:
    name: Type Check
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      
      - name: Setup pnpm
        uses: pnpm/action-setup@v2
        with:
          version: 8
          
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'pnpm'
          
      - name: Install dependencies
        run: pnpm install --frozen-lockfile
        
      - name: Run typecheck
        run: pnpm typecheck

  test:
    name: Test
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      
      - name: Setup pnpm
        uses: pnpm/action-setup@v2
        with:
          version: 8
          
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'pnpm'
          
      - name: Install dependencies
        run: pnpm install --frozen-lockfile
        
      - name: Run tests
        run: pnpm test -- --coverage
        
      - name: Upload coverage
        uses: codecov/codecov-action@v3
        with:
          token: ${{ secrets.CODECOV_TOKEN }}
          fail_ci_if_error: false

  build:
    name: Build
    runs-on: ubuntu-latest
    needs: [lint, typecheck, test]
    steps:
      - uses: actions/checkout@v4
      
      - name: Setup pnpm
        uses: pnpm/action-setup@v2
        with:
          version: 8
          
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'pnpm'
          
      - name: Install dependencies
        run: pnpm install --frozen-lockfile
        
      - name: Build packages
        run: pnpm build:packages
        
      - name: Build apps
        run: pnpm build
        env:
          NEXT_PUBLIC_SUPABASE_URL: ${{ secrets.NEXT_PUBLIC_SUPABASE_URL }}
          NEXT_PUBLIC_SUPABASE_ANON_KEY: ${{ secrets.NEXT_PUBLIC_SUPABASE_ANON_KEY }}
```

Create `.github/workflows/deploy.yml`:

```yaml
name: Deploy

on:
  push:
    branches: [main]

jobs:
  deploy-patient:
    name: Deploy Patient App
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      
      - name: Deploy to Vercel
        uses: amondnet/vercel-action@v25
        with:
          vercel-token: ${{ secrets.VERCEL_TOKEN }}
          vercel-org-id: ${{ secrets.VERCEL_ORG_ID }}
          vercel-project-id: ${{ secrets.VERCEL_PATIENT_PROJECT_ID }}
          vercel-args: '--prod'
          working-directory: apps/patient

  deploy-pharmacy:
    name: Deploy Pharmacy Portal
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      
      - name: Deploy to Vercel
        uses: amondnet/vercel-action@v25
        with:
          vercel-token: ${{ secrets.VERCEL_TOKEN }}
          vercel-org-id: ${{ secrets.VERCEL_ORG_ID }}
          vercel-project-id: ${{ secrets.VERCEL_PHARMACY_PROJECT_ID }}
          vercel-args: '--prod'
          working-directory: apps/pharmacy

  deploy-courier:
    name: Deploy Courier App
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      
      - name: Deploy to Vercel
        uses: amondnet/vercel-action@v25
        with:
          vercel-token: ${{ secrets.VERCEL_TOKEN }}
          vercel-org-id: ${{ secrets.VERCEL_ORG_ID }}
          vercel-project-id: ${{ secrets.VERCEL_COURIER_PROJECT_ID }}
          vercel-args: '--prod'
          working-directory: apps/courier

  migrate-database:
    name: Run Database Migrations
    runs-on: ubuntu-latest
    needs: [deploy-patient, deploy-pharmacy, deploy-courier]
    steps:
      - uses: actions/checkout@v4
      
      - name: Setup Supabase CLI
        uses: supabase/setup-cli@v1
        with:
          version: latest
          
      - name: Run migrations
        run: supabase db push
        env:
          SUPABASE_ACCESS_TOKEN: ${{ secrets.SUPABASE_ACCESS_TOKEN }}
          SUPABASE_PROJECT_ID: ${{ secrets.SUPABASE_PROJECT_ID }}
```

### Step 6: Root Package Scripts

Update root `package.json`:

```json
{
  "name": "dawa",
  "private": true,
  "scripts": {
    "dev": "turbo dev",
    "dev:patient": "turbo dev --filter=patient",
    "dev:pharmacy": "turbo dev --filter=pharmacy",
    "dev:courier": "turbo dev --filter=courier",
    "build": "turbo build",
    "build:packages": "turbo build --filter='./packages/*'",
    "lint": "turbo lint",
    "lint:fix": "turbo lint -- --fix",
    "typecheck": "turbo typecheck",
    "test": "turbo test",
    "test:watch": "turbo test -- --watch",
    "test:coverage": "turbo test -- --coverage",
    "format": "prettier --write \"**/*.{ts,tsx,js,jsx,json,md}\"",
    "format:check": "prettier --check \"**/*.{ts,tsx,js,jsx,json,md}\"",
    "clean": "turbo clean && rm -rf node_modules",
    "prepare": "husky"
  },
  "devDependencies": {
    "@dawa/eslint-config": "workspace:*",
    "eslint": "^8.57.0",
    "husky": "^9.0.0",
    "lint-staged": "^15.2.0",
    "prettier": "^3.2.0",
    "prettier-plugin-tailwindcss": "^0.5.0",
    "turbo": "^1.12.0",
    "typescript": "^5.3.0",
    "vitest": "^1.2.0"
  },
  "packageManager": "pnpm@8.15.0"
}
```

---

## VALIDATION CHECKLIST

### Pre-commit Hook Works
```bash
# Make a bad commit
echo "const x = 1" > test.ts
git add test.ts
git commit -m "bad" # Should fail - message format invalid

git commit -m "test: add test file" # Should pass
```

### CI Pipeline Passes
```bash
# All checks should pass locally before push
pnpm lint
pnpm typecheck
pnpm test
pnpm build
```

### Deployment Works
```bash
# Push to main triggers deploy
git push origin main
# Check Vercel dashboard for deployment status
```

---

## SUCCESS CRITERIA

- [ ] ESLint catches errors with auto-fix
- [ ] Prettier formats all files consistently
- [ ] Pre-commit hook runs lint-staged
- [ ] Commit messages follow conventional format
- [ ] Tests run with coverage reporting
- [ ] CI pipeline passes on all PRs
- [ ] Deployment triggers on main push
- [ ] Database migrations run automatically

---

## PHASE 0 COMPLETE ✅

All foundation prompts are now complete:
- P0.1: Project Init
- P0.2: Supabase Setup
- P0.3: Database Schema
- P0.4: TypeScript Types
- P0.5: Shared Packages
- P0.6: Phone OTP Auth
- P0.7: Environment Config
- P0.8: Development Workflow

---

## NEXT STEP

Proceed to Phase 1 - Patient Web App:
→ `dawa-docs/prompts/phase-1/P1.1-patient-web-app-setup.md`

Reference documentation:
→ `dawa-docs/docs/DAWA_MASTER.md`
→ `dawa-docs/docs/phases/PHASE_1.md`
