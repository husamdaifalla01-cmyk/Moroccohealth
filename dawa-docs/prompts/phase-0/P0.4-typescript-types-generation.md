# P0.4 — TypeScript Types Generation & Domain Modeling

## Prompt ID: P0.4
## Phase: 0 - Foundation
## Estimated Time: 3-4 hours
## Prerequisites: P0.1-P0.3 complete (Monorepo, Supabase, Database Schema)

---

## CONTEXT

You are establishing the type system for DAWA.ma, Morocco's medication delivery platform. Types are the contract between all applications in the monorepo. Every API call, every database query, every component prop flows through these types.

**This is foundational work.** Errors here cascade everywhere. Take time to model the domain correctly.

**Reference**: `@morocco-pharma-delivery-business-logic.md`

---

## OBJECTIVES

1. Generate base types from Supabase schema
2. Create domain-specific type augmentations
3. Build comprehensive enum types for all status fields
4. Implement utility types for API responses
5. Create type guards for runtime validation
6. Export everything from `@dawa/types` package

---

## DOMAIN MODEL OVERVIEW

Before writing code, understand the entity relationships:

```
┌─────────────┐     ┌─────────────┐     ┌─────────────┐
│   PATIENT   │────▶│    ORDER    │◀────│  PHARMACY   │
└─────────────┘     └─────────────┘     └─────────────┘
       │                   │                   │
       │                   │                   │
       ▼                   ▼                   ▼
┌─────────────┐     ┌─────────────┐     ┌─────────────┐
│  ADDRESSES  │     │ ORDER_ITEMS │     │    STAFF    │
└─────────────┘     └─────────────┘     └─────────────┘
                           │                   
                           ▼                   
                    ┌─────────────┐     ┌─────────────┐
                    │ MEDICATIONS │     │   COURIER   │
                    └─────────────┘     └─────────────┘
                           │                   │
                           ▼                   │
                    ┌─────────────┐            │
                    │PRESCRIPTIONS│◀───────────┘
                    └─────────────┘     (delivers)
```

---

## IMPLEMENTATION STEPS

### Step 1: Generate Supabase Types

Run the Supabase CLI to generate base types:

```bash
# In project root
npx supabase gen types typescript --project-id $SUPABASE_PROJECT_ID > packages/types/src/database.types.ts
```

This creates the raw database types. We'll augment these with business logic.

### Step 2: Create Package Structure

```bash
packages/types/
├── src/
│   ├── index.ts              # Main export
│   ├── database.types.ts     # Generated from Supabase
│   ├── enums.ts              # All status enums
│   ├── entities/
│   │   ├── index.ts
│   │   ├── user.ts
│   │   ├── patient.ts
│   │   ├── pharmacy.ts
│   │   ├── courier.ts
│   │   ├── order.ts
│   │   ├── medication.ts
│   │   ├── prescription.ts
│   │   └── address.ts
│   ├── api/
│   │   ├── index.ts
│   │   ├── responses.ts
│   │   ├── requests.ts
│   │   └── errors.ts
│   ├── utils/
│   │   ├── index.ts
│   │   ├── guards.ts
│   │   └── helpers.ts
│   └── constants.ts
├── package.json
└── tsconfig.json
```

### Step 3: Enum Definitions

Create `packages/types/src/enums.ts`:

```typescript
// ============================================================
// DAWA.ma Status Enums
// Single source of truth for all status values
// ============================================================

/**
 * User account status across all user types
 */
export enum UserStatus {
  PENDING_VERIFICATION = 'pending_verification',
  ACTIVE = 'active',
  SUSPENDED = 'suspended',
  DEACTIVATED = 'deactivated',
}

/**
 * User roles in the system
 */
export enum UserRole {
  PATIENT = 'patient',
  PHARMACY_OWNER = 'pharmacy_owner',
  PHARMACY_PHARMACIST = 'pharmacy_pharmacist',
  PHARMACY_TECHNICIAN = 'pharmacy_technician',
  PHARMACY_VIEWER = 'pharmacy_viewer',
  COURIER = 'courier',
  ADMIN = 'admin',
  SUPPORT = 'support',
}

/**
 * Order lifecycle status
 * Critical: This drives the entire order flow
 */
export enum OrderStatus {
  // Initial states
  DRAFT = 'draft',                           // Patient started but not submitted
  PENDING_PHARMACY = 'pending_pharmacy',     // Awaiting pharmacy acceptance
  
  // Pharmacy processing
  PHARMACY_ACCEPTED = 'pharmacy_accepted',   // Pharmacy accepted, preparing
  PHARMACY_REJECTED = 'pharmacy_rejected',   // Pharmacy rejected (out of stock, etc)
  PREPARING = 'preparing',                   // Pharmacy preparing order
  READY_FOR_PICKUP = 'ready_for_pickup',     // Ready for courier
  
  // Delivery states
  COURIER_ASSIGNED = 'courier_assigned',     // Courier accepted pickup
  COURIER_PICKUP = 'courier_pickup',         // Courier at pharmacy
  IN_TRANSIT = 'in_transit',                 // On the way to patient
  ARRIVED = 'arrived',                       // Courier at delivery location
  
  // Final states
  DELIVERED = 'delivered',                   // Successfully delivered
  CANCELLED = 'cancelled',                   // Cancelled by any party
  FAILED = 'failed',                         // Delivery failed
  RETURNED = 'returned',                     // Returned to pharmacy
}

/**
 * Prescription verification status
 */
export enum PrescriptionStatus {
  PENDING_UPLOAD = 'pending_upload',
  PENDING_VERIFICATION = 'pending_verification',
  VERIFIED = 'verified',
  REJECTED = 'rejected',
  EXPIRED = 'expired',
}

/**
 * Pharmacy verification status (regulatory compliance)
 */
export enum PharmacyStatus {
  PENDING_DOCUMENTS = 'pending_documents',
  PENDING_VERIFICATION = 'pending_verification',
  VERIFIED = 'verified',
  SUSPENDED = 'suspended',
  REJECTED = 'rejected',
}

/**
 * Courier verification status
 */
export enum CourierStatus {
  PENDING_DOCUMENTS = 'pending_documents',
  PENDING_VERIFICATION = 'pending_verification',
  ACTIVE = 'active',
  OFFLINE = 'offline',
  SUSPENDED = 'suspended',
}

/**
 * Courier availability for orders
 */
export enum CourierAvailability {
  AVAILABLE = 'available',
  BUSY = 'busy',           // Currently on delivery
  OFFLINE = 'offline',     // Not accepting orders
  ON_BREAK = 'on_break',
}

/**
 * Payment status
 */
export enum PaymentStatus {
  PENDING = 'pending',
  PROCESSING = 'processing',
  COMPLETED = 'completed',
  FAILED = 'failed',
  REFUNDED = 'refunded',
  PARTIALLY_REFUNDED = 'partially_refunded',
}

/**
 * Payment methods available in Morocco
 */
export enum PaymentMethod {
  CASH_ON_DELIVERY = 'cash_on_delivery',     // Most common in Morocco
  CARD = 'card',                              // CMI integration
  INSURANCE = 'insurance',                    // CNSS/CNOPS/Private
  WALLET = 'wallet',                          // Future: DAWA wallet
}

/**
 * Medication categories
 */
export enum MedicationCategory {
  OTC = 'otc',                    // Over the counter
  PRESCRIPTION = 'prescription', // Requires valid prescription
  CONTROLLED = 'controlled',     // Restricted substances (not deliverable)
  REFRIGERATED = 'refrigerated', // Cold chain required
}

/**
 * Chat session types
 */
export enum ChatSessionType {
  ORDER_SUPPORT = 'order_support',
  MEDICATION_QUESTION = 'medication_question',
  GENERAL = 'general',
  COMPLAINT = 'complaint',
}

/**
 * Chat session status
 */
export enum ChatSessionStatus {
  ACTIVE = 'active',
  PENDING = 'pending',
  RESOLVED = 'resolved',
  ARCHIVED = 'archived',
}

/**
 * Notification types
 */
export enum NotificationType {
  ORDER_STATUS = 'order_status',
  PRESCRIPTION_STATUS = 'prescription_status',
  CHAT_MESSAGE = 'chat_message',
  PROMOTION = 'promotion',
  SYSTEM = 'system',
}

/**
 * Address types
 */
export enum AddressType {
  HOME = 'home',
  WORK = 'work',
  OTHER = 'other',
}

/**
 * Delivery time preferences
 */
export enum DeliveryTimePreference {
  ASAP = 'asap',
  MORNING = 'morning',       // 8h-12h
  AFTERNOON = 'afternoon',   // 12h-17h
  EVENING = 'evening',       // 17h-21h
  SCHEDULED = 'scheduled',   // Specific time slot
}

/**
 * Vehicle types for couriers
 */
export enum VehicleType {
  MOTORCYCLE = 'motorcycle',
  CAR = 'car',
  BICYCLE = 'bicycle',
  SCOOTER = 'scooter',
}

/**
 * Commission tiers for pharmacies
 */
export enum CommissionTier {
  STARTER = 'starter',     // 12%
  GROWTH = 'growth',       // 10%
  PREMIUM = 'premium',     // 8%
  ENTERPRISE = 'enterprise', // 6%
}

// ============================================================
// Enum Helper Maps (for UI display)
// ============================================================

export const ORDER_STATUS_LABELS: Record<OrderStatus, string> = {
  [OrderStatus.DRAFT]: 'Brouillon',
  [OrderStatus.PENDING_PHARMACY]: 'En attente de la pharmacie',
  [OrderStatus.PHARMACY_ACCEPTED]: 'Acceptée',
  [OrderStatus.PHARMACY_REJECTED]: 'Refusée',
  [OrderStatus.PREPARING]: 'En préparation',
  [OrderStatus.READY_FOR_PICKUP]: 'Prête',
  [OrderStatus.COURIER_ASSIGNED]: 'Livreur assigné',
  [OrderStatus.COURIER_PICKUP]: 'Récupération',
  [OrderStatus.IN_TRANSIT]: 'En livraison',
  [OrderStatus.ARRIVED]: 'Arrivé',
  [OrderStatus.DELIVERED]: 'Livrée',
  [OrderStatus.CANCELLED]: 'Annulée',
  [OrderStatus.FAILED]: 'Échec',
  [OrderStatus.RETURNED]: 'Retournée',
};

export const ORDER_STATUS_COLORS: Record<OrderStatus, string> = {
  [OrderStatus.DRAFT]: 'gray',
  [OrderStatus.PENDING_PHARMACY]: 'amber',
  [OrderStatus.PHARMACY_ACCEPTED]: 'blue',
  [OrderStatus.PHARMACY_REJECTED]: 'red',
  [OrderStatus.PREPARING]: 'blue',
  [OrderStatus.READY_FOR_PICKUP]: 'indigo',
  [OrderStatus.COURIER_ASSIGNED]: 'purple',
  [OrderStatus.COURIER_PICKUP]: 'purple',
  [OrderStatus.IN_TRANSIT]: 'violet',
  [OrderStatus.ARRIVED]: 'cyan',
  [OrderStatus.DELIVERED]: 'green',
  [OrderStatus.CANCELLED]: 'gray',
  [OrderStatus.FAILED]: 'red',
  [OrderStatus.RETURNED]: 'orange',
};

export const PAYMENT_METHOD_LABELS: Record<PaymentMethod, string> = {
  [PaymentMethod.CASH_ON_DELIVERY]: 'Paiement à la livraison',
  [PaymentMethod.CARD]: 'Carte bancaire',
  [PaymentMethod.INSURANCE]: 'Assurance maladie',
  [PaymentMethod.WALLET]: 'Portefeuille DAWA',
};

export const PRESCRIPTION_STATUS_LABELS: Record<PrescriptionStatus, string> = {
  [PrescriptionStatus.PENDING_UPLOAD]: 'En attente d\'upload',
  [PrescriptionStatus.PENDING_VERIFICATION]: 'En vérification',
  [PrescriptionStatus.VERIFIED]: 'Vérifiée',
  [PrescriptionStatus.REJECTED]: 'Rejetée',
  [PrescriptionStatus.EXPIRED]: 'Expirée',
};
```

### Step 4: Core Entity Types

Create `packages/types/src/entities/user.ts`:

```typescript
// ============================================================
// User Base Types
// Foundation for all user-type entities
// ============================================================

import { UserStatus, UserRole } from '../enums';

/**
 * Base user interface - all users share these fields
 */
export interface UserBase {
  id: string;
  phone: string;                    // Primary identifier in Morocco
  email?: string;
  status: UserStatus;
  role: UserRole;
  created_at: string;
  updated_at: string;
  last_login_at?: string;
}

/**
 * User profile information
 */
export interface UserProfile {
  first_name?: string;
  last_name?: string;
  first_name_display?: string;      // For privacy (shows "Mohammed A.")
  avatar_url?: string;
  language: 'fr' | 'ar' | 'en';     // French default, Arabic support
  timezone: string;                  // Default: 'Africa/Casablanca'
}

/**
 * CNDP Consent record (Morocco data protection)
 */
export interface UserConsent {
  user_id: string;
  consent_type: 'data_processing' | 'marketing' | 'location' | 'medical_data';
  granted: boolean;
  granted_at?: string;
  revoked_at?: string;
  ip_address?: string;
  user_agent?: string;
}

/**
 * Authentication session
 */
export interface AuthSession {
  user_id: string;
  access_token: string;
  refresh_token: string;
  expires_at: string;
  device_id?: string;
  ip_address?: string;
}

/**
 * OTP verification record
 */
export interface OTPRecord {
  id: string;
  phone: string;
  code_hash: string;
  attempts: number;
  expires_at: string;
  verified_at?: string;
  created_at: string;
}
```

Create `packages/types/src/entities/patient.ts`:

```typescript
// ============================================================
// Patient Entity Types
// ============================================================

import { UserBase, UserProfile } from './user';
import { Address } from './address';

/**
 * Patient - End user ordering medications
 */
export interface Patient extends UserBase, UserProfile {
  // Medical information (encrypted at rest)
  date_of_birth?: string;
  blood_type?: string;
  allergies?: string[];
  chronic_conditions?: string[];
  
  // Insurance information
  insurance_provider?: string;
  insurance_number_encrypted?: string;
  insurance_verified?: boolean;
  
  // Preferences
  default_address_id?: string;
  default_payment_method?: string;
  notification_preferences: NotificationPreferences;
  
  // Statistics
  total_orders: number;
  total_spent: number;
  
  // Relations (populated on fetch)
  addresses?: Address[];
}

/**
 * Patient notification preferences
 */
export interface NotificationPreferences {
  push_enabled: boolean;
  sms_enabled: boolean;
  email_enabled: boolean;
  order_updates: boolean;
  promotions: boolean;
  medication_reminders: boolean;
}

/**
 * Patient for creation (without system fields)
 */
export type PatientCreate = Pick<Patient, 'phone'> & Partial<Pick<Patient, 
  | 'email'
  | 'first_name'
  | 'last_name'
  | 'date_of_birth'
  | 'language'
>>;

/**
 * Patient update payload
 */
export type PatientUpdate = Partial<Pick<Patient,
  | 'first_name'
  | 'last_name'
  | 'email'
  | 'date_of_birth'
  | 'blood_type'
  | 'allergies'
  | 'chronic_conditions'
  | 'default_address_id'
  | 'default_payment_method'
  | 'notification_preferences'
  | 'avatar_url'
  | 'language'
>>;

/**
 * Patient summary for lists/cards
 */
export type PatientSummary = Pick<Patient,
  | 'id'
  | 'phone'
  | 'first_name_display'
  | 'avatar_url'
  | 'total_orders'
>;
```

Create `packages/types/src/entities/pharmacy.ts`:

```typescript
// ============================================================
// Pharmacy Entity Types
// ============================================================

import { PharmacyStatus, CommissionTier } from '../enums';

/**
 * Pharmacy - Business entity
 */
export interface Pharmacy {
  id: string;
  
  // Business information
  name: string;
  legal_name: string;
  license_number: string;           // Required by Morocco law
  tax_id?: string;                  // ICE number
  
  // Contact
  phone_primary: string;
  phone_secondary?: string;
  email: string;
  website?: string;
  
  // Location
  address_line_1: string;
  address_line_2?: string;
  city: string;
  region: string;
  postal_code?: string;
  latitude: number;
  longitude: number;
  
  // Status
  status: PharmacyStatus;
  is_open: boolean;
  is_accepting_orders: boolean;
  
  // Operations
  operating_hours: OperatingHours;
  delivery_radius_km: number;
  avg_preparation_time_minutes: number;
  
  // Financial
  commission_tier: CommissionTier;
  commission_rate: number;          // Actual rate (may differ from tier)
  bank_account_encrypted?: string;
  
  // Branding
  logo_url?: string;
  cover_image_url?: string;
  description?: string;
  
  // Statistics
  rating: number;
  review_count: number;
  total_orders: number;
  monthly_order_count: number;
  
  // Timestamps
  created_at: string;
  updated_at: string;
  verified_at?: string;
}

/**
 * Weekly operating hours
 */
export interface OperatingHours {
  mon: DayHours;
  tue: DayHours;
  wed: DayHours;
  thu: DayHours;
  fri: DayHours;
  sat: DayHours;
  sun: DayHours;
}

export interface DayHours {
  open: string;      // "08:00"
  close: string;     // "20:00"
  is_closed: boolean;
}

/**
 * Pharmacy staff member
 */
export interface PharmacyStaff {
  id: string;
  pharmacy_id: string;
  user_id: string;
  email: string;
  first_name: string;
  last_name: string;
  role: 'owner' | 'pharmacist' | 'technician' | 'viewer';
  license_number?: string;          // Required for pharmacists
  is_active: boolean;
  invited_at: string;
  joined_at?: string;
  last_login_at?: string;
  created_at: string;
}

/**
 * Pharmacy for listing (minimal data)
 */
export type PharmacySummary = Pick<Pharmacy,
  | 'id'
  | 'name'
  | 'logo_url'
  | 'rating'
  | 'review_count'
  | 'is_open'
  | 'delivery_radius_km'
  | 'avg_preparation_time_minutes'
>;

/**
 * Pharmacy with distance (for search results)
 */
export interface PharmacyWithDistance extends PharmacySummary {
  distance_km: number;
  estimated_delivery_minutes: number;
}

/**
 * Pharmacy creation payload
 */
export type PharmacyCreate = Pick<Pharmacy,
  | 'name'
  | 'legal_name'
  | 'license_number'
  | 'phone_primary'
  | 'email'
  | 'address_line_1'
  | 'city'
  | 'region'
  | 'latitude'
  | 'longitude'
> & Partial<Pick<Pharmacy,
  | 'phone_secondary'
  | 'website'
  | 'address_line_2'
  | 'postal_code'
  | 'tax_id'
  | 'description'
>>;

/**
 * Pharmacy update payload
 */
export type PharmacyUpdate = Partial<Pick<Pharmacy,
  | 'name'
  | 'phone_primary'
  | 'phone_secondary'
  | 'email'
  | 'website'
  | 'address_line_1'
  | 'address_line_2'
  | 'city'
  | 'region'
  | 'postal_code'
  | 'operating_hours'
  | 'delivery_radius_km'
  | 'is_accepting_orders'
  | 'logo_url'
  | 'cover_image_url'
  | 'description'
>>;
```

Create `packages/types/src/entities/order.ts`:

```typescript
// ============================================================
// Order Entity Types
// The core transaction of the platform
// ============================================================

import {
  OrderStatus,
  PaymentStatus,
  PaymentMethod,
  DeliveryTimePreference,
} from '../enums';
import { PatientSummary } from './patient';
import { PharmacySummary } from './pharmacy';
import { CourierSummary } from './courier';
import { Address } from './address';

/**
 * Order - Core transaction entity
 */
export interface Order {
  id: string;
  order_number: string;             // Human readable: "DWA-20240115-A1B2"
  
  // Parties
  patient_id: string;
  pharmacy_id: string;
  courier_id?: string;
  
  // Status tracking
  status: OrderStatus;
  status_history: OrderStatusHistory[];
  
  // Delivery
  delivery_address_id: string;
  delivery_time_preference: DeliveryTimePreference;
  scheduled_delivery_at?: string;
  estimated_delivery_at?: string;
  actual_delivery_at?: string;
  delivery_instructions?: string;
  
  // Prescription (if required)
  prescription_id?: string;
  requires_prescription: boolean;
  
  // Financial
  subtotal: number;                 // Medication total
  delivery_fee: number;
  service_fee: number;
  discount_amount: number;
  total: number;
  
  payment_method: PaymentMethod;
  payment_status: PaymentStatus;
  paid_at?: string;
  
  // Commission (pharmacy side)
  commission_rate: number;
  commission_amount: number;
  pharmacy_payout: number;
  
  // Tracking
  courier_location_history?: CourierLocation[];
  
  // Notes
  patient_notes?: string;
  pharmacy_notes?: string;
  courier_notes?: string;
  cancellation_reason?: string;
  
  // Ratings
  patient_rating?: number;
  patient_review?: string;
  pharmacy_rating_for_patient?: number;
  
  // Timestamps
  created_at: string;
  updated_at: string;
  accepted_at?: string;
  ready_at?: string;
  picked_up_at?: string;
  delivered_at?: string;
  cancelled_at?: string;
  
  // Relations (populated on fetch)
  patient?: PatientSummary;
  pharmacy?: PharmacySummary;
  courier?: CourierSummary;
  items?: OrderItem[];
  delivery_address?: Address;
}

/**
 * Order status change record
 */
export interface OrderStatusHistory {
  status: OrderStatus;
  changed_at: string;
  changed_by?: string;
  notes?: string;
}

/**
 * Courier location during delivery
 */
export interface CourierLocation {
  latitude: number;
  longitude: number;
  timestamp: string;
  accuracy?: number;
}

/**
 * Order line item
 */
export interface OrderItem {
  id: string;
  order_id: string;
  medication_id: string;
  
  // Product info (snapshot at order time)
  medication_name: string;
  medication_sku?: string;
  
  quantity: number;
  unit_price: number;
  total_price: number;
  
  // Prescription linkage
  requires_prescription: boolean;
  prescription_verified: boolean;
  
  // Substitution
  is_substitution: boolean;
  original_medication_id?: string;
  substitution_reason?: string;
  
  created_at: string;
}

/**
 * Order creation payload
 */
export interface OrderCreate {
  pharmacy_id: string;
  delivery_address_id: string;
  delivery_time_preference: DeliveryTimePreference;
  scheduled_delivery_at?: string;
  payment_method: PaymentMethod;
  items: OrderItemCreate[];
  prescription_id?: string;
  patient_notes?: string;
  promo_code?: string;
}

export interface OrderItemCreate {
  medication_id: string;
  quantity: number;
}

/**
 * Order for listing (minimal data)
 */
export type OrderSummary = Pick<Order,
  | 'id'
  | 'order_number'
  | 'status'
  | 'total'
  | 'payment_method'
  | 'payment_status'
  | 'created_at'
  | 'estimated_delivery_at'
> & {
  pharmacy_name: string;
  item_count: number;
};

/**
 * Order with full relations
 */
export interface OrderDetailed extends Order {
  patient: PatientSummary;
  pharmacy: PharmacySummary;
  courier?: CourierSummary;
  items: OrderItem[];
  delivery_address: Address;
}

/**
 * Real-time order tracking data
 */
export interface OrderTracking {
  order_id: string;
  status: OrderStatus;
  courier_location?: {
    latitude: number;
    longitude: number;
    updated_at: string;
  };
  estimated_arrival_minutes?: number;
  pharmacy_location: {
    latitude: number;
    longitude: number;
  };
  delivery_location: {
    latitude: number;
    longitude: number;
  };
}
```

### Step 5: API Response Types

Create `packages/types/src/api/responses.ts`:

```typescript
// ============================================================
// API Response Types
// Standardized response wrappers
// ============================================================

/**
 * Base API response wrapper
 */
export interface ApiResponse<T> {
  success: boolean;
  data: T;
  message?: string;
  timestamp: string;
}

/**
 * Paginated response
 */
export interface PaginatedResponse<T> {
  success: boolean;
  data: T[];
  pagination: {
    page: number;
    page_size: number;
    total_items: number;
    total_pages: number;
    has_next: boolean;
    has_previous: boolean;
  };
  timestamp: string;
}

/**
 * Error response
 */
export interface ApiError {
  success: false;
  error: {
    code: string;
    message: string;
    details?: Record<string, string[]>;
    stack?: string;       // Only in development
  };
  timestamp: string;
}

/**
 * Validation error details
 */
export interface ValidationError {
  field: string;
  message: string;
  code: string;
}

/**
 * Common error codes
 */
export enum ErrorCode {
  // Authentication
  INVALID_CREDENTIALS = 'INVALID_CREDENTIALS',
  TOKEN_EXPIRED = 'TOKEN_EXPIRED',
  UNAUTHORIZED = 'UNAUTHORIZED',
  FORBIDDEN = 'FORBIDDEN',
  
  // Validation
  VALIDATION_ERROR = 'VALIDATION_ERROR',
  INVALID_INPUT = 'INVALID_INPUT',
  MISSING_REQUIRED_FIELD = 'MISSING_REQUIRED_FIELD',
  
  // Resources
  NOT_FOUND = 'NOT_FOUND',
  ALREADY_EXISTS = 'ALREADY_EXISTS',
  CONFLICT = 'CONFLICT',
  
  // Business logic
  ORDER_CANNOT_BE_MODIFIED = 'ORDER_CANNOT_BE_MODIFIED',
  PRESCRIPTION_REQUIRED = 'PRESCRIPTION_REQUIRED',
  PHARMACY_CLOSED = 'PHARMACY_CLOSED',
  OUT_OF_DELIVERY_ZONE = 'OUT_OF_DELIVERY_ZONE',
  MEDICATION_OUT_OF_STOCK = 'MEDICATION_OUT_OF_STOCK',
  
  // Rate limiting
  RATE_LIMITED = 'RATE_LIMITED',
  TOO_MANY_OTP_REQUESTS = 'TOO_MANY_OTP_REQUESTS',
  
  // Server
  INTERNAL_ERROR = 'INTERNAL_ERROR',
  SERVICE_UNAVAILABLE = 'SERVICE_UNAVAILABLE',
}

/**
 * Cursor-based pagination params
 */
export interface CursorPaginationParams {
  cursor?: string;
  limit?: number;
  direction?: 'forward' | 'backward';
}

/**
 * Cursor-based pagination response
 */
export interface CursorPaginatedResponse<T> {
  success: boolean;
  data: T[];
  pagination: {
    next_cursor?: string;
    previous_cursor?: string;
    has_more: boolean;
  };
  timestamp: string;
}
```

### Step 6: Type Guards

Create `packages/types/src/utils/guards.ts`:

```typescript
// ============================================================
// Type Guards for Runtime Validation
// ============================================================

import { OrderStatus, PaymentMethod, UserRole } from '../enums';
import type { Order, Patient, Pharmacy } from '../entities';

/**
 * Check if value is a valid OrderStatus
 */
export function isOrderStatus(value: unknown): value is OrderStatus {
  return Object.values(OrderStatus).includes(value as OrderStatus);
}

/**
 * Check if value is a valid PaymentMethod
 */
export function isPaymentMethod(value: unknown): value is PaymentMethod {
  return Object.values(PaymentMethod).includes(value as PaymentMethod);
}

/**
 * Check if value is a valid UserRole
 */
export function isUserRole(value: unknown): value is UserRole {
  return Object.values(UserRole).includes(value as UserRole);
}

/**
 * Check if order can be cancelled
 */
export function isOrderCancellable(order: Order): boolean {
  const nonCancellableStatuses: OrderStatus[] = [
    OrderStatus.IN_TRANSIT,
    OrderStatus.ARRIVED,
    OrderStatus.DELIVERED,
    OrderStatus.CANCELLED,
    OrderStatus.FAILED,
    OrderStatus.RETURNED,
  ];
  return !nonCancellableStatuses.includes(order.status);
}

/**
 * Check if order is in an active state
 */
export function isOrderActive(order: Order): boolean {
  const activeStatuses: OrderStatus[] = [
    OrderStatus.PENDING_PHARMACY,
    OrderStatus.PHARMACY_ACCEPTED,
    OrderStatus.PREPARING,
    OrderStatus.READY_FOR_PICKUP,
    OrderStatus.COURIER_ASSIGNED,
    OrderStatus.COURIER_PICKUP,
    OrderStatus.IN_TRANSIT,
    OrderStatus.ARRIVED,
  ];
  return activeStatuses.includes(order.status);
}

/**
 * Check if order requires prescription
 */
export function orderRequiresPrescription(order: Order): boolean {
  return order.requires_prescription && !order.prescription_id;
}

/**
 * Check if pharmacy is currently open
 */
export function isPharmacyOpen(pharmacy: Pharmacy): boolean {
  if (!pharmacy.is_open || !pharmacy.is_accepting_orders) {
    return false;
  }
  
  const now = new Date();
  const dayKey = ['sun', 'mon', 'tue', 'wed', 'thu', 'fri', 'sat'][now.getDay()] as keyof typeof pharmacy.operating_hours;
  const todayHours = pharmacy.operating_hours[dayKey];
  
  if (todayHours.is_closed) {
    return false;
  }
  
  const currentTime = `${now.getHours().toString().padStart(2, '0')}:${now.getMinutes().toString().padStart(2, '0')}`;
  return currentTime >= todayHours.open && currentTime <= todayHours.close;
}

/**
 * Validate Moroccan phone number
 */
export function isValidMoroccanPhone(phone: string): boolean {
  // Morocco: +212 followed by 6 or 7, then 8 digits
  const moroccanPhoneRegex = /^\+212[67]\d{8}$/;
  return moroccanPhoneRegex.test(phone);
}

/**
 * Type assertion helper
 */
export function assertNever(x: never): never {
  throw new Error(`Unexpected value: ${x}`);
}
```

### Step 7: Main Export

Create `packages/types/src/index.ts`:

```typescript
// ============================================================
// @dawa/types - Main Export
// ============================================================

// Enums
export * from './enums';

// Entities
export * from './entities/user';
export * from './entities/patient';
export * from './entities/pharmacy';
export * from './entities/courier';
export * from './entities/order';
export * from './entities/medication';
export * from './entities/prescription';
export * from './entities/address';

// API Types
export * from './api/responses';
export * from './api/requests';
export * from './api/errors';

// Utils
export * from './utils/guards';
export * from './utils/helpers';

// Constants
export * from './constants';

// Database types (generated)
export type { Database } from './database.types';
```

### Step 8: Package Configuration

Create `packages/types/package.json`:

```json
{
  "name": "@dawa/types",
  "version": "1.0.0",
  "private": true,
  "main": "./src/index.ts",
  "types": "./src/index.ts",
  "exports": {
    ".": "./src/index.ts",
    "./enums": "./src/enums.ts",
    "./entities/*": "./src/entities/*.ts",
    "./api/*": "./src/api/*.ts"
  },
  "scripts": {
    "generate": "supabase gen types typescript --project-id $SUPABASE_PROJECT_ID > src/database.types.ts",
    "typecheck": "tsc --noEmit"
  },
  "devDependencies": {
    "typescript": "^5.3.0"
  }
}
```

---

## VALIDATION CHECKPOINTS

### Checkpoint 1: Types Compile Without Errors
```bash
cd packages/types && pnpm typecheck
```

### Checkpoint 2: Types Import Correctly
```typescript
// In any app
import { Order, OrderStatus, isOrderCancellable } from '@dawa/types';
```

### Checkpoint 3: Enums Used Consistently
```typescript
// All status fields should use enum values, not strings
order.status = OrderStatus.PREPARING; // ✓
order.status = 'preparing';            // ✗ TypeScript error
```

---

## SUCCESS CRITERIA

- [ ] All enums defined with French labels
- [ ] Entity types cover all database tables
- [ ] API response types standardized
- [ ] Type guards for runtime validation
- [ ] Package exports configured correctly
- [ ] Zero TypeScript errors

---

## NEXT STEP

After validation passes, proceed to:
→ `dawa-docs/prompts/phase-0/P0.5-shared-packages-setup.md`

Reference documentation:
→ `dawa-docs/docs/DAWA_MASTER.md`
