# P0.2 — Supabase Setup (V100)

## Prompt ID: P0.2
## Phase: 0 - Infrastructure Setup
## Estimated Time: 3-4 hours
## Prerequisites: P0.1 complete

---

## OVERVIEW

Configure Supabase as the backend-as-a-service for DAWA, including authentication, database, storage, and edge functions.

## WORKSPACE PATHS

> **NOTE**: Documentation lives in `dawa-docs/`, app code in `dawa-ma/`.
> All "Next Step" paths are from workspace root.

---

## SUPABASE PROJECT SETUP

### 1. Create Supabase Project

1. Go to [supabase.com](https://supabase.com) and create new project
2. Select region: **eu-west-3 (Paris)** - closest to Morocco
3. Generate strong database password (save it!)
4. Wait for project to provision (~2 minutes)

### 2. Get Project Credentials

From Project Settings → API:
- **Project URL**: `https://[project-ref].supabase.co`
- **Anon Key**: Public key for client-side
- **Service Role Key**: Server-side only (never expose!)

### 3. Environment Variables

Create `.env.local` in `dawa-ma/apps/patient/`:

```env
# Supabase
NEXT_PUBLIC_SUPABASE_URL=https://[YOUR_PROJECT_REF].supabase.co
NEXT_PUBLIC_SUPABASE_ANON_KEY=[YOUR_ANON_KEY]
SUPABASE_SERVICE_ROLE_KEY=[YOUR_SERVICE_KEY]

# App
NEXT_PUBLIC_APP_URL=http://localhost:3000
```

---

## SUPABASE CLIENT CONFIGURATION

### Server-Side Client (SSR)

```typescript
// dawa-ma/apps/patient/src/lib/supabase/server.ts

import { createServerClient, type CookieOptions } from '@supabase/ssr';
import { cookies } from 'next/headers';
import { Database } from '@/types/database.types';

export function createSupabaseServerClient() {
  const cookieStore = cookies();

  return createServerClient<Database>(
    process.env.NEXT_PUBLIC_SUPABASE_URL!,
    process.env.NEXT_PUBLIC_SUPABASE_ANON_KEY!,
    {
      cookies: {
        get(name: string) {
          return cookieStore.get(name)?.value;
        },
        set(name: string, value: string, options: CookieOptions) {
          try {
            cookieStore.set({ name, value, ...options });
          } catch (error) {
            // Handle in middleware
          }
        },
        remove(name: string, options: CookieOptions) {
          try {
            cookieStore.set({ name, value: '', ...options });
          } catch (error) {
            // Handle in middleware
          }
        },
      },
    }
  );
}
```

### Client-Side Client (Browser)

```typescript
// dawa-ma/apps/patient/src/lib/supabase/client.ts

import { createBrowserClient } from '@supabase/ssr';
import { Database } from '@/types/database.types';

let client: ReturnType<typeof createBrowserClient<Database>> | null = null;

export function getSupabaseClient() {
  if (client) return client;

  client = createBrowserClient<Database>(
    process.env.NEXT_PUBLIC_SUPABASE_URL!,
    process.env.NEXT_PUBLIC_SUPABASE_ANON_KEY!
  );

  return client;
}
```

### Middleware for Auth

```typescript
// dawa-ma/apps/patient/src/middleware.ts

import { createServerClient, type CookieOptions } from '@supabase/ssr';
import { NextResponse, type NextRequest } from 'next/server';

export async function middleware(request: NextRequest) {
  let response = NextResponse.next({
    request: { headers: request.headers },
  });

  const supabase = createServerClient(
    process.env.NEXT_PUBLIC_SUPABASE_URL!,
    process.env.NEXT_PUBLIC_SUPABASE_ANON_KEY!,
    {
      cookies: {
        get(name: string) {
          return request.cookies.get(name)?.value;
        },
        set(name: string, value: string, options: CookieOptions) {
          request.cookies.set({ name, value, ...options });
          response = NextResponse.next({
            request: { headers: request.headers },
          });
          response.cookies.set({ name, value, ...options });
        },
        remove(name: string, options: CookieOptions) {
          request.cookies.set({ name, value: '', ...options });
          response = NextResponse.next({
            request: { headers: request.headers },
          });
          response.cookies.set({ name, value: '', ...options });
        },
      },
    }
  );

  // Refresh session if exists
  await supabase.auth.getSession();

  return response;
}

export const config = {
  matcher: ['/((?!_next/static|_next/image|favicon.ico|.*\\..*).*)'],
};
```

---

## SUPABASE CLI SETUP

### Install CLI

```bash
# In dawa-ma/
pnpm add -D supabase

# Initialize
npx supabase init
```

### Link to Project

```bash
npx supabase login
npx supabase link --project-ref [YOUR_PROJECT_REF]
```

### Local Development

```bash
# Start local Supabase (requires Docker)
npx supabase start

# Stop when done
npx supabase stop
```

---

## STORAGE BUCKETS

Create storage buckets for prescription images and pharmacy logos:

```sql
-- Run in Supabase SQL Editor

-- Prescriptions bucket (private)
INSERT INTO storage.buckets (id, name, public, file_size_limit, allowed_mime_types)
VALUES (
  'prescriptions',
  'prescriptions',
  false,
  5242880,  -- 5MB limit
  ARRAY['image/jpeg', 'image/png', 'image/webp', 'application/pdf']
);

-- Pharmacy assets (public)
INSERT INTO storage.buckets (id, name, public, file_size_limit, allowed_mime_types)
VALUES (
  'pharmacy-assets',
  'pharmacy-assets',
  true,
  2097152,  -- 2MB limit
  ARRAY['image/jpeg', 'image/png', 'image/webp', 'image/svg+xml']
);
```

### Storage RLS Policies

```sql
-- Prescriptions: Users can only access their own
CREATE POLICY "Users can upload prescriptions"
ON storage.objects FOR INSERT
WITH CHECK (
  bucket_id = 'prescriptions' 
  AND auth.uid()::text = (storage.foldername(name))[1]
);

CREATE POLICY "Users can view own prescriptions"
ON storage.objects FOR SELECT
USING (
  bucket_id = 'prescriptions' 
  AND auth.uid()::text = (storage.foldername(name))[1]
);

-- Pharmacy assets: Public read, authenticated pharmacy write
CREATE POLICY "Anyone can view pharmacy assets"
ON storage.objects FOR SELECT
USING (bucket_id = 'pharmacy-assets');

CREATE POLICY "Pharmacies can upload assets"
ON storage.objects FOR INSERT
WITH CHECK (
  bucket_id = 'pharmacy-assets'
  AND EXISTS (
    SELECT 1 FROM pharmacy_staff 
    WHERE user_id = auth.uid() 
    AND pharmacy_id::text = (storage.foldername(name))[1]
  )
);
```

---

## REALTIME CONFIGURATION

Enable Realtime for key tables:

```sql
-- Enable realtime for orders (pharmacy queue)
ALTER PUBLICATION supabase_realtime ADD TABLE orders;

-- Enable realtime for notifications
ALTER PUBLICATION supabase_realtime ADD TABLE notifications;

-- Enable realtime for messages
ALTER PUBLICATION supabase_realtime ADD TABLE messages;
```

---

## TROUBLESHOOTING

| Issue | Solution |
|-------|----------|
| Middleware not running | Ensure matcher config is correct |
| Cookies not persisting | Check @supabase/ssr version compatibility |
| Types not generating | Run `npx supabase gen types typescript` |
| Realtime not working | Check table is in publication |

---

## SUCCESS CRITERIA

- [ ] Supabase project created in eu-west-3 region
- [ ] Environment variables configured
- [ ] Server and client Supabase clients created
- [ ] Middleware refreshing sessions
- [ ] Supabase CLI linked to project
- [ ] Storage buckets created with RLS policies
- [ ] Realtime enabled for orders, notifications, messages

---

## NEXT STEP

After validation passes, proceed to:
→ `dawa-docs/prompts/phase-0/P0.3-database-schema.md`

Reference documentation:
→ `dawa-docs/docs/DAWA_MASTER.md`
→ `dawa-docs/docs/phases/PHASE_0.md`
